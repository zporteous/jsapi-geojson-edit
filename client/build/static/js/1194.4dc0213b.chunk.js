"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[1194],{45028:function(e,t,n){n.d(t,{C:function(){return P},b:function(){return R}});var r,i,a,o,s,u,l,c,d=n(30168),h=n(71011),f=n(33280),p=n(94951),v=n(48655),g=n(16574),m=n(137),y=n(15226),_=n(26461),T=n(116),x=n(82552),S=n(82999),w=n(95276),O=n(98634),C=n(64201),b=n(68401),A=n(4760);function R(e){var t=new C.kG,n=e.output===h.H.Depth,R=e.hasMultipassTerrain&&(e.output===h.H.Color||e.output===h.H.Alpha);(0,x.S)(t,e),t.include(p.w,{hasModelTransformation:!1,linearDepth:n}),t.include(v.c,e),t.attributes.add(A.T.POSITION,"vec3"),t.varyings.add("vpos","vec3"),R&&t.varyings.add("depth","float");var P=t.vertex,E=t.fragment;return n&&(t.include(g.F,e),P.uniforms.add(new S.A("nearFar",(function(e,t){return t.camera.nearFar}))),t.varyings.add("linearDepth","float")),P.code.add((0,O.H)(r||(r=(0,d.Z)(["\n    void main(void) {\n      vpos = position;\n      forwardNormalizedVertexColor();\n      ","\n      gl_Position = ","\n    }\n  "])),R?"depth = (view * vec4(vpos, 1.0)).z;":"",n?(0,O.H)(i||(i=(0,d.Z)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,O.H)(a||(a=(0,d.Z)(["transformPosition(proj, view, vpos);"]))))),t.include(f.f5,e),R&&t.include(y.l,e),E.include(T.Y),E.uniforms.add(new w.N("eColor",(function(e){return e.color}))),e.output===h.H.Highlight&&t.include(m.bA),E.code.add((0,O.H)(o||(o=(0,d.Z)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n    vec4 fColor = ","\n\n    if (fColor.a < ",") {\n      discard;\n    }\n\n    ","\n\n    ","\n    ",";\n    ",";\n  }\n  "])),R?"terrainDepthTest(gl_FragCoord, depth);":"",e.hasVertexColors?"vColor * eColor;":"eColor;",O.H.float(_.b),e.output===h.H.Alpha?(0,O.H)(s||(s=(0,d.Z)(["gl_FragColor = vec4(fColor.a);"]))):"",e.output===h.H.Color?(0,O.H)(u||(u=(0,d.Z)(["gl_FragColor = highlightSlice(fColor, vpos); ",""])),e.transparencyPassType===b.Am.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""):"",e.output===h.H.Highlight?(0,O.H)(l||(l=(0,d.Z)(["outputHighlight();"]))):"",e.output===h.H.Depth?(0,O.H)(c||(c=(0,d.Z)(["outputDepth(linearDepth);"]))):"")),t}var P=Object.freeze(Object.defineProperty({__proto__:null,build:R},Symbol.toStringTag,{value:"Module"}))},18442:function(e,t,n){n.d(t,{H:function(){return te},b:function(){return Y},c:function(){return K}});var r,i,a,o,s,u,l,c,d,h,f,p,v,g,m,y,_,T,x,S=n(30168),w=n(92026),O=n(88396),C=n(6394),b=n(67077),A=n(55360),R=n(71011),P=n(33280),E=n(28156),D=n(50600),I=n(50913),M=n(137),Z=n(18607),H=n(26461),N=n(116),L=n(78980),k=n(62993),F=n(82999),z=n(95276),U=n(59150),V=n(58406),j=n(699),W=n(98634),B=n(64201),G=n(19253),q=n(68401),X=n(4760),J=n(65964);function Y(e){var t=new B.kG,n=e.signedDistanceFieldEnabled;if(t.include(E.H),t.include(D.R,e),t.include(P.f5,e),e.output===R.H.Occlusion)return t.include(I.R,e),t;var Y=t.vertex,$=t.fragment;t.include(k.cK),$.include(L.n),$.include(N.Y),t.include(Z.k,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),Y.uniforms.add([new z.N("viewport",(function(e,t){return t.camera.fullViewport})),new F.A("screenOffset",(function(e,t){return(0,O.a)(ee,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio)})),new F.A("anchorPosition",(function(e){return K(e)})),new z.N("materialColor",(function(e){return e.color})),new V.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),n&&(Y.uniforms.add(new z.N("outlineColor",(function(e){return e.outlineColor}))),$.uniforms.add([new z.N("outlineColor",(function(e){return Q(e)?e.outlineColor:b.Z})),new V.p("outlineSize",(function(e){return Q(e)?e.outlineSize:0}))])),e.hasScreenSizePerspective&&((0,k.ww)(Y),(0,k.m8)(Y)),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(X.T.UV0,"vec2"),t.attributes.add(X.T.COLOR,"vec4"),t.attributes.add(X.T.SIZE,"vec2"),t.attributes.add(X.T.AUXPOS2,"vec4"),Y.code.add((0,W.H)(r||(r=(0,S.Z)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n\n      if (rejectBySlice(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n      vec2 inputSize;\n      ","\n\n      ","\n\n      vec2 combinedSize = inputSize * pixelRatio;\n      vec4 quadOffset = vec4(0.0);\n\n      ","\n\n      ","\n    "])),e.hasScreenSizePerspective?(0,W.H)(i||(i=(0,S.Z)(["\n      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);\n      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n         "]))):(0,W.H)(a||(a=(0,S.Z)(["\n      inputSize = size;\n      vec2 screenOffsetScaled = screenOffset;"]))),e.vvSize?"inputSize *= vvScale(auxpos2).xx;":"",e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":"",e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""));var te=(0,W.H)(o||(o=(0,S.Z)(["vec2 uv01 = floor(uv0);\nvec2 uv = uv0 - uv01;\nquadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;"]))),ne=e.pixelSnappingEnabled?n?(0,W.H)(s||(s=(0,S.Z)(["posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;"]))):(0,W.H)(u||(u=(0,S.Z)(["posProj += quadOffset;\nif (inputSize.x == size.x) {\nposProj = alignToPixelOrigin(posProj, viewport.zw);\n}"]))):(0,W.H)(l||(l=(0,S.Z)(["posProj += quadOffset;"])));e.vvColor&&Y.uniforms.add([new U.b("vvColorColors",(function(e){return e.vvColorColors}),J.x),new j.O("vvColorValues",(function(e){return e.vvColorValues}),J.x)]),Y.uniforms.add(new F.A("textureCoordinateScaleFactor",(function(e){return(0,w.pC)(e.texture)&&(0,w.pC)(e.texture.descriptor.textureCoordinateScaleFactor)?e.texture.descriptor.textureCoordinateScaleFactor:C.O}))),Y.code.add((0,W.H)(c||(c=(0,S.Z)(["\n    ","\n    ","\n    ","\n\n    bool alphaDiscard = vcolor.a < ",";\n    ",'\n    if (alphaDiscard) {\n      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    } else {\n      ',"\n      gl_Position = posProj;\n    }\n\n    vtc = uv * textureCoordinateScaleFactor;\n\n    ","\n    vsize = inputSize;\n    ","\n  }\n  "])),e.occlusionTestEnabled?"if (visible) {":"",te,e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;",W.H.float(H.b),n?"alphaDiscard = alphaDiscard && outlineColor.a < ".concat(W.H.float(H.b),";"):"",ne,e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":"",e.occlusionTestEnabled?(0,W.H)(d||(d=(0,S.Z)(["} else { vtc = vec2(0.0);\n      ",""])),e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"):"")),$.uniforms.add(new G.A("tex",(function(e){return e.texture})));var re=e.debugDrawLabelBorder?(0,W.H)(h||(h=(0,S.Z)(["(isBorder > 0.0 ? 0.0 : ",")"])),W.H.float(H.F)):W.H.float(H.F),ie=(0,W.H)(f||(f=(0,S.Z)(["\n    ","\n\n    ","\n\n    // Draw debug border with transparency, so that original texels along border are still partially visible\n    ","\n  "])),e.debugDrawLabelBorder?(0,W.H)(p||(p=(0,S.Z)(["\n      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));"]))):"",n?(0,W.H)(v||(v=(0,S.Z)(["\n      vec4 fillPixelColor = vcolor;\n\n      // Attempt to sample texel centers to avoid that thin cross outlines\n      // disappear with large symbol sizes.\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041\n      const float txSize = ",";\n      const float texelSize = 1.0 / txSize;\n      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel\n      vec2 scaleFactor = (vsize - txSize) * texelSize;\n      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;\n\n      // Get distance and map it into [-0.5, 0.5]\n      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;\n\n      // Distance in output units (i.e. pixels)\n      float dist = d * vsize.x;\n\n      // Create smooth transition from the icon into its outline\n      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);\n      fillPixelColor.a *= fillAlphaFactor;\n\n      if (outlineSize > 0.25) {\n        vec4 outlinePixelColor = outlineColor;\n        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);\n\n        // Create smooth transition around outline\n        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);\n        outlinePixelColor.a *= outlineAlphaFactor;\n\n        if (\n          outlineAlphaFactor + fillAlphaFactor < "," ||\n          fillPixelColor.a + outlinePixelColor.a < ","\n        ) {\n          discard;\n        }\n\n        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)\n        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);\n        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +\n          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);\n\n        gl_FragColor = vec4(compositeColor, compositeAlpha);\n      } else {\n        if (fillAlphaFactor < ",") {\n          discard;\n        }\n\n        gl_FragColor = premultiplyAlpha(fillPixelColor);\n      }\n\n      // visualize SDF:\n      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);\n      "])),W.H.float(A.Ph),re,W.H.float(H.b),re):(0,W.H)(g||(g=(0,S.Z)(["\n          vec4 texColor = texture2D(tex, vtc, -0.5);\n          if (texColor.a < ",") {\n            discard;\n          }\n          gl_FragColor = texColor * premultiplyAlpha(vcolor);\n          "])),re),e.debugDrawLabelBorder?(0,W.H)(m||(m=(0,S.Z)(["gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);"]))):"");return e.output===R.H.Alpha&&$.code.add((0,W.H)(y||(y=(0,S.Z)(["\n      void main() {\n        ","\n        gl_FragColor = vec4(gl_FragColor.a);\n      }\n      "])),ie)),e.output===R.H.Color&&$.code.add((0,W.H)(_||(_=(0,S.Z)(["\n    void main() {\n      ","\n      ","\n    }\n    "])),ie,e.transparencyPassType===q.Am.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":"")),e.output===R.H.Highlight&&(t.include(M.bA),$.code.add((0,W.H)(T||(T=(0,S.Z)(["\n    void main() {\n      ","\n      ","\n    }\n    "])),ie,e.binaryHighlightOcclusionEnabled?(0,W.H)(x||(x=(0,S.Z)(["\n          if (voccluded == 1.0) {\n            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);\n          } else {\n            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n          }"]))):"outputHighlight();"))),t}function Q(e){return e.outlineColor[3]>0&&e.outlineSize>0}function K(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee;return e.textureIsSignedDistanceField?$(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,O.c)(t,e.anchorPosition),t}function $(e,t,n){(0,w.pC)(t)?(0,O.a)(n,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,O.a)(n,0,0)}var ee=(0,C.a)(),te=Object.freeze(Object.defineProperty({__proto__:null,build:Y,calculateAnchorPosForRendering:K},Symbol.toStringTag,{value:"Module"}))},99337:function(e,t,n){n.d(t,{N:function(){return P},b:function(){return R}});var r,i,a,o,s,u,l,c,d,h,f,p=n(30168),v=n(71011),g=n(33280),m=n(94951),y=n(48655),_=n(137),T=n(60300),x=n(26461),S=n(82552),w=n(95276),O=n(58406),C=n(98634),b=n(64201),A=n(4760);function R(e){var t=new b.kG;t.include(m.w),t.include(y.c,e),t.include(T.q,e),(0,S.S)(t,e);var n=t.vertex,R=t.fragment;return e.stippleEnabled&&(t.attributes.add(A.T.UV0,"vec2"),t.attributes.add(A.T.AUXPOS1,"vec3"),n.uniforms.add(new w.N("viewport",(function(e,t){return t.camera.fullViewport})))),t.attributes.add(A.T.POSITION,"vec3"),t.varyings.add("vpos","vec3"),n.code.add((0,C.H)(r||(r=(0,p.Z)(["void main(void) {\nvpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);"])))),e.stippleEnabled&&(n.code.add((0,C.H)(i||(i=(0,p.Z)(["vec4 vpos2 = transformPosition(proj, view, auxpos1);\nvec2 ndcToPixel = viewport.zw * 0.5;\nfloat lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);"])))),e.draped?n.uniforms.add(new O.p("worldToScreenRatio",(function(e,t){return 1/t.screenToPCSRatio}))):n.code.add((0,C.H)(a||(a=(0,p.Z)(["vec3 segmentCenter = (position + auxpos1) * 0.5;\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),n.code.add((0,C.H)(o||(o=(0,p.Z)(["float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);"])))),e.draped?n.code.add((0,C.H)(s||(s=(0,p.Z)(["float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);\nfloat segmentLengthPseudoScreen = lineSegmentPixelSize;"])))):n.code.add((0,C.H)(u||(u=(0,p.Z)(["float segmentLengthRender = length(position - auxpos1);\nfloat startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),n.code.add((0,C.H)(l||(l=(0,p.Z)(["vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);\nvStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);\nvStippleDistance *= gl_Position.w;"]))))),n.code.add((0,C.H)(c||(c=(0,p.Z)(["}"])))),e.output===v.H.Highlight&&t.include(_.bA),t.include(g.f5,e),R.uniforms.add(new O.p("alphaCoverage",(function(e,t){return Math.min(1,e.width*t.camera.pixelRatio)}))),e.hasVertexColors||R.uniforms.add(new w.N("constantColor",(function(e){return e.color}))),R.code.add((0,C.H)(d||(d=(0,p.Z)(["\n  void main() {\n    discardBySlice(vpos);\n\n    vec4 color = ",";\n\n    float stippleAlpha = getStippleAlpha();\n    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);\n\n    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);\n\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n  }\n  "])),e.hasVertexColors?"vColor":"constantColor",C.H.float(x.b),e.output===v.H.Color?(0,C.H)(h||(h=(0,p.Z)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===v.H.Highlight?(0,C.H)(f||(f=(0,p.Z)(["outputHighlight();"]))):"")),t}var P=Object.freeze(Object.defineProperty({__proto__:null,build:R},Symbol.toStringTag,{value:"Module"}))},98186:function(e,t,n){n.d(t,{N:function(){return ce},R:function(){return he},b:function(){return de}});var r,i,a,o,s,u,l,c,d,h,f,p,v,g,m,y,_,T,x,S,w,O,C,b,A,R,P,E,D,I,M,Z,H,N,L,k,F,z,U,V,j=n(30168),W=n(92026),B=n(71011),G=n(33280),q=n(48353),X=n(16574),J=n(60300),Y=n(15226),Q=n(85586),K=n(26461),$=n(116),ee=n(82552),te=n(82999),ne=n(95276),re=n(58406),ie=n(98634),ae=n(8654),oe=n(64201),se=n(68401),ue=n(4760),le=n(737),ce=1;function de(e){var t=new oe.kG,n=e.hasMultipassTerrain&&(e.output===B.H.Color||e.output===B.H.Alpha);t.include(Q.e),t.include(q.U,e),t.include(J.q,e),e.output===B.H.Depth&&t.include(X.F,e),(0,ee.S)(t,e);var de=t.vertex,he=t.fragment;de.uniforms.add([new ae.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new te.A("nearFar",(function(e,t){return t.camera.nearFar})),new re.p("miterLimit",(function(e){return"miter"!==e.join?0:e.miterLimit})),new ne.N("viewport",(function(e,t){return t.camera.fullViewport}))]),de.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(ue.T.POSITION,"vec3"),t.attributes.add(ue.T.SUBDIVISIONFACTOR,"float"),t.attributes.add(ue.T.UV0,"vec2"),t.attributes.add(ue.T.AUXPOS1,"vec3"),t.attributes.add(ue.T.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),n&&t.varyings.add("depth","float");var fe=e.capType===le.R.ROUND,pe=e.stippleEnabled&&e.stippleScaleWithLineWidth||fe;pe&&t.varyings.add("vLineWidth","float");var ve=e.stippleEnabled&&e.stippleScaleWithLineWidth;ve&&t.varyings.add("vLineSizeInv","float");var ge=e.innerColorEnabled||fe;ge&&t.varyings.add("vLineDistance","float");var me=e.stippleEnabled&&fe,ye=e.falloffEnabled||me;ye&&t.varyings.add("vLineDistanceNorm","float"),fe&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),de.code.add((0,ie.H)(r||(r=(0,j.Z)(["#define PERPENDICULAR(v) vec2(v.y, -v.x);\nfloat interp(float ncp, vec4 a, vec4 b) {\nreturn (-ncp - a.z) / (b.z - a.z);\n}\nvec2 rotate(vec2 v, float a) {\nfloat s = sin(a);\nfloat c = cos(a);\nmat2 m = mat2(c, -s, s, c);\nreturn m * v;\n}"])))),de.code.add((0,ie.H)(i||(i=(0,j.Z)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),de.code.add((0,ie.H)(a||(a=(0,j.Z)(["\n    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {\n      float vnp = nearFar[0] * 0.99;\n\n      if(pos.z > -nearFar[0]) {\n        //current pos behind ncp --\x3e we need to clip\n        if (!isStartVertex) {\n          if(prev.z < -nearFar[0]) {\n            //previous in front of ncp\n            pos = mix(prev, pos, interp(vnp, prev, pos));\n            next = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        } else {\n          if(next.z < -nearFar[0]) {\n            //next in front of ncp\n            pos = mix(pos, next, interp(vnp, pos, next));\n            prev = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        }\n      } else {\n        //current position visible\n        if (prev.z > -nearFar[0]) {\n          //previous behind ncp\n          prev = mix(pos, prev, interp(vnp, pos, prev));\n        }\n        if (next.z > -nearFar[0]) {\n          //next behind ncp\n          next = mix(next, pos, interp(vnp, next, pos));\n        }\n      }\n\n      ","\n      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);\n\n      pos = projectAndScale(pos);\n      next = projectAndScale(next);\n      prev = projectAndScale(prev);\n    }\n  "])),n?"depth = pos.z;":"")),de.uniforms.add(new re.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),de.code.add((0,ie.H)(o||(o=(0,j.Z)(["\n  void main(void) {\n    // unpack values from uv0.y\n    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;\n\n    float coverage = 1.0;\n\n    // Check for special value of uv0.y which is used by the Renderer when graphics\n    // are removed before the VBO is recompacted. If this is the case, then we just\n    // project outside of clip space.\n    if (uv0.y == 0.0) {\n      // Project out of clip space\n      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n    else {\n      bool isJoin = abs(uv0.y) < 3.0;\n\n      float lineSize = getSize();\n      float lineWidth = lineSize * pixelRatio;\n\n      ","\n      ","\n\n      // convert sub-pixel coverage to alpha\n      if (lineWidth < 1.0) {\n        coverage = lineWidth;\n        lineWidth = 1.0;\n      }else{\n        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if\n        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly\n        // so we only really care to round anything larger than 1.\n        lineWidth = floor(lineWidth + 0.5);\n      }\n\n      vec4 pos  = view * vec4(position.xyz, 1.0);\n      vec4 prev = view * vec4(auxpos1.xyz, 1.0);\n      vec4 next = view * vec4(auxpos2.xyz, 1.0);\n\n      clipAndTransform(pos, prev, next, isStartVertex);\n\n      vec2 left = (pos.xy - prev.xy);\n      vec2 right = (next.xy - pos.xy);\n\n      float leftLen = length(left);\n      float rightLen = length(right);\n  "])),pe?(0,ie.H)(s||(s=(0,j.Z)(["vLineWidth = lineWidth;"]))):"",ve?(0,ie.H)(u||(u=(0,j.Z)(["vLineSizeInv = 1.0 / lineSize;"]))):"")),(e.stippleEnabled||fe)&&de.code.add((0,ie.H)(l||(l=(0,j.Z)(["\n      float isEndVertex = float(!isStartVertex);\n      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);\n      vec2 segment = mix(right, left, isEndVertex);\n      ","\n    "])),fe?(0,ie.H)(c||(c=(0,j.Z)(["vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);"]))):"")),de.code.add((0,ie.H)(d||(d=(0,j.Z)(["left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);\nright = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);\nvec2 capDisplacementDir = vec2(0, 0);\nvec2 joinDisplacementDir = vec2(0, 0);\nfloat displacementLen = lineWidth;\nif (isJoin) {\nbool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;\njoinDisplacementDir = normalize(left + right);\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\nif (leftLen > 0.001 && rightLen > 0.001) {\nfloat nDotSeg = dot(joinDisplacementDir, left);\ndisplacementLen /= length(nDotSeg * left - joinDisplacementDir);\nif (!isOutside) {\ndisplacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));\n}\n}\nif (isOutside && (displacementLen > miterLimit * lineWidth)) {"])))),e.roundJoins?de.code.add((0,ie.H)(h||(h=(0,j.Z)(["\n        vec2 startDir = leftLen < 0.001 ? right : left;\n        startDir = PERPENDICULAR(startDir);\n\n        vec2 endDir = rightLen < 0.001 ? left : right;\n        endDir = PERPENDICULAR(endDir);\n\n        float factor = ",";\n\n        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));\n        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);\n      "])),e.stippleEnabled?(0,ie.H)(f||(f=(0,j.Z)(["min(1.0, subdivisionFactor * ",")"])),ie.H.float((ce+2)/(ce+1))):(0,ie.H)(p||(p=(0,j.Z)(["subdivisionFactor"]))))):de.code.add((0,ie.H)(v||(v=(0,j.Z)(["if (leftLen < 0.001) {\njoinDisplacementDir = right;\n}\nelse if (rightLen < 0.001) {\njoinDisplacementDir = left;\n}\nelse {\njoinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;\n}\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);"]))));var _e=e.capType!==le.R.BUTT;return de.code.add((0,ie.H)(g||(g=(0,j.Z)(["\n        displacementLen = lineWidth;\n      }\n    } else {\n      // CAP handling ---------------------------------------------------\n      joinDisplacementDir = isStartVertex ? right : left;\n      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\n\n      ","\n    }\n  "])),_e?(0,ie.H)(m||(m=(0,j.Z)(["capDisplacementDir = isStartVertex ? -right : left;"]))):"")),de.code.add((0,ie.H)(y||(y=(0,j.Z)(["\n    // Displacement (in pixels) caused by join/or cap\n    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;\n\n    ","\n\n    ","\n    ","\n\n    pos.xy += dpos;\n  "])),ye||ge?(0,ie.H)(_||(_=(0,j.Z)(["float lineDistNorm = sign(uv0.y) * pos.w;"]))):"",ge?(0,ie.H)(T||(T=(0,j.Z)(["vLineDistance = lineWidth * lineDistNorm;"]))):"",ye?(0,ie.H)(x||(x=(0,j.Z)(["vLineDistanceNorm = lineDistNorm;"]))):"")),fe&&de.code.add((0,ie.H)(S||(S=(0,j.Z)(["vec2 segmentDir = normalize(segment);\nvSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;\nvReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);"])))),e.stippleEnabled&&(e.draped?de.uniforms.add(new re.p("worldToScreenRatio",(function(e,t){return 1/t.screenToPCSRatio}))):de.code.add((0,ie.H)(w||(w=(0,j.Z)(["vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),de.code.add((0,ie.H)(O||(O=(0,j.Z)(["float segmentLengthScreenDouble = length(segment);\nfloat segmentLengthScreen = segmentLengthScreenDouble * 0.5;\nfloat discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);\nfloat segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));\nvStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;"])))),e.draped?de.code.add((0,ie.H)(C||(C=(0,j.Z)(["float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;\nfloat startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);"])))):de.code.add((0,ie.H)(b||(b=(0,j.Z)(["float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),de.code.add((0,ie.H)(A||(A=(0,j.Z)(["\n      float patternLength = "," stipplePatternPixelSize;\n\n      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader\n      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);\n\n      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);\n\n      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)\n      if (segmentLengthScreenDouble >= 0.001) {\n        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the\n        // original vertex positions, and slightly outside of that range at the displaced positions\n        vec2 stippleDisplacement = pos.xy - segmentOrigin;\n        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);\n\n        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)\n        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);\n      }\n\n      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance\n      vStippleDistanceLimits *= pos.w;\n      vStippleDistance *= pos.w;\n\n      // Disable stipple distance limits on caps\n      vStippleDistanceLimits = isJoin ?\n                                 vStippleDistanceLimits :\n                                 isStartVertex ?\n                                  vec2(-1e038, vStippleDistanceLimits.y) :\n                                  vec2(vStippleDistanceLimits.x, 1e038);\n    "])),e.stippleScaleWithLineWidth?"lineSize * ":""))),de.code.add((0,ie.H)(R||(R=(0,j.Z)(["\n      // Convert back into NDC\n      pos.xy = (pos.xy / viewport.zw) * pos.w;\n\n      vColor = getColor();\n      vColor.a *= coverage;\n\n      ","\n\n      // transform final position to camera space for slicing\n      vpos = (inverseProjectionMatrix * pos).xyz;\n      gl_Position = pos;\n    }\n  }\n  "])),e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":"")),n&&t.include(Y.l,e),t.include(G.f5,e),he.include($.Y),he.code.add((0,ie.H)(P||(P=(0,j.Z)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n  "])),n?"terrainDepthTest(gl_FragCoord, depth);":"")),e.wireframe?he.code.add((0,ie.H)(E||(E=(0,j.Z)(["vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);"])))):(fe&&he.code.add((0,ie.H)(D||(D=(0,j.Z)(["\n      float sdf = min(vSegmentSDF, vReverseSegmentSDF);\n      vec2 fragmentPosition = vec2(\n        min(sdf, 0.0),\n        vLineDistance\n      ) * gl_FragCoord.w;\n\n      float fragmentRadius = length(fragmentPosition);\n      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);\n\n      if (capCoverage < ",") {\n        discard;\n      }\n    "])),ie.H.float(K.b))),me?he.code.add((0,ie.H)(I||(I=(0,j.Z)(["\n      vec2 stipplePosition = vec2(\n        min(getStippleSDF() * 2.0 - 1.0, 0.0),\n        vLineDistanceNorm * gl_FragCoord.w\n      );\n      float stippleRadius = length(stipplePosition * vLineWidth);\n      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);\n      float stippleAlpha = step(",", stippleCoverage);\n      "])),ie.H.float(K.b))):he.code.add((0,ie.H)(M||(M=(0,j.Z)(["float stippleAlpha = getStippleAlpha();"])))),he.uniforms.add(new ne.N("intrinsicColor",(function(e){return e.color}))),he.code.add((0,ie.H)(Z||(Z=(0,j.Z)(["discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);\nvec4 color = intrinsicColor * vColor;"])))),e.innerColorEnabled&&(he.uniforms.add(new ne.N("innerColor",(function(e){return(0,W.Pt)(e.innerColor,e.color)}))),he.uniforms.add(new re.p("innerWidth",(function(e,t){return e.innerWidth*t.camera.pixelRatio}))),he.code.add((0,ie.H)(H||(H=(0,j.Z)(["float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;\nfloat innerAA = clamp(0.5 - distToInner, 0.0, 1.0);\nfloat innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);\ncolor = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);"]))))),he.code.add((0,ie.H)(N||(N=(0,j.Z)(["vec4 finalColor = blendStipple(color, stippleAlpha);"])))),e.falloffEnabled&&(he.uniforms.add(new re.p("falloff",(function(e){return e.falloff}))),he.code.add((0,ie.H)(L||(L=(0,j.Z)(["finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);"])))))),he.code.add((0,ie.H)(k||(k=(0,j.Z)(["\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),ie.H.float(K.b),e.output===B.H.Alpha?(0,ie.H)(F||(F=(0,j.Z)(["gl_FragColor = vec4(finalColor.a);"]))):"",e.output===B.H.Color?(0,ie.H)(z||(z=(0,j.Z)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",e.output===B.H.Color&&e.transparencyPassType===se.Am.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":"",e.output===B.H.Highlight?(0,ie.H)(U||(U=(0,j.Z)(["gl_FragColor = vec4(1.0);"]))):"",e.output===B.H.Depth?(0,ie.H)(V||(V=(0,j.Z)(["outputDepth(linearDepth);"]))):"")),t}var he=Object.freeze(Object.defineProperty({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:ce,build:de},Symbol.toStringTag,{value:"Module"}))},46516:function(e,t,n){n.d(t,{S:function(){return S},b:function(){return x}});var r,i,a,o,s,u=n(30168),l=n(74321),c=n(21002),d=n(96415),h=n(82999),f=n(17943),p=n(60465),v=n(98634),g=n(64201),m=n(2104),y=n(23038),_=16,T=4;function x(e){var t=new g.kG,n=t.fragment;if(t.include(l.k),e.output===y.Q.Blur){var x=(T+1)/2,S=1/(2*x*x);n.include(c.S),n.uniforms.add([new m.Q("normalMap"),new m.Q("depthMap"),new m.Q("tex"),new f.e("blurSize"),new p.d("projScale"),new h.A("nearFar",(function(e,t){return t.camera.nearFar}))]),n.code.add((0,v.H)(r||(r=(0,u.Z)(["\n      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {\n        float c = texture2D(tex, uv).r;\n        float d = linearDepthFromTexture(depthMap, uv, nearFar);\n\n        float ddiff = d - center_d;\n\n        float w = exp(-r * r * "," - ddiff * ddiff * sharpness);\n        wTotal += w;\n        bTotal += w * c;\n      }\n    "])),v.H.float(S))),n.code.add((0,v.H)(i||(i=(0,u.Z)(["\n      void main(void) {\n        float b = 0.0;\n        float w_total = 0.0;\n\n        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);\n\n        float sharpness = -0.05 * projScale/center_d;\n        for (int r = -","; r <= ","; ++r) {\n          float rf = float(r);\n          vec2 uvOffset = uv + rf * blurSize;\n          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);\n        }\n\n        gl_FragColor = vec4(b / w_total);\n      }\n    "])),v.H.int(T),v.H.int(T)))}return e.output===y.Q.SSAO&&(n.include(c.S),t.include(d.G),n.uniforms.add(new m.Q("normalMap")),n.uniforms.add(new m.Q("depthMap")),n.uniforms.add(new m.Q("rnm")),n.uniforms.add(new p.d("intensity")),n.uniforms.add(new p.d("projScale")),n.uniforms.add(new p.d("radius")),n.uniforms.add(new h.A("nearFar",(function(e,t){return t.camera.nearFar}))),n.uniforms.add(new f.e("screenSize")),n.uniforms.add(new f.e("rnmScale")),n.code.add((0,v.H)(a||(a=(0,u.Z)(["vec3 sphere[16];\nvoid fillSphere() {\nsphere[0] = vec3(0.186937, 0.0, 0.0);\nsphere[1] = vec3(0.700542, 0.0, 0.0);\nsphere[2] = vec3(-0.864858, -0.481795, -0.111713);\nsphere[3] = vec3(-0.624773, 0.102853, -0.730153);\nsphere[4] = vec3(-0.387172, 0.260319, 0.007229);\nsphere[5] = vec3(-0.222367, -0.642631, -0.707697);\nsphere[6] = vec3(-0.01336, -0.014956, 0.169662);\nsphere[7] = vec3(0.122575, 0.1544, -0.456944);\nsphere[8] = vec3(-0.177141, 0.85997, -0.42346);\nsphere[9] = vec3(-0.131631, 0.814545, 0.524355);\nsphere[10] = vec3(-0.779469, 0.007991, 0.624833);\nsphere[11] = vec3(0.308092, 0.209288,0.35969);\nsphere[12] = vec3(0.359331, -0.184533, -0.377458);\nsphere[13] = vec3(0.192633, -0.482999, -0.065284);\nsphere[14] = vec3(0.233538, 0.293706, -0.055139);\nsphere[15] = vec3(0.417709, -0.386701, 0.442449);\n}\nfloat fallOffFunction(float vv, float vn, float bias) {\nfloat f = max(radius * radius - vv, 0.0);\nreturn f * f * f * max(vn-bias, 0.0);\n}"])))),n.code.add((0,v.H)(o||(o=(0,u.Z)(["float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {\nvec3 v = Q - C;\nfloat vv = dot(v, v);\nfloat vn = dot(normalize(v), n_C);\nreturn fallOffFunction(vv, vn, 0.1);\n}"])))),t.fragment.uniforms.add(new h.A("zScale",(function(e,t){return(0,d.R)(t)}))),n.code.add((0,v.H)(s||(s=(0,u.Z)(["\n      void main(void) {\n        fillSphere();\n        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));\n        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);\n\n        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {\n          gl_FragColor = vec4(0.0);\n          return;\n        }\n\n        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);\n\n        // get the normal of current fragment\n        vec4 norm4 = texture2D(normalMap, uv);\n        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;\n        bool isTerrain = norm4.w<0.5;\n\n        float sum = .0;\n        vec3 tapPixelPos;\n\n        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.\n        // bug or deviation from CE somewhere else?\n        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);\n\n        for(int i = 0; i < ","; ++i) {\n          vec2 unitOffset = reflect(sphere[i], fres).xy;\n          vec2 offset = vec2(-unitOffset * radius * ps);\n\n          //don't use current or very nearby samples\n          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;\n\n          vec2 tc = vec2(gl_FragCoord.xy + offset);\n          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;\n          vec2 tcTap = tc / screenSize;\n          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);\n\n          if (isTerrain) {\n            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;\n            if (isTerrainTap) {\n              continue;\n            }\n          }\n\n          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);\n\n          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);\n        }\n\n        // output the result\n        float A = max(1.0-sum*intensity/float(","),0.0);\n\n        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2\n        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;\n        gl_FragColor = vec4(A);\n      }\n    "])),v.H.int(_),v.H.int(_)))),t}var S=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},61863:function(e,t,n){n.d(t,{T:function(){return d},b:function(){return c}});var r,i=n(30168),a=n(74321),o=n(68827),s=n(98634),u=n(64201),l=n(2104);function c(){var e=new u.kG;return e.include(a.k),e.fragment.uniforms.add([new l.Q("tex"),new o.y("uColor")]),e.fragment.code.add((0,s.H)(r||(r=(0,i.Z)(["void main() {\nvec4 texColor = texture2D(tex, uv);\ngl_FragColor = texColor * uColor;\n}"])))),e}var d=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},49810:function(e,t,n){n.d(t,{W:function(){return z},b:function(){return F}});var r,i,a,o,s,u,l,c,d,h,f=n(30168),p=n(22357),v=n(71011),g=n(33280),m=n(94951),y=n(137),_=n(60750),T=n(92395),x=n(15226),S=n(8555),w=n(41481),O=n(87920),C=n(77652),b=n(79246),A=n(26461),R=n(116),P=n(82552),E=n(49450),D=n(95276),I=n(68827),M=n(58406),Z=n(98634),H=n(54118),N=n(64201),L=n(68401),k=n(4760);function F(e){var t=new N.kG,n=t.vertex,F=t.fragment,z=(0,P.S)(t,e);return t.include(m.w),t.attributes.add(k.T.POSITION,"vec3"),t.attributes.add(k.T.UV0,"vec2"),n.uniforms.add(new D.N("waterColor",(function(e){return e.color}))),e.output!==v.H.Color&&e.output!==v.H.Alpha||(t.include(S.n,e),t.include(p.q,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),F.uniforms.add(z),e.hasMultipassTerrain&&t.varyings.add("depth","float"),n.code.add((0,Z.H)(r||(r=(0,f.Z)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),Z.H.float(A.b),e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":"",e.output===v.H.Color?"forwardLinearDepth();":""))),t.include(x.l,e),e.output===v.H.Alpha&&(t.include(g.f5,e),F.uniforms.add(new I.y("waterColor")),F.code.add((0,Z.H)(i||(i=(0,f.Z)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""))),e.output===v.H.Color&&(t.include(T.k,{isGround:!1}),t.include(_._,{pbrMode:w.f7.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(b.M),t.include(g.f5,e),t.include(O.XE,e),t.include(C.B,e),F.uniforms.add([new I.y("waterColor"),new E.J("lightingMainDirection",(function(e,t){return t.lighting.lightingMainDirection})),new E.J("lightingMainIntensity",(function(e,t){return t.lighting.mainLight.intensity})),new M.p("timeElapsed",(function(e){return e.timeElapsed})),new H.B("view")]),(0,P.h)(F,e),F.include(R.Y),F.code.add((0,Z.H)(a||(a=(0,f.Z)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - cameraPosition);\n        float shadow = ",";\n        vec4 vPosView = view*vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?(0,Z.H)(o||(o=(0,f.Z)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.transparencyPassType===L.Am.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),e.output===v.H.Normal&&(t.include(S.n,e),t.include(b.M,e),t.include(g.f5,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),n.code.add((0,Z.H)(s||(s=(0,f.Z)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),Z.H.float(A.b))),F.uniforms.add(new M.p("timeElapsed",(function(e){return e.timeElapsed}))),F.code.add((0,Z.H)(u||(u=(0,f.Z)(["void main() {\ndiscardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\ngl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n}"]))))),e.output===v.H.Draped&&(t.varyings.add("vpos","vec3"),n.code.add((0,Z.H)(l||(l=(0,f.Z)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),Z.H.float(A.b))),F.uniforms.add(new I.y("waterColor")),F.code.add((0,Z.H)(c||(c=(0,f.Z)(["void main() {\ngl_FragColor = waterColor;\n}"]))))),e.output===v.H.Highlight&&(t.include(y.bA),t.varyings.add("vpos","vec3"),n.code.add((0,Z.H)(d||(d=(0,f.Z)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),Z.H.float(A.b))),t.include(g.f5,e),F.code.add((0,Z.H)(h||(h=(0,f.Z)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))),t}var z=Object.freeze(Object.defineProperty({__proto__:null,build:F},Symbol.toStringTag,{value:"Module"}))},82218:function(e,t,n){n.d(t,{a:function(){return S},c:function(){return x},g:function(){return b},h:function(){return M},u:function(){return O}});var r=n(37762),i=n(43144),a=n(15671),o=(n(93169),n(32718)),s=n(16889),u=n(21530),l=n(14226),c=n(81949),d=n(11186),h=n(71353),f=n(14320),p=n(85981),v=n(55652),g=n(40885),m=n(40927),y=n(11185),_=o.Z.getLogger("esri.views.3d.support.geometryUtils.boundedPlane"),T=(0,i.Z)((function e(){(0,a.Z)(this,e),this.plane=(0,v.Ue)(),this.origin=(0,h.c)(),this.basis1=(0,h.c)(),this.basis2=(0,h.c)()}));function x(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:U;return{plane:(0,v.Ue)(e.plane),origin:(0,h.a)(e.origin),basis1:(0,h.a)(e.basis1),basis2:(0,h.a)(e.basis2)}}function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x();return w(e.origin,e.basis1,e.basis2,t)}function w(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:x();return(0,d.c)(r.origin,e),(0,d.c)(r.basis1,t),(0,d.c)(r.basis2,n),O(r),F(r,"fromValues()"),r}function O(e){(0,v.my)(e.basis2,e.basis1,e.origin,e.plane)}function C(e,t,n){e!==n&&S(e,n);var r=(0,d.g)(y.WM.get(),H(e),t);return(0,d.a)(n.origin,n.origin,r),n.plane[3]-=t,n}function b(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x(),n=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return(0,d.s)(t.origin,e[0]+n,e[1]+r,0),(0,d.s)(t.basis1,n,0,0),(0,d.s)(t.basis2,0,r,0),(0,v.al)(0,0,1,0,t.plane),t}function A(e,t,n){return!!(0,v.BR)(e.plane,t,n)&&N(e,n)}function R(e,t,n){var i=V.get();z(e,t,i,V.get());var a,o=Number.POSITIVE_INFINITY,u=(0,r.Z)(G);try{for(u.s();!(a=u.n()).done;){var l=k(e,a.value,j.get()),c=y.WM.get();if((0,v.rx)(i,l,c)){var h=(0,d.r)(y.WM.get(),t.origin,c),f=Math.abs((0,s.ZF)((0,d.e)(t.direction,h)));f<o&&(o=f,(0,d.c)(n,c))}}}catch(p){u.e(p)}finally{u.f()}return o===Number.POSITIVE_INFINITY?P(e,t,n):n}function P(e,t,n){if(A(e,t,n))return n;var i=V.get(),a=V.get();z(e,t,i,a);var o,s=Number.POSITIVE_INFINITY,u=(0,r.Z)(G);try{for(u.s();!(o=u.n()).done;){var l=k(e,o.value,j.get()),c=y.WM.get();if((0,v.dZ)(i,l,c)){var h=(0,g.Jk)(t,c);if(!(0,v.Ac)(a,c))continue;h<s&&(s=h,(0,d.c)(n,c))}}}catch(f){u.e(f)}finally{u.f()}return I(e,t.origin)<s&&E(e,t.origin,n),n}function E(e,t,n){var r=(0,v.nF)(e.plane,t,y.WM.get()),i=(0,p.ct)(L(e,e.basis1),r,-1,1,y.WM.get()),a=(0,p.ct)(L(e,e.basis2),r,-1,1,y.WM.get());return(0,d.b)(n,(0,d.a)(y.WM.get(),i,a),e.origin),n}function D(e,t,n){var r=e.origin,i=e.basis1,a=e.basis2,o=(0,d.b)(y.WM.get(),t,r),s=(0,m.SR)(i,o),u=(0,m.SR)(a,o),l=(0,m.SR)(H(e),o);return(0,d.s)(n,s,u,l)}function I(e,t){var n=D(e,t,y.WM.get()),r=e.basis1,i=e.basis2,a=(0,d.l)(r),o=(0,d.l)(i),s=Math.max(Math.abs(n[0])-a,0),u=Math.max(Math.abs(n[1])-o,0),l=n[2];return s*s+u*u+l*l}function M(e,t){return Math.sqrt(I(e,t))}function Z(e,t){var n=-e.plane[3];return(0,m.SR)(H(e),t)-n}function H(e){return(0,v.mJ)(e.plane)}function N(e,t){var n=(0,d.b)(y.WM.get(),t,e.origin),r=(0,d.p)(e.basis1),i=(0,d.p)(e.basis2),a=(0,d.e)(e.basis1,n),o=(0,d.e)(e.basis2,n);return-a-r<0&&a-r<0&&-o-i<0&&o-i<0}function L(e,t){var n=j.get();return(0,d.c)(n.origin,e.origin),(0,d.c)(n.vector,t),n}function k(e,t,n){var r=e.basis1,i=e.basis2,a=e.origin,o=(0,d.g)(y.WM.get(),r,t.origin[0]),s=(0,d.g)(y.WM.get(),i,t.origin[1]);(0,d.a)(n.origin,o,s),(0,d.a)(n.origin,n.origin,a);var u=(0,d.g)(y.WM.get(),r,t.direction[0]),l=(0,d.g)(y.WM.get(),i,t.direction[1]);return(0,d.g)(n.vector,(0,d.a)(u,u,l),2),n}function F(e,t){Math.abs((0,d.e)(e.basis1,e.basis2)/((0,d.l)(e.basis1)*(0,d.l)(e.basis2)))>1e-6&&_.warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,d.e)(e.basis1,H(e)))>1e-6&&_.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,d.e)(H(e),e.origin)-e.plane[3])>1e-6&&_.warn(t,"Plane offset is not consistent with plane origin")}function z(e,t,n,r){var i=H(e);(0,v.my)(i,t.direction,t.origin,n),(0,v.my)((0,v.mJ)(n),i,t.origin,r)}var U={plane:(0,v.Ue)(),origin:(0,h.f)(0,0,0),basis1:(0,h.f)(1,0,0),basis2:(0,h.f)(0,1,0)},V=new u.x(v.Ue),j=new u.x(p.Ue),W=(0,h.c)(),B=new u.x((function(){return{origin:null,basis1:null,basis2:null,plane:null}})),G=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],q=(0,c.c)(),X=(0,c.c)();Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:T,create:x,wrap:function(e,t,n){var r=B.get();return r.origin=e,r.basis1=t,r.basis2=n,r.plane=(0,v.re)(0,0,0,0),O(r),r},copy:S,copyWithoutVerify:function(e,t){(0,d.c)(t.origin,e.origin),(0,d.c)(t.basis1,e.basis1),(0,d.c)(t.basis2,e.basis2),(0,v.JG)(t.plane,e.plane)},fromValues:w,updateUnboundedPlane:O,elevate:C,setExtent:function(e,t,n){return b(t,n),C(n,Z(e,e.origin),n),n},fromAABoundingRect:b,intersectRay:A,intersectRayClosestSilhouette:function(e,t,n){if(A(e,t,n))return n;var r=R(e,t,y.WM.get());return(0,d.a)(n,t.origin,(0,d.g)(y.WM.get(),t.direction,(0,d.i)(t.origin,r)/(0,d.l)(t.direction))),n},closestPointOnSilhouette:R,closestPoint:P,projectPoint:E,projectPointLocal:D,distance2:I,distance:M,distanceToSilhouette:function(e,t){var n,i=Number.NEGATIVE_INFINITY,a=(0,r.Z)(G);try{for(a.s();!(n=a.n()).done;){var o=k(e,n.value,j.get()),s=(0,p.Jk)(o,t);s>i&&(i=s)}}catch(u){a.e(u)}finally{a.f()}return Math.sqrt(i)},extrusionContainsPoint:function(e,t){return(0,v.Ac)(e.plane,t)&&N(e,t)},axisAt:function(e,t,n,r){return function(e,t,n){switch(t){case f.R.X:(0,d.c)(n,e.basis1),(0,d.n)(n,n);break;case f.R.Y:(0,d.c)(n,e.basis2),(0,d.n)(n,n);break;case f.R.Z:(0,d.c)(n,H(e))}return n}(e,n,r)},altitudeAt:Z,setAltitudeAt:function(e,t,n,r){var i=Z(e,t),a=(0,d.g)(W,H(e),n-i);return(0,d.a)(r,t,a),r},equals:function(e,t){return(0,d.k)(e.basis1,t.basis1)&&(0,d.k)(e.basis2,t.basis2)&&(0,d.k)(e.origin,t.origin)},transform:function(e,t,n){return e!==n&&S(e,n),(0,l.a)(q,t),(0,l.t)(q,q),(0,d.m)(n.basis1,e.basis1,q),(0,d.m)(n.basis2,e.basis2,q),(0,d.m)((0,v.mJ)(n.plane),(0,v.mJ)(e.plane),q),(0,d.m)(n.origin,e.origin,t),(0,v.T5)(n.plane,n.plane,n.origin),n},rotate:function(e,t,n,r){return e!==r&&S(e,r),(0,l.d)(X,t,n),(0,d.m)(r.basis1,e.basis1,X),(0,d.m)(r.basis2,e.basis2,X),O(r),r},normal:H,UP:U},Symbol.toStringTag,{value:"Module"}))},79347:function(e,t,n){n.d(t,{e:function(){return s}});var r,i,a,o={exports:{}};r=o,i=function(){function e(e,n,i){i=i||2;var a,o,s,l,c,d,h,f=n&&n.length,p=f?n[0]*i:e.length,v=t(e,0,p,i,!0),g=[];if(!v||v.next===v.prev)return g;if(f&&(v=u(e,n,v,i)),e.length>80*i){a=s=e[0],o=l=e[1];for(var m=i;m<p;m+=i)(c=e[m])<a&&(a=c),(d=e[m+1])<o&&(o=d),c>s&&(s=c),d>l&&(l=d);h=0!==(h=Math.max(s-a,l-o))?1/h:0}return r(v,g,i,a,o,h),g}function t(e,t,n,r,i){var a,o;if(i===R(e,t,n,r)>0)for(a=t;a<n;a+=r)o=C(a,e[a],e[a+1],o);else for(a=n-r;a>=t;a-=r)o=C(a,e[a],e[a+1],o);if(o&&_(o,o.next)){var s=o.next;b(o),o=s}return o}function n(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!_(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{var i=r.prev;if(b(r),(r=t=i)===r.next)break;n=!0}}while(n||r!==t);return t}function r(e,t,u,l,c,d,h){if(e){!h&&d&&f(e,l,c,d);for(var p,v,g=e;e.prev!==e.next;)if(p=e.prev,v=e.next,d?a(e,l,c,d):i(e))t.push(p.i/u),t.push(e.i/u),t.push(v.i/u),b(e),e=v.next,g=v.next;else if((e=v)===g){h?1===h?r(e=o(n(e),t,u),t,u,l,c,d,2):2===h&&s(e,t,u,l,c,d):r(n(e),t,u,l,c,d,1);break}}}function i(e){var t=e.prev,n=e,r=e.next;if(y(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(g(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&y(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function a(e,t,n,r){var i=e.prev,a=e,o=e.next;if(y(i,a,o)>=0)return!1;for(var s=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,u=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,l=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,c=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,d=p(s,u,t,n,r),h=p(l,c,t,n,r),f=e.prevZ,v=e.nextZ;f&&f.z>=d&&v&&v.z<=h;){if(f!==e.prev&&f!==e.next&&g(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&y(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,v!==e.prev&&v!==e.next&&g(i.x,i.y,a.x,a.y,o.x,o.y,v.x,v.y)&&y(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;f&&f.z>=d;){if(f!==e.prev&&f!==e.next&&g(i.x,i.y,a.x,a.y,o.x,o.y,f.x,f.y)&&y(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;v&&v.z<=h;){if(v!==e.prev&&v!==e.next&&g(i.x,i.y,a.x,a.y,o.x,o.y,v.x,v.y)&&y(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function o(e,t,r){var i=e;do{var a=i.prev,o=i.next.next;!_(a,o)&&T(a,i,i.next,o)&&w(a,o)&&w(o,a)&&(t.push(a.i/r),t.push(i.i/r),t.push(o.i/r),b(i),b(i.next),i=e=o),i=i.next}while(i!==e);return n(i)}function s(e,t,i,a,o,s){var u=e;do{for(var l=u.next.next;l!==u.prev;){if(u.i!==l.i&&m(u,l)){var c=O(u,l);return u=n(u,u.next),c=n(c,c.next),r(u,t,i,a,o,s),void r(c,t,i,a,o,s)}l=l.next}u=u.next}while(u!==e)}function u(e,r,i,a){var o,s,u,c=[];for(o=0,s=r.length;o<s;o++)(u=t(e,r[o]*a,o<s-1?r[o+1]*a:e.length,a,!1))===u.next&&(u.steiner=!0),c.push(v(u));for(c.sort(l),o=0;o<c.length;o++)i=n(i=d(c[o],i),i.next);return i}function l(e,t){return e.x-t.x}function c(e){if(e.next.prev===e)return e;for(var t=e;;){var n=t.next;if(n.prev===t||n===t||n===e)break;t=n}return t}function d(e,t){var r=function(e,t){var n,r=t,i=e.x,a=e.y,o=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var s=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>o){if(o=s,s===i){if(a===r.y)return r;if(a===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===o)return n;var u,l=n,c=n.x,d=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&g(a<d?i:o,a,c,d,a<d?o:i,a,r.x,r.y)&&(u=Math.abs(a-r.y)/(i-r.x),w(r,e)&&(u<f||u===f&&(r.x>n.x||r.x===n.x&&h(n,r)))&&(n=r,f=u)),r=r.next}while(r!==l);return n}(e,t);if(!r)return t;var i=O(r,e),a=n(r,r.next),o=c(i);return n(o,o.next),a=c(a),c(t===r?a:t)}function h(e,t){return y(e.prev,e,t.prev)<0&&y(t.next,e,e.next)<0}function f(e,t,n,r){var i=e;do{null===i.z&&(i.z=p(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,a,o,s,u,l=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,r=n,s=0,t=0;t<l&&(s++,r=r.nextZ);t++);for(u=l;s>0||u>0&&r;)0!==s&&(0===u||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,u--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;n=r}a.nextZ=null,l*=2}while(o>1)}(i)}function p(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function v(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function g(e,t,n,r,i,a,o,s){return(i-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(r-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(i-o)*(r-s)>=0}function m(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&T(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(w(e,t)&&w(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&i<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(y(e.prev,e,t.prev)||y(e,t.prev,t))||_(e,t)&&y(e.prev,e,e.next)>0&&y(t.prev,t,t.next)>0)}function y(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function _(e,t){return e.x===t.x&&e.y===t.y}function T(e,t,n,r){var i=S(y(e,t,n)),a=S(y(e,t,r)),o=S(y(n,r,e)),s=S(y(n,r,t));return i!==a&&o!==s||!(0!==i||!x(e,n,t))||!(0!==a||!x(e,r,t))||!(0!==o||!x(n,e,r))||!(0!==s||!x(n,t,r))}function x(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function S(e){return e>0?1:e<0?-1:0}function w(e,t){return y(e.prev,e,e.next)<0?y(e,t,e.next)>=0&&y(e,e.prev,t)>=0:y(e,t,e.prev)<0||y(e,e.next,t)<0}function O(e,t){var n=new A(e.i,e.x,e.y),r=new A(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,a.next=r,r.prev=a,r}function C(e,t,n,r){var i=new A(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function b(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function A(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,n,r){for(var i=0,a=t,o=n-r;a<n;a+=r)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}return e.deviation=function(e,t,n,r){var i=t&&t.length,a=i?t[0]*n:e.length,o=Math.abs(R(e,0,a,n));if(i)for(var s=0,u=t.length;s<u;s++){var l=t[s]*n,c=s<u-1?t[s+1]*n:e.length;o-=Math.abs(R(e,l,c,n))}var d=0;for(s=0;s<r.length;s+=3){var h=r[s]*n,f=r[s+1]*n,p=r[s+2]*n;d+=Math.abs((e[h]-e[p])*(e[f+1]-e[h+1])-(e[h]-e[f])*(e[p+1]-e[h+1]))}return 0===o&&0===d?0:Math.abs((d-o)/o)},e.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var a=0;a<e[i].length;a++)for(var o=0;o<t;o++)n.vertices.push(e[i][a][o]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n},e},void 0!==(a=i())&&(r.exports=a);var s=o.exports},59447:function(e,t,n){n.d(t,{r:function(){return a}});var r=n(15671),i=n(43144),a=function(){function e(){(0,r.Z)(this,e),this._outer=new Map}return(0,i.Z)(e,[{key:"clear",value:function(){this._outer.clear()}},{key:"empty",get:function(){return 0===this._outer.size}},{key:"get",value:function(e,t){var n;return null===(n=this._outer.get(e))||void 0===n?void 0:n.get(t)}},{key:"set",value:function(e,t,n){var r=this._outer.get(e);r?r.set(t,n):this._outer.set(e,new Map([[t,n]]))}},{key:"delete",value:function(e,t){var n=this._outer.get(e);n&&(n.delete(t),0===n.size&&this._outer.delete(e))}},{key:"forEach",value:function(e){this._outer.forEach((function(t,n){return e(t,n)}))}}]),e}()},46228:function(e,t,n){n.d(t,{I:function(){return i},v:function(){return a}});var r=n(16889);function i(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=(0,r.uZ)(e,0,u),a=0;a<4;a++)t[n+a]=Math.floor(256*l(i*o[a]))}function a(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0,r=0;r<4;r++)n+=e[t+r]*s[r];return n}var o=[1,256,65536,16777216],s=[1/256,1/65536,1/16777216,1/4294967296],u=a(new Uint8ClampedArray([255,255,255,255]));function l(e){return e-Math.floor(e)}},91320:function(e,t,n){n.d(t,{Mk:function(){return l},ZI:function(){return r},bT:function(){return u}});var r,i=n(37762),a=n(79347),o=n(69662),s=n(35888);function u(e){var t,n=l(e.rings,e.hasZ,r.CCW_IS_HOLE),o=[],u=0,c=0,d=(0,i.Z)(n.polygons);try{var h=function(){var e=t.value,r=e.count,i=e.index,s=new Float64Array(n.position.buffer,3*i*n.position.BYTES_PER_ELEMENT,3*r),l=e.holeIndices.map((function(e){return e-i})),d=new Uint32Array((0,a.e)(s,l,3));o.push({position:s,faces:d}),u+=s.length,c+=d.length};for(d.s();!(t=d.n()).done;)h()}catch(v){d.e(v)}finally{d.f()}var f=function(e,t,n){if(1===e.length)return e[0];var r,a=new Float64Array(t),o=new Uint32Array(n),s=0,u=0,l=0,c=(0,i.Z)(e);try{for(c.s();!(r=c.n()).done;){for(var d=r.value,h=0;h<d.position.length;h++)a[s++]=d.position[h];for(var f=0;f<d.faces.length;f++)o[u++]=d.faces[f]+l;l=s/3}}catch(v){c.e(v)}finally{c.f()}return{position:a,faces:o}}(o,u,c),p=(0,s.d)(f.position.buffer,6,{originalIndices:f.faces});return f.position=new Float64Array(p.buffer),f.faces=p.indices,f}function l(e,t,n){for(var i=e.length,a=new Array(i),o=new Array(i),s=new Array(i),u=0,l=0,h=0,f=0,p=0;p<i;++p)f+=e[p].length;for(var v=new Float64Array(3*f),g=0,m=i-1;m>=0;m--){var y=e[m],_=n===r.CCW_IS_HOLE&&d(y);if(_&&1!==i)a[u++]=y;else{for(var T=y.length,x=0;x<u;++x)T+=a[x].length;var S={index:g,pathLengths:new Array(u+1),count:T,holeIndices:new Array(u)};S.pathLengths[0]=y.length,y.length>0&&(s[h++]={index:g,count:y.length}),g=_?c(y,y.length-1,-1,v,g,y.length,t):c(y,0,1,v,g,y.length,t);for(var w=0;w<u;++w){var O=a[w];S.holeIndices[w]=g,S.pathLengths[w+1]=O.length,O.length>0&&(s[h++]={index:g,count:O.length}),g=c(O,0,1,v,g,O.length,t)}u=0,S.count>0&&(o[l++]=S)}}for(var C=0;C<u;++C){var b=a[C];b.length>0&&(s[h++]={index:g,count:b.length}),g=c(b,0,1,v,g,b.length,t)}return l<i&&(o.length=l),h<i&&(s.length=h),{position:v,polygons:o,outlines:s}}function c(e,t,n,r,i,a,o){i*=3;for(var s=0;s<a;++s){var u=e[t];r[i++]=u[0],r[i++]=u[1],r[i++]=o?u[2]:0,t+=n}return i/3}function d(e){return!(0,o.bu)(e,!1,!1)}!function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"}(r||(r={}))},70178:function(e,t,n){n.d(t,{k:function(){return r}});n(93169);function r(e,t){return!!i(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function i(e,t){return e===t||e&&t&&e.equals(t)}},81020:function(e,t,n){function r(e){return"point"===e.type}n.d(t,{f:function(){return r}})},65618:function(e,t,n){n.d(t,{FS:function(){return p},MS:function(){return g},Pj:function(){return d},R3:function(){return f},S6:function(){return c},TF:function(){return v},Tx:function(){return h},Wh:function(){return l}});var r=n(37762),i=n(43144),a=n(15671),o=(n(59896),n(93169),n(92026)),s=(n(78952),n(41414)),u=n(65156),l=(n(58971),n(27823),n(83040),n(70178),(0,i.Z)((function e(t,n,r){(0,a.Z)(this,e),this.uid=t,this.geometry=n,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null})));function c(e){return(0,o.pC)(e.geometry)}var d=(0,i.Z)((function e(){(0,a.Z)(this,e),this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}));function h(e,t,n,r){return{x:e,y:t,z:n,hasZ:null!=n,hasM:!1,spatialReference:r,type:"point"}}function f(e){if((0,o.Wi)(e))return 0;switch(e.type){case"point":return 1;case"polyline":var t,n=0,i=(0,r.Z)(e.paths);try{for(i.s();!(t=i.n()).done;){n+=t.value.length}}catch(c){i.e(c)}finally{i.f()}return n;case"polygon":var a,s=0,u=(0,r.Z)(e.rings);try{for(u.s();!(a=u.n()).done;){s+=a.value.length}}catch(c){u.e(c)}finally{u.f()}return s;case"multipoint":return e.points.length;case"extent":return 2;case"mesh":var l=e.vertexAttributes&&e.vertexAttributes.position;return l?l.length/3:0;default:return}}function p(e,t){switch((0,s.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(var n=0;n<e.paths.length;n++)(0,s.Wi)(t,e.paths[n],e.hasZ);break;case"polygon":for(var r=0;r<e.rings.length;r++)(0,s.Wi)(t,e.rings[r],e.hasZ);break;case"multipoint":(0,s.Wi)(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function v(e,t){switch((0,u.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(var n=0;n<e.paths.length;n++)(0,u.Wi)(t,e.paths[n]);break;case"polygon":for(var r=0;r<e.rings.length;r++)(0,u.Wi)(t,e.rings[r]);break;case"multipoint":(0,u.Wi)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function g(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}(0,s.Ue)(),(0,u.Ue)()},37818:function(e,t,n){n.d(t,{Ou:function(){return c},WG:function(){return m},kB:function(){return f},mW:function(){return h}});var r=n(37762),i=n(52639),a=(n(93169),n(84652)),o=n(92026),s=n(18722),u=n(77981),l=n(65618);function c(e){return"declaredClass"in e}function d(e){return"declaredClass"in e}function h(e,t){if(!e)return null;if(function(e){return"declaredClass"in e}(e))return e;var n=new i.Z({layer:t,sourceLayer:t});return n.visible=e.visible,n.symbol=(0,a.d9)(e.symbol),n.attributes=(0,a.d9)(e.attributes),n.geometry=f(e.geometry),n}function f(e){return(0,o.Wi)(e)?null:c(e)?e:(0,u.im)(function(e){var t=e.spatialReference.toJSON();switch(e.type){case"point":return{x:e.x,y:e.y,z:e.z,m:e.m,spatialReference:t};case"polygon":var n=e.rings,r=e.hasZ,i=e.hasM;return{rings:p(n),hasZ:r,hasM:i,spatialReference:t};case"polyline":var a=e.paths,o=e.hasZ,s=e.hasM;return{paths:p(a),hasZ:o,hasM:s,spatialReference:t};case"extent":return{xmin:e.xmin,xmax:e.xmax,ymin:e.ymin,ymax:e.ymax,zmin:e.zmin,zmax:e.zmax,mmin:e.mmin,mmax:e.mmax,hasZ:e.hasZ,hasM:e.hasM,spatialReference:t};case"multipoint":var u=e.points,l=e.hasZ,c=e.hasM;return{points:g(u)?v(u):u,hasZ:l,hasM:c,spatialReference:t};default:return}}(e))}function p(e){return function(e){var t,n=(0,r.Z)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(0!==i.length)return g(i)}}catch(a){n.e(a)}finally{n.f()}return!1}(e)?e.map((function(e){return v(e)})):e}function v(e){return e.map((function(e){return(0,s.qo)(e)}))}function g(e){return e.length&&((0,s.xZ)(e[0])||(0,s.fS)(e[0]))}function m(e,t){if(!e)return null;var n;if(d(e)){if(null==t)return e.clone();if(d(t))return t.copy(e)}return null!=t?((n=t).x=e.x,n.y=e.y,n.spatialReference=e.spatialReference,e.hasZ?(n.z=e.z,n.hasZ=e.hasZ):(n.z=null,n.hasZ=!1),e.hasM?(n.m=e.m,n.hasM=!0):(n.m=null,n.hasM=!1)):(n=(0,l.Tx)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(n.m=e.m,n.hasM=!0)),n}},91226:function(e,t,n){n.d(t,{co:function(){return i},yl:function(){return c}});var r,i,a,o=n(43144),s=n(15671),u=n(81949),l=n(71353),c=(0,o.Z)((function e(){(0,s.Z)(this,e),this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,l.c)(),this.parallax={anchorPointClouds:(0,l.c)(),cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:(0,u.c)()},this.parallaxNew={anchorPointClouds:(0,l.c)(),cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:(0,u.c)()},this.crossFade={enabled:!1,factor:0,distanceThresholdFactor:.3},this.fadeInOut={stage:i.FINISHED,factor:0,distanceThresholdFactor:.6},this.fadeIn={stage:r.FINISHED,factor:0,distanceThresholdFactor:2},this.fadeInOutHeight={stage:a.FINISHED,factor:-1}}));!function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(r||(r={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.SWITCH=2]="SWITCH",e[e.FADE_IN=3]="FADE_IN"}(i||(i={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(a||(a={}))},78935:function(e,t,n){n.d(t,{o:function(){return u}});var r=n(15671),i=n(43144),a=n(92026),o=n(88152),s=n(8821),u=function(){function e(){(0,r.Z)(this,e),this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}return(0,i.Z)(e,[{key:"featureExpressionInfoContext",get:function(){return this._featureExpressionInfoContext}},{key:"meterUnitOffset",get:function(){return this._meterUnitOffset}},{key:"unit",get:function(){return this._unit},set:function(e){this._unit=e,this._metersPerElevationInfoUnit=(0,o.Z7)(e)}},{key:"requiresSampledElevationInfo",get:function(){return"absolute-height"!==this.mode}},{key:"reset",value:function(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}},{key:"offsetMeters",set:function(e){this._meterUnitOffset=e,this._renderUnitOffset=0}},{key:"offsetElevationInfoUnits",set:function(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}},{key:"addOffsetRenderUnits",value:function(e){this._renderUnitOffset+=e}},{key:"geometryZWithOffset",value:function(e,t){var n=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?n:e+n}},{key:"calculateOffsetRenderUnits",value:function(e){var t=this._meterUnitOffset,n=this.featureExpressionInfoContext;return null!=n&&(t+=(0,s.ht)(n)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}},{key:"setFromElevationInfo",value:function(e){this.mode=e.mode,this.unit=(0,o.lt)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=(0,a.Pt)(e.offset,0)}},{key:"updateFeatureExpressionInfoContext",value:function(e,t,n){if((0,a.Wi)(e))this._featureExpressionInfoContext=null;else{var r=e&&e.arcade;r&&(0,a.pC)(t)&&(0,a.pC)(n)?(this._featureExpressionInfoContext=(0,s.d9)(e),(0,s.aO)(this._featureExpressionInfoContext,(0,s.Tz)(r.modules,t,n))):this._featureExpressionInfoContext=e}}}],[{key:"fromElevationInfo",value:function(t){var n=new e;return(0,a.pC)(t)&&n.setFromElevationInfo(t),n}}]),e}()},61310:function(e,t,n){n.d(t,{ZF:function(){return i},a1:function(){return o},rD:function(){return a}});var r=n(67077),i=1.2,a=r.Z,o=r.O},69691:function(e,t,n){n.d(t,{B5:function(){return _},GC:function(){return m},Lm:function(){return S},Xf:function(){return y},bD:function(){return T},lO:function(){return x},qZ:function(){return v},rR:function(){return p},w7:function(){return g}});var r=n(43144),i=n(15671),a=n(41644),o=n(92026),s=n(14226),u=n(81949),l=n(71353),c=n(79803),d=n(81020),h=n(96387),f=n(77648);function p(e,t,n,r,i,a,o,s,u,l,d){var h,f,p=w[d.mode],v=0;if((0,c.CM)(e,t,n,r,u.spatialReference,i,s))return p.requiresAlignment(d)?(v=p.applyElevationAlignmentBuffer(r,i,a,o,s,u,l,d),h=a,f=o):(h=r,f=i),(0,c.CM)(h,u.spatialReference,f,a,l.spatialReference,o,s)?v:void 0}function v(e,t,n,r,i){var s=((0,d.f)(e)?e.z:(0,f.Fb)(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":var u=(0,o.Pt)((0,f.KO)(t,e,"ground"),0);return i.verticalDistanceToGround=0,i.sampledElevation=u,void(i.z=u);case"relative-to-ground":var l=(0,o.Pt)((0,f.KO)(t,e,"ground"),0),c=n.geometryZWithOffset(s,r);return i.verticalDistanceToGround=c,i.sampledElevation=l,void(i.z=c+l);case"relative-to-scene":var h=(0,o.Pt)((0,f.KO)(t,e,"scene"),0),p=n.geometryZWithOffset(s,r);return i.verticalDistanceToGround=p,i.sampledElevation=h,void(i.z=p+h);case"absolute-height":var v=n.geometryZWithOffset(s,r),g=(0,o.Pt)((0,f.KO)(t,e,"ground"),0);return i.verticalDistanceToGround=v-g,i.sampledElevation=g,void(i.z=v);default:return(0,a.Bg)(n.mode),void(i.z=0)}}function g(e,t,n,r){return v(e,t,n,r,C),C.z}function m(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?x.UPDATE:e.onTheGroundChanged}function y(e){return"relative-to-ground"===e||"relative-to-scene"===e}function _(e){return"absolute-height"!==e}function T(e,t,n,r,i){v(t,n,i,r,C),(0,h.CV)(e,C.verticalDistanceToGround);var a=C.sampledElevation,o=(0,s.c)(O,e.transformation);return b[0]=t.x,b[1]=t.y,b[2]=C.z,(0,c.Bm)(t.spatialReference,b,o,r.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}var x,S=(0,r.Z)((function e(){(0,i.Z)(this,e),this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}));!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(x||(x={}));var w={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,n,r,i,a,o,s){var u=s.calculateOffsetRenderUnits(o),l=s.featureExpressionInfoContext;t*=3,r*=3;for(var c=0;c<i;++c){var d=e[t+0],h=e[t+1],f=e[t+2];n[r+0]=d,n[r+1]=h,n[r+2]=null==l?f+u:u,t+=3,r+=3}return 0},requiresAlignment:function(e){var t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,n,r,i,a){var s=0,u=a.spatialReference;t*=3,r*=3;for(var l=0;l<i;++l){var c=e[t+0],d=e[t+1],h=e[t+2],f=(0,o.Pt)(a.getElevation(c,d,h,u,"ground"),0);s+=f,n[r+0]=c,n[r+1]=d,n[r+2]=f,t+=3,r+=3}return s/i},requiresAlignment:function(){return!0}},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,n,r,i,a,s,u){var l=0,c=u.calculateOffsetRenderUnits(s),d=u.featureExpressionInfoContext,h=a.spatialReference;t*=3,r*=3;for(var f=0;f<i;++f){var p=e[t+0],v=e[t+1],g=e[t+2],m=(0,o.Pt)(a.getElevation(p,v,g,h,"ground"),0);l+=m,n[r+0]=p,n[r+1]=v,n[r+2]=null==d?g+m+c:m+c,t+=3,r+=3}return l/i},requiresAlignment:function(){return!0}},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,n,r,i,a,s,u){var l=0,c=u.calculateOffsetRenderUnits(s),d=u.featureExpressionInfoContext,h=a.spatialReference;t*=3,r*=3;for(var f=0;f<i;++f){var p=e[t+0],v=e[t+1],g=e[t+2],m=(0,o.Pt)(a.getElevation(p,v,g,h,"scene"),0);l+=m,n[r+0]=p,n[r+1]=v,n[r+2]=null==d?g+m+c:m+c,t+=3,r+=3}return l/i},requiresAlignment:function(){return!0}}},O=(0,u.c)(),C=new S,b=(0,l.c)()},8821:function(e,t,n){n.d(t,{O$:function(){return g},Tz:function(){return h},WI:function(){return v},aO:function(){return f},d9:function(){return l},ht:function(){return p},kr:function(){return c}});var r=n(74165),i=n(15861),a=n(32718),o=n(37818),s=n(819),u=a.Z.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function l(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=(0,i.Z)((0,r.Z)().mark((function e(t,n,i){var a,o,u,l,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof(a=t&&t.expression)){e.next=3;break}return e.abrupt("return",null);case 3:if(null==(o=y(a))){e.next=6;break}return e.abrupt("return",{cachedResult:o});case 6:return e.next=8,(0,s.LC)();case 8:return u=e.sent,l=u.arcadeUtils,c=l.createSyntaxTree(a),e.abrupt("return",l.dependsOnView(c)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:l.createFunction(c),context:l.createExecContext(null,{sr:n}),modules:u}});case 12:case"end":return e.stop()}}),e)}))),d.apply(this,arguments)}function h(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function f(e,t){if(null!=e&&!m(e)){if(!t||!e.arcade)return void u.errorOncePerTick("Arcade support required but not provided");var n=t;n._geometry&&(n._geometry=(0,o.kB)(n._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function p(e){if(null!=e){if(m(e))return e.cachedResult;var t=e.arcade,n=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof n&&(e.cachedResult=0,n=0),n}return 0}function v(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e&&e.featureExpressionInfo,r=n&&n.expression;return t||"0"===r||(n=null),n}var g={cachedResult:0};function m(e){return null!=e.cachedResult}function y(e){return"0"===e?0:null}},96387:function(e,t,n){n.d(t,{CV:function(){return S},Go:function(){return x},Si:function(){return R},Uu:function(){return w},ZL:function(){return b},_Z:function(){return A},bD:function(){return O},bh:function(){return C},zE:function(){return y}});var r=n(37762),i=n(92026),a=n(14226),o=n(81949),s=n(71353),u=n(90045),l=n(67077),c=n(79803),d=n(41414),h=n(65156),f=n(4954),p=n(69662),v=n(65618),g=n(37818),m=n(4760);function y(e,t){if("point"===e.type)return T(e,t,!1);if((0,g.Ou)(e))switch(e.type){case"extent":return T(e.center,t,!1);case"polygon":return T(e.centroid,t,!1);case"polyline":return T(_(e),t,!0);case"mesh":return T(e.origin,t,!1)}else switch(e.type){case"extent":return T(function(e){var t=isFinite(e.zmin);return(0,v.Tx)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return T(function(e){var t=e.rings[0];if(!t||0===t.length)return null;var n=(0,f.a)(e.rings,e.hasZ);return(0,v.Tx)(n[0],n[1],n[2],e.spatialReference)}(e),t,!0);case"polyline":return T(_(e),t,!0)}}function _(e){var t=e.paths[0];if(!t||0===t.length)return null;var n=(0,p.n8)(t,(0,p.ok)(t)/2);return(0,v.Tx)(n[0],n[1],n[2],e.spatialReference)}function T(e,t,n){var r=n?e:(0,g.WG)(e);return t&&e?(0,c.nF)(e,r,t)?r:null:r}function x(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(e){t||(t=(0,h.Ue)());var i=e,a=.5*i.width*(n-1),o=.5*i.height*(n-1);return i.width<1e-7*i.height?a+=o/20:i.height<1e-7*i.width&&(o+=a/20),(0,u.s)(t,i.xmin-a-r,i.ymin-o-r,i.xmax+a+r,i.ymax+o+r),t}return null}function S(e,t){for(var n=0;n<e.geometries.length;++n){var r=e.geometries[n].getMutableAttribute(m.T.AUXPOS1);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[n]))}}function w(e,t){var n=(0,l.d)(l.O);return(0,i.pC)(e)&&(n[0]=e[0],n[1]=e[1],n[2]=e[2]),(0,i.pC)(t)?n[3]=t:(0,i.pC)(e)&&e.length>3&&(n[3]=e[3]),n}function O(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.O,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=new Array(3);if((0,i.Wi)(t)||(0,i.Wi)(n))a[0]=1,a[1]=1,a[2]=1;else{for(var o,u=0,l=2;l>=0;l--){var c=e[l],d=void 0,h=null!=c,f=0===l&&!o&&!h,p=n[l];"symbol-value"===c||f?d=0!==p?t[l]/p:1:h&&"proportional"!==c&&isFinite(c)&&(d=0!==p?c/p:1),null!=d&&(a[l]=d,o=d,u=Math.max(u,Math.abs(d)))}for(var v=2;v>=0;v--)null==a[v]?a[v]=o:0===a[v]&&(a[v]=.001*u)}for(var g=2;g>=0;g--)a[g]/=r;return(0,s.d)(a)}function C(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),b(e)?null:"Symbol sizes may not be negative values"}function b(e){if(Array.isArray(e)){var t,n=(0,r.Z)(e);try{for(n.s();!(t=n.n()).done;){if(!b(t.value))return!1}}catch(i){n.e(i)}finally{n.f()}return!0}return null==e||e>=0}function A(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,o.c)(),i=e||0,s=t||0,u=n||0;return 0!==i&&(0,a.g)(r,r,-i/180*Math.PI),0!==s&&(0,a.r)(r,r,s/180*Math.PI),0!==u&&(0,a.o)(r,r,u/180*Math.PI),r}function R(e,t){return null!=t.minDemResolution?t.minDemResolution:(0,d.wp)(e)?t.minDemResolutionForPoints:.01*(0,d.aO)(e)}},75558:function(e,t,n){n.d(t,{NW:function(){return r},VP:function(){return S},YU:function(){return x},rm:function(){return O},u9:function(){return A}});var r,i=n(37762),a=(n(93169),n(92026)),o=n(18722),s=n(88396),u=n(11186),l=n(71353),c=n(79803),d=n(92183),h=n(91320),f=n(50951),p=n(61310),v=n(69691),g=n(74720),m=n(68401),y=n(74894),_=n(4760),T=n(737);function x(e){var t=[],n=[];!function(e,t,n){for(var i=e.attributeData.position,a=e.removeDuplicateStartEnd,s=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&a===r.REMOVE,u=i.length/3-(s?1:0),l=new Uint32Array(2*(u-1)),c=s?(0,o.tP)(i,0,i.length-3):i,d=0,h=0;h<u-1;h++)l[d++]=h,l[d++]=h+1;t.push([_.T.POSITION,{size:3,data:c,exclusive:s}]),n.push([_.T.POSITION,l])}(e,n,t);var i=n[0][1].data,l=t[0][1].length,h=new Uint16Array(l);return function(e,t,n){var r=e.attributeData.mapPosition;(0,a.Wi)(r)||(n.push([_.T.MAPPOS,n[0][1]]),t.push([_.T.MAPPOS,{size:3,data:r}]))}(e,n,t),function(e,t,n,r){if((0,a.pC)(e.attributeData.colorFeature))return;var i=e.attributeData.color;t.push([_.T.COLOR,{size:4,data:(0,a.Pt)(i,p.a1)}]),n.push([_.T.COLOR,r])}(e,n,t,h),function(e,t,n,r){if((0,a.pC)(e.attributeData.sizeFeature))return;var i=e.attributeData.size;t.push([_.T.SIZE,{size:1,data:[(0,a.Pt)(i,1)]}]),n.push([_.T.SIZE,r])}(e,n,t,h),function(e,t,n,r){var i=e.attributeData.colorFeature;(0,a.Wi)(i)||(t.push([_.T.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([_.T.COLOR,r]))}(e,n,t,h),function(e,t,n,r){var i=e.attributeData.sizeFeature;(0,a.Wi)(i)||(t.push([_.T.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([_.T.SIZEFEATUREATTRIBUTE,r]))}(e,n,t,h),function(e,t,n,r){var i=e.attributeData.opacityFeature;(0,a.Wi)(i)||(t.push([_.T.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([_.T.OPACITYFEATUREATTRIBUTE,r]))}(e,n,t,h),function(e,t,n,r){if((0,a.Wi)(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==f.JY.Global||!e.overlayInfo.spatialReference.isGeographic)return;for(var i=new Float64Array(r.length),o=(0,d.Iu)(e.overlayInfo.spatialReference),l=0;l<i.length;l+=3)(0,c.gH)(r,l,i,l,o);var h=r.length/3,p=new Float32Array(h+1),v=C,g=b,m=0,y=0;(0,u.s)(v,i[y++],i[y++],i[y++]),p[0]=0;for(var T=1;T<h+1;++T){var x;T===h&&(y=0),(0,u.s)(g,i[y++],i[y++],i[y++]),m+=(0,s.d)(v,g),p[T]=m,v=(x=[g,v])[0],g=x[1]}t.push([_.T.DISTANCETOSTART,{size:1,data:p}]),n.push([_.T.DISTANCETOSTART,n[0][1]])}(e,n,t,i),new y.Z(n,t,m.MX.Line)}function S(e,t,n,r){var i="polygon"===e.type?h.ZI.CCW_IS_HOLE:h.ZI.NONE,a="polygon"===e.type?e.rings:e.paths,o=(0,h.Mk)(a,e.hasZ,i),s=o.position,u=o.outlines,l=new Float64Array(s.length),c=(0,v.rR)(s,e.spatialReference,0,l,0,s,0,s.length/3,t,n,r),d=null!=c;return{lines:d?w(u,s,l):[],projectionSuccess:d,sampledElevation:c}}function w(e,t,n){var r,a=new Array,o=(0,i.Z)(e);try{for(o.s();!(r=o.n()).done;){var s=r.value,u=s.index,l=s.count;if(!(l<=1)){var c=3*u,d=c+3*l;a.push({position:t.subarray(c,d),mapPosition:n?n.subarray(c,d):void 0})}}}catch(h){o.e(h)}finally{o.f()}return a}function O(e,t){for(var n="polygon"===e.type?h.ZI.CCW_IS_HOLE:h.ZI.NONE,r="polygon"===e.type?e.rings:e.paths,i=(0,h.Mk)(r,!1,n),a=i.position,o=i.outlines,s=(0,c.CM)(a,e.spatialReference,0,a,t,0,a.length/3),u=2;u<a.length;u+=3)a[u]=g.Rn;return{lines:s?w(o,a):[],projectionSuccess:s}}!function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"}(r||(r={}));var C=(0,l.c)(),b=(0,l.c)();function A(e){switch(e){case"butt":return T.R.BUTT;case"square":return T.R.SQUARE;case"round":return T.R.ROUND;default:return null}}},36759:function(e,t,n){n.d(t,{S_:function(){return g},VP:function(){return m},dO:function(){return v},km:function(){return p}});var r=n(92026),i=n(81949),a=n(71353),o=n(79803),s=n(41414),u=n(69662),l=n(65618),c=n(69691),d=n(96387),h=n(59887),f=(0,a.c)();function p(e,t,n,a,u,l,d,p){var v=n?n.length:0,g=e.clippingExtent;if((0,o.KC)(t,f,e.elevationProvider.spatialReference),(0,r.pC)(g)&&!(0,s.BD)(g,f))return null;(0,o.KC)(t,f,e.renderCoordsHelper.spatialReference);for(var m=e.localOriginFactory.getOrigin(f),y=new h.T({castShadow:!1,metadata:{layerUid:l,graphicUid:d,usesVerticalDistanceToGround:!0}}),_=0;_<v;_++){var T=i.I;y.addGeometry(n[_],a[_],T,m,p)}return{object:y,sampledElevation:(0,c.bD)(y,t,e.elevationProvider,e.renderCoordsHelper,u)}}function v(e,t,n){var r=e.elevationContext,i=n.spatialReference;(0,o.KC)(t,f,i),r.centerPointInElevationSR=(0,l.Tx)(f[0],f[1],t.hasZ?f[2]:0,i)}function g(e){switch(e.type){case"point":return e;case"polygon":case"extent":return(0,d.zE)(e);case"polyline":var t=e.paths[0];if(!t||0===t.length)return null;var n=(0,u.n8)(t,(0,u.ok)(t)/2);return(0,l.Tx)(n[0],n[1],n[2],e.spatialReference);case"mesh":return e.origin}return null}function m(e,t,n,r,i){var a=new Float64Array(3*e.length),o=new Float64Array(a.length);e.forEach((function(e,t){a[3*t+0]=e[0],a[3*t+1]=e[1],a[3*t+2]=e.length>2?e[2]:0}));var s=(0,c.rR)(a,t,0,o,0,a,0,a.length/3,n,r,i),u=null!=s;return{numVertices:e.length,position:a,mapPosition:o,projectionSuccess:u,sampledElevation:s}}},55360:function(e,t,n){n.d(t,{Ns:function(){return s},Ph:function(){return o},cU:function(){return u}});n(93169);var r=n(46228),i=n(76873),a=n(8548),o=128,s=.5;function u(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*s,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,u=l(e,t,n,r);return new i.x(u,{mipmap:!1,wrap:{s:a.e8.CLAMP_TO_EDGE,t:a.e8.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t*s,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(e){case"circle":default:return c(t,n);case"square":return d(t,n);case"cross":return f(t,n,r);case"x":return p(t,n,r);case"kite":return h(t,n);case"triangle":return v(t,n);case"arrow":return g(t,n)}}function c(e,t){var n=e/2-.5;return x(e,_(n,n,t/2))}function d(e,t){return m(e,t,!1)}function h(e,t){return m(e,t,!0)}function f(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return y(e,t,!1,n)}function p(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return y(e,t,!0,n)}function v(e,t){return x(e,T(e/2,t,t/2))}function g(e,t){var n=t,r=t/2,i=e/2,a=.8*n,o=_(i,(e-t)/2-a,Math.sqrt(a*a+r*r)),s=T(i,n,r);return x(e,(function(e,t){return Math.max(s(e,t),-o(e,t))}))}function m(e,t,n){return n&&(t/=Math.SQRT2),x(e,(function(r,i){var a=r-.5*e+.25,o=.5*e-i-.75;if(n){var s=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=s}return Math.max(Math.abs(a),Math.abs(o))-.5*t}))}function y(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t-=r,n&&(t*=Math.SQRT2);var i=.5*t;return x(e,(function(t,a){var o,s=t-.5*e,u=.5*e-a-1;if(n){var l=(s+u)/Math.SQRT2;u=(u-s)/Math.SQRT2,s=l}return o=(s=Math.abs(s))>(u=Math.abs(u))?s>i?Math.sqrt((s-i)*(s-i)+u*u):u:u>i?Math.sqrt(s*s+(u-i)*(u-i)):s,o-=r/2}))}function _(e,t,n){return function(r,i){var a=r-e,o=i-t;return Math.sqrt(a*a+o*o)-n}}function T(e,t,n){var r=Math.sqrt(t*t+n*n);return function(i,a){var o=Math.abs(i-e)-n,s=a-e+t/2+.75,u=(t*o+n*s)/r,l=-s;return Math.max(u,l)}}function x(e,t){for(var n=new Uint8Array(4*e*e),i=0;i<e;i++)for(var a=0;a<e;a++){var o=a+e*i,s=t(a,i);s=s/e+.5,(0,r.I)(s,n,4*o)}return n}},26279:function(e,t,n){var r,i;n.d(t,{L:function(){return r},a:function(){return i}}),function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(r||(r={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(i||(i={}))},77648:function(e,t,n){n.d(t,{Fb:function(){return u},KO:function(){return l},sb:function(){return s}});var r=n(43144),i=n(15671),a=n(92026),o=n(81020),s=(0,r.Z)((function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,i.Z)(this,e),this.array=t,this.spatialReference=n,this.offset=r}));function u(e){return"array"in e}function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"ground";if((0,o.f)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,n);if(u(t)){var r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,(0,a.Pt)(t.spatialReference,e.spatialReference),n)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,n)}},94463:function(e,t,n){n.d(t,{Z:function(){return h}});var r=n(43144),i=n(15671),a=n(60136),o=n(54062),s=n(27366),u=n(85015),l=n(49861),c=(n(63780),n(93169),n(25243),n(69912)),d=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,e.DECONFLICTOR_SHOW_VISIBLE=!1,e.DECONFLICTOR_SHOW_INVISIBLE=!1,e.DECONFLICTOR_SHOW_GRID=!1,e.LABELS_SHOW_BORDER=!1,e.TEXT_SHOW_BASELINE=!1,e.TEXT_SHOW_BORDER=!1,e.OVERLAY_DRAW_DEBUG_TEXTURE=!1,e.OVERLAY_SHOW_CENTER=!1,e.SHOW_POI=!1,e.TESTS_DISABLE_OPTIMIZATIONS=!1,e.TESTS_DISABLE_FAST_UPDATES=!1,e.DRAW_MESH_GEOMETRY_NORMALS=!1,e.FEATURE_TILE_FETCH_SHOW_TILES=!1,e.FEATURE_TILE_TREE_SHOW_TILES=!1,e.TERRAIN_TILE_TREE_SHOW_TILES=!1,e.I3S_TREE_SHOW_TILES=!1,e.I3S_SHOW_MODIFICATIONS=!1,e.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,e.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,e.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,e.LINE_WIREFRAMES=!1,e}return(0,r.Z)(n)}(u.Z);(0,s._)([(0,l.Cb)()],d.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"DECONFLICTOR_SHOW_GRID",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"LABELS_SHOW_BORDER",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"TEXT_SHOW_BASELINE",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"TEXT_SHOW_BORDER",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"OVERLAY_SHOW_CENTER",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"SHOW_POI",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"I3S_TREE_SHOW_TILES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"I3S_SHOW_MODIFICATIONS",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),(0,s._)([(0,l.Cb)()],d.prototype,"LINE_WIREFRAMES",void 0);var h=new(d=(0,s._)([(0,c.j)("esri.views.3d.support.DebugFlags")],d))},74720:function(e,t,n){n.d(t,{Rn:function(){return Rn}});var r,i,a,o,s,u,l=n(74165),c=n(15861),d=n(29439),h=n(37762),f=n(1413),p=n(15671),v=n(43144),g=n(60136),m=n(54062),y=n(27366),_=n(85015),T=n(91505),x=n(100),S=n(77427),w=n(92026),O=n(27546),C=n(94172),b=n(92377),A=n(49861),R=(n(63780),n(93169),n(25243),n(69912)),P=n(14226),E=n(71353),D=n(50951),I=n(26279),M=n(94463);!function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(r||(r={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(i||(i={})),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(a||(a={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(o||(o={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(s||(s={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(u||(u={}));var Z,H=n(16889),N=n(65156),L=n(68401),k=n(61403);!function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"}(Z||(Z={}));var F=function(){function e(t,n){(0,p.Z)(this,e),this.index=t,this.renderTargets=n,this._extent=(0,N.Ue)(),this.resolution=0,this.renderLocalOrigin=(0,k.al)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new z,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(n.renderTargets.length).fill(!1)}return(0,v.Z)(e,[{key:"extent",get:function(){return this._extent}},{key:"getValidTexture",value:function(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}},{key:"_needsColorWithoutRasterImage",get:function(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}},{key:"getColorTexture",value:function(e){var t=e===Z.ColorAndWater?this.renderTargets.getTarget(s.Color):e===Z.Highlight?this.renderTargets.getTarget(s.Highlight):this.renderTargets.getTarget(s.Occluded);return t?t.getTexture():null}},{key:"getColorTextureNoRasterImage",value:function(){return this._needsColorWithoutRasterImage?this.getValidTexture(s.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(s.Color):null}},{key:"getNormalTexture",value:function(e){var t=e===Z.ColorAndWater?this.renderTargets.getTarget(s.Water):null;return t?t.getTexture():null}},{key:"draw",value:function(e,t){var n,r=this.computeRenderTargetValidityBitfield(),i=(0,h.Z)(this.renderTargets.renderTargets);try{for(i.s();!(n=i.n()).done;){var a=n.value;a.type!==s.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[a.type]=e.drawTarget(this,a,t):this.validTargets[a.type]=!1}}catch(o){i.e(o)}finally{i.f()}return r^this.computeRenderTargetValidityBitfield()?L.Yg.CHANGED:L.Yg.UNCHANGED}},{key:"computeRenderTargetValidityBitfield",value:function(){var e=this.validTargets;return+e[s.Color]|+e[s.ColorNoRasterImage]<<1|+e[s.Highlight]<<2|+e[s.Water]<<3|+e[s.Occluded]<<4}},{key:"setupGeometryViewsCyclical",value:function(e){this.setupGeometryViewsDirect();var t=.001*e.range;if(this._extent[0]-t<=e.min){var n=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,N.cv)(this._extent,e.range,0,n)}if(this._extent[2]+t>=e.max){var r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,N.cv)(this._extent,-e.range,0,r)}}},{key:"setupGeometryViewsDirect",value:function(){this.canvasGeometries.numViews=1,(0,N.JG)(this.canvasGeometries.extents[0],this._extent)}},{key:"hasSomeSizedView",value:function(){for(var e=0;e<this.canvasGeometries.numViews;e++){var t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},{key:"applyViewport",value:function(e){e.setViewport(this.index===r.INNER?0:this.resolution,0,this.resolution,this.resolution)}}]),e}();var z=(0,v.Z)((function e(){(0,p.Z)(this,e),this.extents=[(0,N.Ue)(),(0,N.Ue)(),(0,N.Ue)()],this.numViews=0})),U=n(15245),V=n(8548),j=n(53634),W=function(){function e(t,n){(0,p.Z)(this,e),this.size=(0,U.c)(),this._fbo=null,this._fbo=new j.X(t,{colorTarget:V.Lm.TEXTURE,depthStencilTarget:V.OU.NONE},{target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,wrapMode:V.e8.CLAMP_TO_EDGE,samplingMode:V.cw.LINEAR_MIPMAP_LINEAR,hasMipmap:n,maxAnisotropy:8,width:0,height:0})}return(0,v.Z)(e,[{key:"dispose",value:function(){this._fbo=(0,w.O3)(this._fbo)}},{key:"getTexture",value:function(){return this._fbo?this._fbo.colorTexture:null}},{key:"isValid",value:function(){return null!==this._fbo}},{key:"resize",value:function(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}},{key:"bind",value:function(e){e.bindFramebuffer(this._fbo)}},{key:"generateMipMap",value:function(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}},{key:"disposeRenderTargetMemory",value:function(){var e;null===(e=this._fbo)||void 0===e||e.resize(0,0)}},{key:"gpuMemoryUsage",get:function(){var e,t;return null!==(e=null===(t=this._fbo)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0}}]),e}(),B=n(68198),G=function(){function e(t){(0,p.Z)(this,e);var n=function(e,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return{type:n,fbo:new W(t,r),renderPass:e,valid:!1,lastUsed:1/0}};this.renderTargets=[n(B.C.MATERIAL,s.Color),n(B.C.MATERIAL,s.ColorNoRasterImage),n(B.C.MATERIAL_HIGHLIGHT,s.Highlight,!1),n(B.C.MATERIAL_NORMAL,s.Water),n(B.C.MATERIAL,s.Occluded)]}return(0,v.Z)(e,[{key:"getTarget",value:function(e){return this.renderTargets[e].fbo}},{key:"dispose",value:function(){var e,t=(0,h.Z)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.dispose()}}catch(n){t.e(n)}finally{t.f()}}},{key:"disposeRenderTargetMemory",value:function(){var e,t=(0,h.Z)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.disposeRenderTargetMemory()}}catch(n){t.e(n)}finally{t.f()}}},{key:"validateUsageForTarget",value:function(e,t,n){if(e)t.lastUsed=n;else if(n-t.lastUsed>q)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}},{key:"gpuMemoryUsage",get:function(){return this.renderTargets.reduce((function(e,t){return e+t.fbo.gpuMemoryUsage}),0)}}]),e}(),q=1e3,X=n(59447),J=function(){function e(t){(0,p.Z)(this,e),this._context=t,this._perConstructorInstances=new X.r,this._frameCounter=0,this._keepAliveFrameCount=Q}return(0,v.Z)(e,[{key:"viewingMode",get:function(){return this._context.viewingMode}},{key:"constructionContext",get:function(){return this._context}},{key:"dispose",value:function(){this._perConstructorInstances.forEach((function(e){return e.forEach((function(e){return e.technique.destroy()}))})),this._perConstructorInstances.clear()}},{key:"acquire",value:function(e,t){var n=this,r=t.key,i=this._perConstructorInstances.get(e,r);if((0,w.Wi)(i)){var a=new e(this._context,t,(function(){return n.release(a)}));i=new Y(a),this._perConstructorInstances.set(e,r,i)}return++i.refCount,i.technique}},{key:"releaseAndAcquire",value:function(e,t,n){if((0,w.pC)(n)){if(t.key===n.key)return n;this.release(n)}return this.acquire(e,t)}},{key:"release",value:function(e){if(!(0,w.Wi)(e)&&!this._perConstructorInstances.empty){var t=this._perConstructorInstances.get(e.constructor,e.key);(0,w.Wi)(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}}},{key:"frameUpdate",value:function(){var e=this;this._frameCounter++,this._keepAliveFrameCount!==Q&&this._perConstructorInstances.forEach((function(t,n){t.forEach((function(t,r){0===t.refCount&&t.refZeroFrame+e._keepAliveFrameCount<e._frameCounter&&(t.technique.destroy(),e._perConstructorInstances.delete(n,r))}))}))}},{key:"reloadAll",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(){var t,n=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Array,this._perConstructorInstances.forEach((function(e,r){var i=function(){var e=(0,c.Z)((0,l.Z)().mark((function e(t,r){var i;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.shader,e.t0=i,!e.t0){e.next=6;break}return e.next=5,i.reload();case 5:t.forEach((function(e){e.technique.reload(n._context)}));case 6:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();t.push(i(e,r))})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),Y=(0,v.Z)((function e(t){(0,p.Z)(this,e),this.technique=t,this.refCount=0,this.refZeroFrame=0})),Q=-1,K=function(e){var t=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){var e;return(0,p.Z)(this,n),(e=t.apply(this,arguments))._isDisposed=!1,e}return(0,v.Z)(n,[{key:"dispose",value:function(){var e,t,n=(0,h.Z)(null!==(e=this._managedDisposables)&&void 0!==e?e:[]);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=this[r];this[r]=null,i&&"function"==typeof i.dispose&&i.dispose()}}catch(a){n.e(a)}finally{n.f()}this._isDisposed=!0}},{key:"isDisposed",get:function(){return this._isDisposed}}]),n}(e);return t};K(function(){return(0,v.Z)((function e(){(0,p.Z)(this,e)}))}());var $,ee=n(30425),te=n(32718),ne=n(97731),re=te.Z.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository"),ie=function(){function e(t,n,r,i){(0,p.Z)(this,e),this._textureRepository=t,this._techniqueRepository=n,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new X.r}return(0,v.Z)(e,[{key:"dispose",value:function(){this._textureRepository.dispose()}},{key:"acquire",value:function(e,t){this._ownMaterial(e);var n=this._id2glMaterialRef.get(t,e.id);if((0,w.Wi)(n)){var r=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:t});n=new ae(r),this._id2glMaterialRef.set(t,e.id,n)}return n.ref(),n.glMaterial}},{key:"release",value:function(e,t){var n=this._id2glMaterialRef.get(t,e.id);(0,w.pC)(n)&&(n.unref(),n.referenced||((0,w.O3)(n.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}},{key:"_ownMaterial",value:function(e){(0,w.pC)(e.repository)&&e.repository!==this&&re.error("Material is already owned by a different material repository"),e.repository=this}}]),e}(),ae=function(){function e(t){(0,p.Z)(this,e),this.glMaterial=t,this.refCnt=0}return(0,v.Z)(e,[{key:"ref",value:function(){++this.refCnt}},{key:"unref",value:function(){--this.refCnt,(0,ne.hu)(this.refCnt>=0)}},{key:"referenced",get:function(){return this.refCnt>0}}]),e}(),oe=n(32534),se=n(87145),ue=n(56529),le=n(6394),ce=n(91226),de=n(43565),he=n(15226),fe=n(40854),pe=n(93822),ve=n(48919),ge=function(){function e(t,n,r){(0,p.Z)(this,e),this.shadowMap=t,this.ssaoHelper=n,this.slicePlane=r,this.slot=pe.r.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this._inverseViewport=(0,le.a)(),this.lighting=new ve.c,this.ssr=new fe.O,this.multipassTerrain=new he.a,this.multipassGeometry=new de._,this.clouds=new ce.yl,this.overlays=[]}return(0,v.Z)(e,[{key:"camera",get:function(){return this._camera},set:function(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}},{key:"inverseViewport",get:function(){return this._inverseViewport}}]),e}(),me=function(){function e(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,p.Z)(this,e),this.rctx=t,this.sliceHelper=i,this.lastFrameCamera=new ee.V,this.pass=B.C.MATERIAL,this.renderOccludedMask=ye,this.bindParameters=new ge(n,r,(0,w.pC)(i)?i.plane:null)}return(0,v.Z)(e,[{key:"resetRenderOccludedMask",value:function(){this.renderOccludedMask=ye}},{key:"isHighlightPass",get:function(){return this.pass===B.C.MATERIAL_HIGHLIGHT}}]),e}(),ye=ue.yD.Occlude|ue.yD.OccludeAndTransparent|ue.yD.OccludeAndTransparentStencil,_e=n(11873),Te=n(81949),xe=n(88396),Se=n(11186),we=n(90045),Oe=n(67077),Ce=n(51378),be=n(3384);!function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}($||($={}));for(var Ae=(0,v.Z)((function e(){(0,p.Z)(this,e),this.camera=new ee.V,this.lightMat=(0,Te.c)()})),Re=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,p.Z)(this,e),this.rctx=t,this.viewingMode=n,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,Oe.c)(),this._cascades=[new Ae,new Ae,new Ae,new Ae],this.maxTextureSize=this.rctx.parameters.maxTextureSize,this.snapshotCount=r}return(0,v.Z)(e,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"cascadeDistances",get:function(){return(0,we.s)(this._usedCascadeDistances,this._cascadeDistances[0],this.numCascades>1?this._cascadeDistances[1]:1/0,this.numCascades>2?this._cascadeDistances[2]:1/0,this.numCascades>3?this._cascadeDistances[3]:1/0)}},{key:"dispose",value:function(){this._discardDepthTexture(),this._discardAllSnapshots()}},{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=(0,H.uZ)(Math.floor(e),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&(0,w.pC)(this._depthTexture)}},{key:"snapshotCount",get:function(){return this._snapshots.length},set:function(e){var t=this._snapshots.length;if(e>t){var n=e-t;this._snapshots.length=e;for(var r=0;r<n;++r)this._snapshots[t+r]=null}else if(e<this.snapshotCount){for(var i=t-e,a=0;a<i;++a)this._discardSnapshot(e+a);this._snapshots.length=e}}},{key:"getSnapshot",value:function(e){return this.enabled?this._snapshots[e]:null}},{key:"getCascades",value:function(){for(var e=0;e<this.numCascades;++e)We[e]=this._cascades[e];return We.length=this.numCascades,We}},{key:"start",value:function(e,t,n){(0,ne.hu)(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();var r=this._clampNearFar(n),i=r.near,a=r.far;this._computeCascadeDistances(a,i),this._setupMatrices(e,t);for(var o=e.viewMatrix,s=e.projectionMatrix,u=0;u<this.numCascades;++u)this._constructCascade(u,s,o,t);this.lastOrigin=null,this.clear()}},{key:"finish",value:function(e){(0,ne.hu)(this.enabled),this.rctx.bindFramebuffer(e)}},{key:"getShadowMapMatrices",value:function(e){if(!this.lastOrigin||!(0,Se.k)(e,this.lastOrigin)){this.lastOrigin=this.lastOrigin||(0,E.c)(),(0,Se.c)(this.lastOrigin,e);for(var t=0;t<this.numCascades;++t){(0,P.j)(Be,this._cascades[t].lightMat,e);for(var n=0;n<16;++n)Ge[16*t+n]=Be[n]}}return Ge}},{key:"takeCascadeSnapshotTo",value:function(e,t){(0,ne.hu)(this.enabled);var n=this._ensureSnapshot(t);this._bindFbo();var r=this.rctx,i=r.bindTexture(n,Ce.x.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(V.No.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),r.bindTexture(i,Ce.x.TEXTURE_UNIT_FOR_UPDATES)}},{key:"clear",value:function(){var e=this.rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(V.lk.COLOR_BUFFER_BIT|V.lk.DEPTH_BUFFER_BIT)}},{key:"_computeTextureSize",value:function(e,t){var n=.5*Math.log(e*e+t*t)*Math.LOG2E,r=Math.pow(2,Math.round(n+.35));return Math.min(this.maxTextureSize,2*r)}},{key:"_ensureDepthTexture",value:function(){if(!(0,w.pC)(this._depthTexture)||this._depthTexture.descriptor.width!==this._textureSize){this._discardDepthTexture();var e={target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,wrapMode:V.e8.CLAMP_TO_EDGE,samplingMode:V.cw.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new Ce.x(this.rctx,e),this._fbo=new j.X(this.rctx,{colorTarget:V.Lm.TEXTURE,depthStencilTarget:V.OU.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}}},{key:"_ensureSnapshot",value:function(e){var t=this._snapshots[e];if((0,w.pC)(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);var n={target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,wrapMode:V.e8.CLAMP_TO_EDGE,samplingMode:V.cw.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new Ce.x(this.rctx,n),this._snapshots[e]=t,t}},{key:"_discardDepthTexture",value:function(){this._fbo=(0,w.O3)(this._fbo),this._depthTexture=(0,w.O3)(this._depthTexture)}},{key:"_discardSnapshot",value:function(e){this._snapshots[e]=(0,w.O3)(this._snapshots[e])}},{key:"_discardAllSnapshots",value:function(){for(var e=0;e<this.snapshotCount;++e)this._discardSnapshot(e)}},{key:"_bindFbo",value:function(){var e=this.rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}},{key:"_constructCascade",value:function(e,t,n,r){var i=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],s=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),u=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);(0,ne.hu)(s<u);for(var l=0;l<8;++l){(0,we.s)(Ie,l%4==0||l%4==3?-1:1,l%4==0||l%4==1?-1:1,l<4?s:u,1),(0,we.t)(Me[l],Ie,De);for(var c=0;c<3;++c)Me[l][c]/=Me[l][3]}(0,Se.o)(je,Me[0]),(0,P.j)(Pe,Ve,je),i.camera.viewMatrix=Pe;for(var d=0;d<8;++d)(0,Se.m)(Me[d],Me[d],i.camera.viewMatrix);(0,Se.c)(He,Me[0]),(0,Se.c)(Ne,Me[0]);for(var h=1;h<8;++h)for(var f=0;f<3;++f)He[f]=Math.min(He[f],Me[h][f]),Ne[f]=Math.max(Ne[f],Me[h][f]);He[2]-=200,Ne[2]+=200,i.camera.near=-Ne[2],i.camera.far=-He[2],this.warp?this._constructTrapezoidalProjection(n,r,i):this._constructOrthogonalProjection(i),(0,P.m)(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);var p=this._textureSize/2;i.camera.viewport[0]=e%2==0?0:p,i.camera.viewport[1]=0===Math.floor(e/2)?0:p,i.camera.viewport[2]=p,i.camera.viewport[3]=p}},{key:"_constructOrthogonalProjection",value:function(e){(0,P.q)(e.camera.projectionMatrix,He[0],Ne[0],He[1],Ne[1],e.camera.near,e.camera.far)}},{key:"_constructTrapezoidalProjection",value:function(e,t,n){var r=1/Me[0][3],i=1/Me[4][3];(0,ne.hu)(r<i);var a=r+Math.sqrt(r*i),o=Math.sin((0,H.ZF)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));(function(e,t,n,r,i,a,o,s){(0,xe.a)(qe,0,0);for(var u=0;u<4;++u)(0,xe.b)(qe,qe,e[u]);(0,xe.f)(qe,qe,.25),(0,xe.a)(Xe,0,0);for(var l=4;l<8;++l)(0,xe.b)(Xe,Xe,e[l]);(0,xe.f)(Xe,Xe,.25),(0,xe.l)(Je[0],e[4],e[5],.5),(0,xe.l)(Je[1],e[5],e[6],.5),(0,xe.l)(Je[2],e[6],e[7],.5),(0,xe.l)(Je[3],e[7],e[4],.5);for(var c=0,d=(0,xe.s)(Je[0],qe),h=1;h<4;++h){var f=(0,xe.s)(Je[h],qe);f<d&&(d=f,c=h)}(0,xe.g)(Ye,Je[c],e[c+4]);var p,v,g=Ye[0];Ye[0]=-Ye[1],Ye[1]=g,(0,xe.g)(Qe,Xe,qe),(0,xe.h)(Qe,Ye)<0&&(0,xe.n)(Ye,Ye),(0,xe.l)(Ye,Ye,Qe,n),(0,xe.i)(Ye,Ye),p=v=(0,xe.h)((0,xe.g)(Ke,e[0],qe),Ye);for(var m=1;m<8;++m){var y=(0,xe.h)((0,xe.g)(Ke,e[m],qe),Ye);y<p?p=y:y>v&&(v=y)}(0,xe.c)(r,qe),(0,xe.f)(Ke,Ye,p-t),(0,xe.b)(r,r,Ke);for(var _=-1,T=1,x=0,S=0,w=0;w<8;++w){(0,xe.g)($e,e[w],r),(0,xe.i)($e,$e);var O=Ye[0]*$e[1]-Ye[1]*$e[0];O>0?O>_&&(_=O,x=w):O<T&&(T=O,S=w)}(0,ne.T)(_>0,"leftArea"),(0,ne.T)(T<0,"rightArea"),(0,xe.f)(et,Ye,p),(0,xe.b)(et,et,qe),(0,xe.f)(tt,Ye,v),(0,xe.b)(tt,tt,qe),nt[0]=-Ye[1],nt[1]=Ye[0];var C=(0,ne.ep)(r,e[S],tt,(0,xe.b)(Ke,tt,nt),1,i),b=(0,ne.ep)(r,e[x],tt,Ke,1,a),A=(0,ne.ep)(r,e[x],et,(0,xe.b)(Ke,et,nt),1,o),R=(0,ne.ep)(r,e[S],et,Ke,1,s);(0,ne.T)(C,"rayRay"),(0,ne.T)(b,"rayRay"),(0,ne.T)(A,"rayRay"),(0,ne.T)(R,"rayRay")})(Me,a/=o,o,Le,ke,Fe,ze,Ue),function(e,t,n,r,i){(0,xe.g)(ot,n,r),(0,xe.f)(ot,ot,.5),st[0]=ot[0],st[1]=ot[1],st[2]=0,st[3]=ot[1],st[4]=-ot[0],st[5]=0,st[6]=ot[0]*ot[0]+ot[1]*ot[1],st[7]=ot[0]*ot[1]-ot[1]*ot[0],st[8]=1,st[rt(0,2)]=-(0,xe.h)(at(st,0),e),st[rt(1,2)]=-(0,xe.h)(at(st,1),e);var a=(0,xe.h)(at(st,0),n)+st[rt(0,2)],o=(0,xe.h)(at(st,1),n)+st[rt(1,2)],s=(0,xe.h)(at(st,0),r)+st[rt(0,2)],u=(0,xe.h)(at(st,1),r)+st[rt(1,2)];a=-(a+s)/(o+u),st[rt(0,0)]+=st[rt(1,0)]*a,st[rt(0,1)]+=st[rt(1,1)]*a,st[rt(0,2)]+=st[rt(1,2)]*a,a=1/((0,xe.h)(at(st,0),n)+st[rt(0,2)]),o=1/((0,xe.h)(at(st,1),n)+st[rt(1,2)]),st[rt(0,0)]*=a,st[rt(0,1)]*=a,st[rt(0,2)]*=a,st[rt(1,0)]*=o,st[rt(1,1)]*=o,st[rt(1,2)]*=o,st[rt(2,0)]=st[rt(1,0)],st[rt(2,1)]=st[rt(1,1)],st[rt(2,2)]=st[rt(1,2)],st[rt(1,2)]+=1,a=(0,xe.h)(at(st,1),t)+st[rt(1,2)],o=(0,xe.h)(at(st,2),t)+st[rt(2,2)],s=(0,xe.h)(at(st,1),n)+st[rt(1,2)],u=(0,xe.h)(at(st,2),n)+st[rt(2,2)],a=-.5*(a/o+s/u),st[rt(1,0)]+=st[rt(2,0)]*a,st[rt(1,1)]+=st[rt(2,1)]*a,st[rt(1,2)]+=st[rt(2,2)]*a,a=(0,xe.h)(at(st,1),t)+st[rt(1,2)],o=(0,xe.h)(at(st,2),t)+st[rt(2,2)],s=-o/a,st[rt(1,0)]*=s,st[rt(1,1)]*=s,st[rt(1,2)]*=s,i[0]=st[0],i[1]=st[1],i[2]=0,i[3]=st[2],i[4]=st[3],i[5]=st[4],i[6]=0,i[7]=st[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=st[6],i[13]=st[7],i[14]=0,i[15]=st[8]}(Le,ke,ze,Ue,n.camera.projectionMatrix),n.camera.projectionMatrix[10]=2/(He[2]-Ne[2]),n.camera.projectionMatrix[14]=-(He[2]+Ne[2])/(He[2]-Ne[2])}},{key:"_setupMatrices",value:function(e,t){(0,P.m)(Ee,e.projectionMatrix,e.viewMatrix),(0,P.a)(De,Ee);var n=this.viewingMode===D.JY.Global?e.eye:(0,Se.s)(je,0,0,1);(0,P.n)(Ve,[0,0,0],[-t[0],-t[1],-t[2]],n)}},{key:"_clampNearFar",value:function(e){var t=e.near,n=e.far;return t<2&&(t=2),n<2&&(n=2),t>=n&&(t=2,n=4),{near:t,far:n}}},{key:"_computeCascadeDistances",value:function(e,t){this.numCascades=Math.min(1+Math.floor((0,ne.E6)(e/t,4)),this.maxNumCascades);for(var n=(e-t)/this.numCascades,r=Math.pow(e/t,1/this.numCascades),i=t,a=t,o=0;o<this.numCascades+1;++o)this._cascadeDistances[o]=(0,H.t7)(i,a,this.splitSchemeLambda),i*=r,a+=n}},{key:"gpuMemoryUsage",get:function(){var e,t;return this._snapshots.reduce((function(e,t){return e+(0,be.un)(t)}),null!==(e=null===(t=this._fbo)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0)}},{key:"test",get:function(){var e=this;return{maxNumCascades:this.maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}}}]),e}(),Pe=(0,Te.c)(),Ee=(0,Te.c)(),De=(0,Te.c)(),Ie=(0,Oe.c)(),Me=[],Ze=0;Ze<8;++Ze)Me.push((0,Oe.c)());var He=(0,E.c)(),Ne=(0,E.c)(),Le=(0,le.a)(),ke=(0,le.a)(),Fe=(0,le.a)(),ze=(0,le.a)(),Ue=(0,le.a)(),Ve=(0,Te.c)(),je=(0,E.c)(),We=[],Be=(0,Te.c)(),Ge=new Float32Array(64),qe=(0,le.a)(),Xe=(0,le.a)(),Je=[(0,le.a)(),(0,le.a)(),(0,le.a)(),(0,le.a)()],Ye=(0,le.a)(),Qe=(0,le.a)(),Ke=(0,le.a)(),$e=(0,le.a)(),et=(0,le.a)(),tt=(0,le.a)(),nt=(0,le.a)();function rt(e,t){return 3*t+e}var it=(0,le.a)();function at(e,t){return(0,xe.a)(it,e[t],e[t+3]),it}var ot=(0,le.a)(),st=(0,_e.c)();var ut=function(){function e(){(0,p.Z)(this,e),this.adds=new O.Z,this.removes=new O.Z,this.updates=new O.Z({allocator:function(e){return e||new lt},deallocator:function(e){return e.renderGeometry=null,e}})}return(0,v.Z)(e,[{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.updates.clear()}},{key:"prune",value:function(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}]),e}(),lt=(0,v.Z)((function e(){(0,p.Z)(this,e)})),ct=(0,v.Z)((function e(){(0,p.Z)(this,e),this.adds=new Array,this.removes=new Array,this.updates=new Array})),dt=n(81268),ht=n(54463),ft=n(78289);function pt(e){return e.data.indexCount>=1}var vt=n(50256),gt=n(94425),mt=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,E.c)();return(0,p.Z)(this,n),(e=t.call(this)).origin=r,e.slicePlaneLocalOrigin=e.origin,e}return(0,v.Z)(n)}(n(85380).Pf),yt=n(47475),_t=(0,v.Z)((function e(t){(0,p.Z)(this,e),this.first=t.from,this.count=t.to-t.from})),Tt=(0,v.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,p.Z)(this,e),this.from=t,this.to=n})),xt=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(e,r,i,a,o,s){var u;return(0,p.Z)(this,n),(u=t.call(this,r,i)).id=e,u.isVisible=a,u.hasHighlights=o,u.hasOccludees=s,u}return(0,v.Z)(n)}(Tt);function St(e){return Array.from(e.values()).sort(wt)}function wt(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function Ot(e,t){if(0!==e.length){var n=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(n,t)){var r=t.from-n.first+t.to-t.from;n.count=r}else e.push(new _t(t))}else e.push(new _t(t))}var Ct=function(){function e(t,n){(0,p.Z)(this,e),this._pool=t,this._size=0,this._buffer=t.newBuffer(bt(n))}return(0,v.Z)(e,[{key:"dispose",value:function(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}},{key:"release",value:function(){this.erase(0,this._size),this.dispose()}},{key:"vao",get:function(){return this._buffer.vao}},{key:"array",get:function(){return this._buffer.array}},{key:"size",get:function(){return this._size}},{key:"grow",value:function(e){this._resize(this._size+e,!0).dispose()}},{key:"alloc",value:function(e){return this._resize(e,!1)}},{key:"_resize",value:function(e,t){var n,r=this,i=function(e,t,n){return t<=n?e>=n?e:bt(Math.max(2*e,n)):e<=2*n?e:bt(n)}(this._buffer.length,this._size,e);if(this._buffer.length!==i){var a=this._pool.newBuffer(i);t&&(a.array.set(this._buffer.array.subarray(0,Math.min(this._size,i))),a.vao.vertexBuffers.geometry.setSubData(a.array,0,0,a.array.byteLength)),n=this._buffer,this._buffer=a}var o=this._size;return this._size=e,n?{dispose:function(){n.array.fill(0,0,o),r._pool.deleteBuffer(n)},copy:function(e,t,i){return r._buffer.array.set(n.array.subarray(t,i),e)},hasNewBuffer:!0}:{dispose:function(){},copy:function(e,t,n){e!==t&&r._buffer.array.copyWithin(e,t,n)},hasNewBuffer:!1}}},{key:"erase",value:function(e,t){this._buffer.array.fill(0,e,t)}}]),e}();function bt(e){return 65536*Math.ceil(e/65536)}var At=n(18759),Rt=n(95439),Pt=n(44070),Et=n(45412),Dt=function(){function e(t,n,r,i){(0,p.Z)(this,e),this.vao=new Et.U(t,n,{geometry:r},{geometry:Pt.f.createVertex(t,V.l1.STATIC_DRAW)}),this.array=new Float32Array(i),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}return(0,v.Z)(e,[{key:"dispose",value:function(){this.vao.dispose(!0)}},{key:"length",get:function(){return this.array.length}}]),e}(),It=At.an+1,Mt=function(){function e(t,n,r){(0,p.Z)(this,e),this._rctx=t,this._locations=n,this._layout=r,this._cache=t.newCache("MergedRenderer pool ".concat((0,Rt.D)()),Zt)}return(0,v.Z)(e,[{key:"dispose",value:function(){this._cache.destroy()}},{key:"newBuffer",value:function(e){var t=e.toString(),n=this._cache.pop(t);if((0,w.pC)(n)){var r=n.pop();return n.length>0&&this._cache.put(t,n,r.array.byteLength*n.length,It),r}return new Dt(this._rctx,this._locations,this._layout,e)}},{key:"deleteBuffer",value:function(e){var t=e.array.byteLength,n=e.array.length.toString(),r=this._cache.pop(n);return(0,w.pC)(r)?(r.push(e),this._cache.put(n,r,t*r.length,-1)):this._cache.put(n,[e],t,-1),null}}]),e}();function Zt(e,t){if(t!==At.lN.ALL){var n=e.pop(),r=e.length*n.array.byteLength;return n.dispose(),r}e.forEach((function(e){return e.dispose()}))}var Ht=n(32683),Nt=function(){function e(t,n,r){(0,p.Z)(this,e),this._rctx=t,this._materialRepository=n,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new O.Z,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new gt.p(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new Mt(t,r.vertexAttributeLocations,(0,vt.K)(this._bufferWriter.vertexBufferLayout))}return(0,v.Z)(e,[{key:"dispose",value:function(){this._glMaterials.destroy(),this._dataByOrigin.forEach((function(e){return e.buffer.dispose()})),this._dataByOrigin.clear(),this._bufferPool.dispose()}},{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof yt.H}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==ue.yD.Occlude}},{key:"modify",value:function(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateRenderCommands()}},{key:"_addAndRemoveGeometries",value:function(e,t){var n=this,r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,a=this._dataByOrigin,o=function(e,t){var n,r=new Map,i=(0,h.Z)(e);try{for(i.s();!(n=i.n()).done;){kt(r,n.value,!0)}}catch(s){i.e(s)}finally{i.f()}var a,o=(0,h.Z)(t);try{for(o.s();!(a=o.n()).done;){kt(r,a.value,!1)}}catch(s){o.e(s)}finally{o.f()}return r}(e,t);o.forEach((function(e,t){o.delete(t);var s=e.toAdd.reduce((function(e,t){return e+r.elementCount(t.data)}),0),u=a.get(t);if(null==u)(0,ne.hu)(0===e.toRemove.length),u=new Vt(e.origin,new Ct(n._bufferPool,s*i)),a.set(t,u);else if(0===e.toAdd.length&&u.instances.size===e.toRemove.length)return u.buffer.dispose(),void a.delete(t);var l=0;u.instances.forEach((function(e){return l+=e.to-e.from}));var c=e.toRemove.reduce((function(e,t){return e+r.elementCount(t.data)}),0),d=u.buffer.size,h=(l+s-c)*i,f=Wt;if(h<d/2?n._removeAndRebuild(u,e.toRemove,i,h,f):e.toRemove.length>0&&n._remove(u,e.toRemove,i,f),e.toAdd.length>0){var p=Bt;(0,ne.u_)(p,-e.origin[0],-e.origin[1],-e.origin[2]),n._add(u,e.toAdd,i,p,f)}var v=u.buffer.vao.vertexBuffers.geometry;Ut(f),f.forAll((function(e){var t=e.from,n=e.to;if(t<n){var r=u.buffer.array,i=4*t,a=4*n;v.setSubData(r,i,i,a)}})),f.clear(),u.drawCommandsDirty=!0}))}},{key:"_updateGeometries",value:function(e){var t,n=this._bufferWriter,r=n.vertexBufferLayout.stride/4,i=(0,h.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=a.renderGeometry,s=this._dataByOrigin.get(o.origin.id),u=s&&s.instances.get(o.id);if(!u)return;var l=a.updateType;if(l&ft.$.State.VISIBILITIES&&(u.isVisible=o.instanceParameters.visible),l&(ft.$.State.HIGHLIGHTS|ft.$.State.VISIBILITIES)){var c=o.instanceParameters.visible;u.hasHighlights=!!o.instanceParameters.highlights&&c}if(l&ft.$.State.OCCLUDEES&&(u.hasOccludees=!!o.instanceParameters.occludees),l&(ft.$.State.VERTEXATTRS|ft.$.State.TRANSFORMATION)){var d=s.buffer,f=d.array,p=d.vao;(0,Ht.bZ)(o,Gt,qt),n.write({transformation:Gt,invTranspTransformation:qt},o.data,n.vertexBufferLayout.createView(f.buffer),u.from),(0,ne.hu)(u.from+n.elementCount(o.data)===u.to,"material VBO layout has changed"),p.vertexBuffers.geometry.setSubData(f,u.from*r*4,u.from*r*4,u.to*r*4)}s.drawCommandsDirty=!0}}catch(v){i.e(v)}finally{i.f()}}},{key:"_updateRenderCommands",value:function(){var e=this;this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((function(t){t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,(0,S.oE)(t.instances,(function(n){return n.isVisible?(n.hasHighlights&&(e._hasHighlights=!0,t.hasHighlights=!0),n.hasOccludees&&(e._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees}))}));this._dataByOrigin.forEach((function(t){t.drawCommandsDirty&&(function(t){if(t.drawCommandsDefault=null,t.drawCommandsHighlight=null,t.drawCommandsOccludees=null,t.drawCommandsShadowHighlightRest=null,0!==t.instances.size)if(Ft(t)){var n=St(t.instances);t.drawCommandsDefault=[],t.drawCommandsHighlight=[],t.drawCommandsOccludees=[],t.drawCommandsShadowHighlightRest=[];var r,i=(0,h.Z)(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.isVisible&&(a.hasOccludees?Ot(t.drawCommandsOccludees,a):Ot(t.drawCommandsDefault,a),a.hasHighlights?Ot(t.drawCommandsHighlight,a):Ot(t.drawCommandsShadowHighlightRest,a))}}catch(u){i.e(u)}finally{i.f()}}else{var o=e._bufferWriter.vertexBufferLayout.stride,s=4*t.buffer.size/o;t.drawCommandsDefault=[{first:0,count:s}]}}(t),t.drawCommandsDirty=!1)}))}},{key:"updateAnimation",value:function(e){return this._material.update(e)}},{key:"requiresSlot",value:function(e,t){return null==e||this._material.requiresSlot(e,t)}},{key:"render",value:function(e,t){var n=this;if(!this.requiresSlot(t.slot,e))return!1;var r=e===B.C.MATERIAL_HIGHLIGHT||e===B.C.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(r&&!this._hasHighlights)return!1;var i=e===B.C.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,a=!(r||i);if(this._dataByOrigin.forEach((function(e){if(!r||e.hasHighlights){var t=(r?e.drawCommandsHighlight:i&&Ft(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,o=a&&e.drawCommandsOccludees||null;((0,w.pC)(t)||(0,w.pC)(o))&&n._renderCommandData.push(new jt(e.origin,e.buffer,t,o))}})),0===this._renderCommandData.length)return!1;var o=this._rctx,s=this._glMaterials.load(o,e);if((0,w.Wi)(s))return this._renderCommandData.clear(),!1;var u=s.beginSlot(t);return o.bindTechnique(u,this._material.parameters,t,!1),this._renderCommandData.forAll((function(e){u.bindDraw(e,t);var r=e.buffer,i=e.renderCommands,a=e.occludeeCommands;u.ensureAttributeLocations(r.vao),o.bindVAO(r.vao);var s=u.primitiveType;(0,w.pC)(i)&&n._renderCommands(o,s,i),(0,w.pC)(a)&&(u.bindPipelineState(o,t.slot,!0),n._renderCommands(o,s,a),u.bindPipelineState(o,t.slot,!1))})),this._renderCommandData.clear(),!0}},{key:"_renderCommands",value:function(e,t,n){for(var r=0;r<n.length;r++)e.drawArrays(t,n[r].first,n[r].count)}},{key:"_removeAndRebuild",value:function(e,t,n,r,i){var a,o=(0,h.Z)(t);try{for(o.s();!(a=o.n()).done;){var s=a.value;e.instances.delete(s.id)}}catch(y){o.e(y)}finally{o.f()}var u=St(e.instances);e.instances.clear();var l,c=e.buffer.size,d=e.buffer.alloc(r),f=0,p=(0,h.Z)(u);try{for(p.s();!(l=p.n()).done;){var v=l.value,g=v.from*n,m=v.to*n;d.copy(f,g,m),v.from=f/n,f+=m-g,v.to=f/n,e.instances.set(v.id,v)}}catch(y){p.e(y)}finally{p.f()}i.push(new Tt(0,d.hasNewBuffer?e.buffer.array.length:c)),d.dispose(),e.buffer.erase(f,i.back().to),e.holes.clear()}},{key:"_remove",value:function(e,t,n,r){var i,a=(0,h.Z)(t);try{for(a.s();!(i=a.n()).done;){var o=i.value.id,s=e.instances.get(o),u=s.from*n,l=s.to*n;e.buffer.erase(u,l),e.holes.push(new Tt(s.from,s.to)),e.instances.delete(o),r.push(new Tt(u,l))}}catch(c){a.e(c)}finally{a.f()}Ut(e.holes)}},{key:"_add",value:function(e,t,n,r,i){if(0!==t.length){var a,o=this._bufferWriter,s=o.vertexBufferLayout.createView(e.buffer.array.buffer),u=e.holes.length>0,l=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER,d=(0,h.Z)(t);try{for(d.s();!(a=d.n()).done;){var f=a.value,p=(0,w.pC)(f.transformation)?(0,P.m)(Gt,r,f.transformation):r;(0,P.a)(qt,p);var v=(0,P.t)(qt,qt),g=o.elementCount(f.data),m=g*n,y=zt(e.holes,g);(0,w.Wi)(y)&&(y=e.buffer.size/n,e.buffer.grow(m),s=o.vertexBufferLayout.createView(e.buffer.array.buffer)),o.write({transformation:p,invTranspTransformation:v},f.data,s,y);var _=f.instanceParameters.visible,T=!!f.instanceParameters.highlights&&_,x=!!f.instanceParameters.occludees,S=new xt(f.id,y,y+g,_,T,x);(0,ne.hu)(null==e.instances.get(f.id)),e.instances.set(f.id,S),u?i.push(new Tt(S.from*n,S.to*n)):(l=Math.min(S.from,l),c=Math.max(S.to,c))}}catch(O){d.e(O)}finally{d.f()}u||i.push(new Tt(l*n,c*n))}}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]),e}(),Lt=(0,v.Z)((function e(t){(0,p.Z)(this,e),this.origin=t,this.toAdd=new Array,this.toRemove=new Array}));function kt(e,t,n){var r=t.origin;if(!(0,w.Wi)(r)){var i=e.get(r.id);null==i&&(i=new Lt(r.vec3),e.set(r.id,i)),n?i.toAdd.push(t):i.toRemove.push(t)}}function Ft(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function zt(e,t){var n;if(!e.some((function(e){return!(e.to-e.from<t)&&(n=e,!0)})))return null;var r=n.from;return n.from+=t,n.from>=n.to&&e.removeUnordered(n),r}function Ut(e){var t=new Map;e.forAll((function(e){return t.set(e.from,e)}));for(var n=!0;n;)n=!1,e.forEach((function(r){var i=t.get(r.to);i&&(r.to=i.to,t.delete(i.from),e.removeUnordered(i),n=!0)}))}var Vt=(0,v.Z)((function e(t,n){(0,p.Z)(this,e),this.origin=t,this.buffer=n,this.instances=new Map,this.holes=new O.Z({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1})),jt=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(e,r,i,a){var o;return(0,p.Z)(this,n),(o=t.call(this,e)).buffer=r,o.renderCommands=i,o.occludeeCommands=a,o}return(0,v.Z)(n)}(mt),Wt=new O.Z({deallocator:null}),Bt=(0,Te.c)(),Gt=(0,Te.c)(),qt=(0,Te.c)(),Xt=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(e){var r;return(0,p.Z)(this,n),(r=t.call(this,e))._pending=new Jt,r._changes=new ut,r._materialRenderers=new Map,r._sortedMaterialRenderers=new O.Z,r._geometries=new Map,r._hasHighlights=!1,r._hasWater=!1,r}return(0,v.Z)(n,[{key:"destroy",value:function(){this._changes.prune(),this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}},{key:"updating",get:function(){return!this._pending.empty||this._changes.updates.length>0}},{key:"rctx",get:function(){return this.rendererContext.rctx}},{key:"_materialRepository",get:function(){return this.rendererContext.materialRepository}},{key:"_localOriginFactory",get:function(){return this.rendererContext.localOriginFactory}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return(0,S.oE)(this._materialRenderers,(function(e){return e.rendersOccluded}))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}},{key:"commitChanges",value:function(){var e=this;if(!this.updating)return!1;this._processAddsRemoves();var t=function(e){var t=new Map,n=function(e){var n=t.get(e);return n||(n=new ct,t.set(e,n)),n};return e.removes.forAll((function(e){pt(e)&&n(e.material).removes.push(e)})),e.adds.forAll((function(e){pt(e)&&n(e.material).adds.push(e)})),e.updates.forAll((function(e){pt(e.renderGeometry)&&n(e.renderGeometry.material).updates.push(e)})),t}(this._changes),n=!1,r=!1,i=!1;return t.forEach((function(t,a){var o=e._materialRenderers.get(a);if(!o&&t.adds.length>0&&(o=new Nt(e.rctx,e._materialRepository,a),e._materialRenderers.set(a,o),n=!0,r=!0,i=!0),o){var s=r||o.hasHighlights,u=i||o.hasWater;o.modify(t),r=r||s!==o.hasHighlights,i=i||u!==o.hasWater,o.isEmpty&&(e._materialRenderers.delete(a),o.dispose(),n=!0)}})),this._changes.clear(),n&&this._updateSortedMaterialRenderers(),r&&(this._hasHighlights=(0,S.oE)(this._materialRenderers,(function(e){return e.hasHighlights}))),i&&(this._hasWater=(0,S.oE)(this._materialRenderers,(function(e){return e.hasWater}))),this.notifyChange("updating"),!0}},{key:"addGeometries",value:function(e,t){if(0!==e.length){var n,r=this._validateRenderGeometries(e),i=(0,h.Z)(r);try{for(i.s();!(n=i.n()).done;){var a=n.value;this._geometries.set(a.id,a)}}catch(c){i.e(c)}finally{i.f()}var o,s=this._pending.empty,u=(0,h.Z)(r);try{for(u.s();!(o=u.n()).done;){var l=o.value;this._pending.adds.add(l)}}catch(c){u.e(c)}finally{u.f()}s&&this.notifyChange("updating"),t===ft.$.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e)}}},{key:"removeGeometries",value:function(e,t){var n,r=this._pending.empty,i=this._pending.adds,a=(0,h.Z)(e);try{for(a.s();!(n=a.n()).done;){var o=n.value;i.has(o)?(this._pending.removed.add(o),i.delete(o)):this._pending.removed.has(o)||this._pending.removes.add(o),this._geometries.delete((0,w.Wg)(o.id))}}catch(s){a.e(s)}finally{a.f()}r&&!this._pending.empty&&this.notifyChange("updating"),t===ft.$.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e)}},{key:"modifyGeometries",value:function(e,t){var n,r=0===this._changes.updates.length,i=(0,h.Z)(e);try{for(i.s();!(n=i.n()).done;){var a=n.value,o=this._changes.updates.pushNew();o.renderGeometry=this._validateRenderGeometry(a),o.updateType=t}}catch(s){i.e(s)}finally{i.f()}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case ft.$.State.TRANSFORMATION:case ft.$.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e);case ft.$.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e)}}},{key:"updateAnimation",value:function(e){var t=!1;return this._sortedMaterialRenderers.forAll((function(n){var r=n.materialRenderer;return t=r.updateAnimation(e)||t})),t}},{key:"render",value:function(e,t){for(var n=0;n<this._sortedMaterialRenderers.length;n++){var r=this._sortedMaterialRenderers.data[n];r.material.shouldRender(e)&&r.materialRenderer.render(e.pass,t)}}},{key:"intersect",value:function(e,t,n,r,i){var a=this;return this._geometries.forEach((function(o){if(!r||r(o)){a._intersectRenderGeometry(o,n,t,0,e,i);var s=a.rendererContext.longitudeCyclical;s&&(o.boundingSphere[0]-o.boundingSphere[3]<s.min&&a._intersectRenderGeometry(o,n,t,s.range,e,i),o.boundingSphere[0]+o.boundingSphere[3]>s.max&&a._intersectRenderGeometry(o,n,t,-s.range,e,i)),i++}})),i}},{key:"_updateSortedMaterialRenderers",value:function(){var e=this;this._sortedMaterialRenderers.clear();var t=0;this._materialRenderers.forEach((function(n,r){r.insertOrder=t++,e._sortedMaterialRenderers.push({material:r,materialRenderer:n})})),this._sortedMaterialRenderers.sort((function(e,t){var n=t.material.renderPriority-e.material.renderPriority;return 0!==n?n:e.material.insertOrder-t.material.insertOrder}))}},{key:"_processAddsRemoves",value:function(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(var e=0;e<this._changes.updates.length;){var t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}},{key:"_intersectRenderGeometry",value:function(e,t,n,r,i,a){if(e.instanceParameters.visible){var o=0;(0,w.pC)(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),Yt[0]=n[0]-r,Yt[1]=n[1]-o,Yt[2]=1,Qt[0]=n[0]-r,Qt[1]=n[1]-o,Qt[2]=0,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,Yt,Qt,(function(n,r,o){!function(e,t,n,r,i,a,o){var s={layerUid:a,graphicUid:o,triangleNr:t},u=function(t){t.set(ht.q7.OVERLAY,s,e.dist,e.normal,e.transformation,n,r)};if((null==i.results.min.drapedLayerOrder||n>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&u(i.results.min),i.options.store!==ht.eC.MIN&&(null==i.results.max.drapedLayerOrder||n<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&u(i.results.max),i.options.store===ht.eC.ALL){var l=(0,dt.LP)(i.ray);u(l),i.results.all.push(l)}}(t,o,e.material.renderPriority,a,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,t)}}},{key:"_notifyGraphicGeometryChanged",value:function(e){if(!(0,w.Wi)(this.drapeSource.notifyGraphicGeometryChanged)){var t,n,r=(0,h.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value.graphicUid;(0,w.pC)(i)&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}}catch(a){r.e(a)}finally{r.f()}}}},{key:"_notifyGraphicVisibilityChanged",value:function(e){if(!(0,w.Wi)(this.drapeSource.notifyGraphicVisibilityChanged)){var t,n,r=(0,h.Z)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value.graphicUid;(0,w.pC)(i)&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}}catch(a){r.e(a)}finally{r.f()}}}},{key:"_validateRenderGeometries",value:function(e){var t,n=(0,h.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._validateRenderGeometry(r)}}catch(i){n.e(i)}finally{n.f()}return e}},{key:"_validateRenderGeometry",value:function(e){return(0,w.Wi)(e.origin)&&(e.origin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),n}(_.Z);(0,y._)([(0,A.Cb)()],Xt.prototype,"drapeSource",void 0),(0,y._)([(0,A.Cb)()],Xt.prototype,"updating",null),(0,y._)([(0,A.Cb)()],Xt.prototype,"rctx",null),(0,y._)([(0,A.Cb)()],Xt.prototype,"rendererContext",void 0),(0,y._)([(0,A.Cb)()],Xt.prototype,"_materialRepository",null),(0,y._)([(0,A.Cb)()],Xt.prototype,"_localOriginFactory",null),Xt=(0,y._)([(0,R.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Xt);var Jt=function(){function e(){(0,p.Z)(this,e),this.adds=new Set,this.removes=new Set,this.removed=new Set}return(0,v.Z)(e,[{key:"empty",get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}},{key:"has",value:function(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}},{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}]),e}();var Yt=(0,E.c)(),Qt=(0,E.c)(),Kt=n(38330),$t=n(98634),en=n(82144),tn=n(31132),nn=n(7566),rn=n(27627),an=n(46516),on=n(36207),sn=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){return(0,p.Z)(this,n),t.apply(this,arguments)}return(0,v.Z)(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new rn.$(e.rctx,t,nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);sn.shader=new en.J(an.S,(function(){return n.e(9956).then(n.bind(n,49956))}));var un=n(23038),ln=function(){function e(t,n,r){(0,p.Z)(this,e),this._techniqueRep=t,this._rctx=n,this._requestRender=r,this._enabled=!1,this._ssaoTechniqueConfig=new un.F,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}return(0,v.Z)(e,[{key:"dispose",value:function(){this.quadVAO=(0,w.O3)(this.quadVAO)}},{key:"disposeOffscreenBuffers",value:function(){(0,w.yw)(this._ssaoFBO,(function(e){return e.resize(0,0)})),(0,w.yw)(this._blur0FBO,(function(e){return e.resize(0,0)})),(0,w.yw)(this._blur1FBO,(function(e){return e.resize(0,0)}))}},{key:"enabled",get:function(){return this._enabled},set:function(e){e?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&(0,w.pC)(this._noiseTexture)&&(0,w.pC)(this._ssaoFBO)&&(0,w.pC)(this._blur0FBO)&&(0,w.pC)(this._blur1FBO)}},{key:"colorTexture",get:function(){return(0,w.pC)(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"width",get:function(){return(0,w.pC)(this._ssaoFBO)?this._ssaoFBO.width:-1}},{key:"height",get:function(){return(0,w.pC)(this._ssaoFBO)?this._ssaoFBO.height:-1}},{key:"computeSSAO",value:function(e,t,n){if(!(!this.enabled||(0,w.Wi)(t)||(0,w.Wi)(n)||(0,w.Wi)(this._noiseTexture)||(0,w.Wi)(this._ssaoFBO)||(0,w.Wi)(this._blur0FBO)||(0,w.Wi)(this._blur1FBO))){var r=this._rctx,i=e.camera,a=i.fullViewport,o=a[2],s=a[3],u=o/this._blurSizePx,l=s/this._blurSizePx;this._ssaoFBO.resize(o,s),this._blur0FBO.resize(u,l),this._blur1FBO.resize(u,l);var c=1*o,d=1*s;r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,o,s);var h=r.bindTechnique(this._ssaoTechnique,cn,e);h.setUniform2f("rnmScale",o/this._noiseTexture.descriptor.width,s/this._noiseTexture.descriptor.height);var f=1/i.computeRenderPixelSizeAtDist(1);h.setUniform1f("projScale",1*f),h.setUniform2f("screenSize",c,d);var p=(0,Se.i)(i.eye,i.center),v=20*i.computeRenderPixelSizeAtDist(p);v=Math.max(.1,v),h.setUniform1f("radius",v),h.setUniform1f("intensity",4*this._attenuation/Math.pow(v,6)),h.bindTexture("rnm",this._noiseTexture),h.bindTexture("normalMap",n),h.bindTexture("depthMap",t),(0,w.Wi)(this.quadVAO)&&(this.quadVAO=(0,oe.ow)(this._rctx)),r.bindVAO(this.quadVAO),r.drawArrays(V.MX.TRIANGLE_STRIP,0,(0,be._V)(this.quadVAO,"geometry"));var g=r.bindTechnique(this._blurTechnique,cn,e);g.bindTexture("tex",this._ssaoFBO.colorTexture),g.bindTexture("normalMap",n),g.bindTexture("depthMap",t),r.setViewport(0,0,c/this._blurSizePx,d/this._blurSizePx),r.bindFramebuffer(this._blur0FBO),g.setUniform2f("screenSize",c,d),g.setUniform2f("blurSize",0,1*this._blurSizePx/d),p>5e4&&(f=Math.max(0,f-(p-5e4))),g.setUniform1f("projScale",f),r.drawArrays(V.MX.TRIANGLE_STRIP,0,(0,be._V)(this.quadVAO,"geometry")),g.setUniform2f("blurSize",1*this._blurSizePx/c,0),r.bindFramebuffer(this._blur1FBO),g.bindTexture("tex",this._blur0FBO.colorTexture),r.drawArrays(V.MX.TRIANGLE_STRIP,0,(0,be._V)(this.quadVAO,"geometry")),r.setViewport(a[0],a[1],a[2],a[3])}}},{key:"_selectPrograms",value:function(){this._ssaoTechniqueConfig.output=un.Q.SSAO,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(sn,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=un.Q.Blur,this._blurTechnique=this._techniqueRep.releaseAndAcquire(sn,this._ssaoTechniqueConfig,this._blurTechnique)}},{key:"_enable",value:function(){var e=this;this.enabled||(this._enabled=!0,this._loadResources((function(){e._enabled&&e._initialize()})))}},{key:"_loadResources",value:function(e){var t=this;this._data?e():n.e(3412).then(n.bind(n,43412)).then((function(n){t._data=n,e()}))}},{key:"_initialize",value:function(){var e=this,t={target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,samplingMode:V.cw.LINEAR,wrapMode:V.e8.CLAMP_TO_EDGE,width:0,height:0},n={colorTarget:V.Lm.TEXTURE,depthStencilTarget:V.OU.NONE};(0,Kt.t)(this._data.noiseTexture).then((function(r){e._enabled&&(e._ssaoFBO=new j.X(e._rctx,n,t),e._blur0FBO=new j.X(e._rctx,n,t),e._blur1FBO=new j.X(e._rctx,n,t),e._noiseTexture=new Ce.x(e._rctx,{target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,hasMipmap:!0,width:r.width,height:r.height},r),e._requestRender())})),this._selectPrograms()}},{key:"_disable",value:function(){this._enabled=!1,this._noiseTexture=(0,w.O3)(this._noiseTexture),this._blur1FBO=(0,w.O3)(this._blur1FBO),this._blur0FBO=(0,w.O3)(this._blur0FBO),this._ssaoFBO=(0,w.O3)(this._ssaoFBO)}},{key:"gpuMemoryUsage",get:function(){return((0,w.pC)(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+((0,w.pC)(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+((0,w.pC)(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]),e}(),cn=new $t.K,dn=n(61863),hn=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){return(0,p.Z)(this,n),t.apply(this,arguments)}return(0,v.Z)(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get().build();return new rn.$(e.rctx,t,nn.i)}},{key:"initializePipeline",value:function(){return this.configuration.hasAlpha?(0,on.sm)({blending:(0,on.wK)(V.zi.SRC_ALPHA,V.zi.ONE,V.zi.ONE_MINUS_SRC_ALPHA,V.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK}):(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);hn.shader=new en.J(dn.T,(function(){return n.e(7026).then(n.bind(n,77026))}));var fn=n(33559),pn=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){var e;return(0,p.Z)(this,n),(e=t.apply(this,arguments)).hasAlpha=!1,e}return(0,v.Z)(n)}(fn.m);(0,y._)([(0,fn.o)()],pn.prototype,"hasAlpha",void 0);var vn,gn,mn=n(11954),yn=n(93433),_n=n(46228),Tn=function(){function e(t){(0,p.Z)(this,e),this._rctx=t,this.cache=new Map}return(0,v.Z)(e,[{key:"dispose",value:function(){this.cache.forEach((function(e){return e.texture=(0,w.O3)(e.texture)})),this.cache.clear()}},{key:"_acquire",value:function(e){var t=this;if((0,w.Wi)(e))return null;var n=this._patternId(e),r=this.cache.get(n);if(r)return r.refCount++,r.bind;var i=e.pixelRatio,a=function(e,t){var n,r=e.map((function(e){return Math.round(e*t)})),i=1/t,a=Math.floor(r.reduce((function(e,t){return e+t}))),o=r.reduce((function(e,t){return Math.max(e,t)})),s=(Math.floor(.5*(o-1))+.5)*i,u=[],l=1,c=(0,h.Z)(r);try{for(c.s();!(n=c.n()).done;){for(var d=n.value,f=0;f<d;f++){var p=l*(Math.min(f,d-1-f)+.5)*i/s*.5+.5;u.push(p)}l=-l}}catch(w){c.e(w)}finally{c.f()}var v,g=Math.round(r[0]/2),m=[].concat((0,yn.Z)(u.slice(g)),(0,yn.Z)(u.slice(0,g))),y=a+2,_=new Uint8Array(4*y),T=4,x=(0,h.Z)(m);try{for(x.s();!(v=x.n()).done;){var S=v.value;(0,_n.I)(S,_,T),T+=4}}catch(w){x.e(w)}finally{x.f()}return _.copyWithin(0,T-4,T),_.copyWithin(T,4,8),{encodedData:_,sdfNormalizer:s,paddedPixels:y,pixels:a}}(e.pattern,i),o=a.encodedData,s=a.sdfNormalizer,u=a.pixels,l=a.paddedPixels,c=u/i,d={refCount:1,texture:null,bind:function(e){return(0,w.Wi)(d.texture)&&(d.texture=new Ce.x(t._rctx,{width:l,height:1,internalFormat:V.VI.RGBA,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,wrapMode:V.e8.CLAMP_TO_EDGE},o)),e.bindTexture("stipplePatternTexture",d.texture),{pixelSize:c,sdfNormalizer:s,pixels:u}}};return this.cache.set(n,d),d.bind}},{key:"release",value:function(e){if(!(0,w.Wi)(e)){var t=this._patternId(e),n=this.cache.get(t);n&&(n.refCount--,0===n.refCount&&((0,w.pC)(n.texture)&&n.texture.dispose(),this.cache.delete(t)))}}},{key:"swap",value:function(e,t){var n=this._acquire(t);return this.release(e),n}},{key:"_patternId",value:function(e){return"".concat(e.pattern.join(","),"-r").concat(e.pixelRatio)}}]),e}();!function(e){e[e.Standard=0]="Standard",e[e.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",e[e.Transparency=2]="Transparency",e[e.OverlayWithTransparency=3]="OverlayWithTransparency",e[e.COUNT=4]="COUNT"}(vn||(vn={})),function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(gn||(gn={}));var xn=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(){var e;return(0,p.Z)(this,n),(e=t.apply(this,arguments)).function=vn.Standard,e.alphaMode=gn.None,e.hasOpacityFactor=!1,e}return(0,v.Z)(n)}(fn.m);(0,y._)([(0,fn.o)({count:vn.COUNT})],xn.prototype,"function",void 0),(0,y._)([(0,fn.o)({count:gn.COUNT})],xn.prototype,"alphaMode",void 0),(0,y._)([(0,fn.o)()],xn.prototype,"hasOpacityFactor",void 0);var Sn,wn=n(99912),On=function(e){(0,g.Z)(n,e);var t=(0,m.Z)(n);function n(e){var r;return(0,p.Z)(this,n),(r=t.call(this,e))._overlays=null,r._overlayRenderTarget=null,r._hasHighlights=!1,r._rendersOccluded=!1,r._hasWater=!1,r._handles=new x.Z,r._frameTask=wn.sq,r._drapeSourceRenderers=new Map,r._sortedDrapeSourceRenderersDirty=!1,r._sortedDrapeSourceRenderers=new O.Z,r._rctx=null,r._materialRepository=null,r._screenToWorldRatio=1,r._localOriginFactory=null,r.worldToPCSRatio=1,r.events=new T.Z,r.longitudeCyclical=null,r}return(0,v.Z)(n,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},{key:"initialize",value:function(){var e=this,t=this.view._stage.renderView;this._rctx=t.renderingContext;var n=t.waterTextureRepository;this._stippleTextureRepository=new Tn(t.renderingContext),this._shaderTechniqueRepository=new J({rctx:this._rctx,viewingMode:D.JY.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:n}),this._renderContext=new me(this._rctx,new Re(this._rctx,this.view.state.viewingMode),new ln(this._shaderTechniqueRepository,this._rctx,(function(){}))),this._handles.add([(0,C.YP)((function(){return n.updating}),(function(){return e.events.emit("content-changed")}),C.tX),(0,C.YP)((function(){return e.spatialReference}),(function(t){return e._localOriginFactory=new se.C(t)}),C.tX),(0,C.on)((function(){return e.view.allLayerViews}),"after-changes",(function(){return e._sortedDrapeSourceRenderersDirty=!0}))]),this._materialRepository=new ie(t.textureRepository,this._shaderTechniqueRepository,(function(t){(t.renderOccluded&Pn)>0!==e._rendersOccluded&&e._updateRendersOccluded(),e.events.emit("content-changed"),e.notifyChange("updating")}),(function(){return e.events.emit("content-changed")})),this._bindParameters.slot=pe.r.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=(0,oe.hf)(this._rctx),this._bindParameters.camera=An,this._bindParameters.transparencyPassType=L.Am.NONE,this._bindParameters.lighting.groundLightingFactor=1,this._bindParameters.lighting.globalFactor=0,this._bindParameters.lighting.set([new mn.Mi((0,E.f)(1,1,1))]),this._frameTask=this.view.resourceController.scheduler.registerTask(wn.T8.STAGE,this),this._handles.add(this._frameTask)}},{key:"dispose",value:function(){this._handles.destroy(),this._drapeSourceRenderers.forEach((function(e){return e.destroy()})),this._drapeSourceRenderers.clear(),this._debugTextureTechnique=(0,w.RY)(this._debugTextureTechnique),this._debugPatternTexture=(0,w.O3)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=(0,w.O3)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=(0,w.O3)(this._shaderTechniqueRepository),this._temporaryFBO=(0,w.O3)(this._temporaryFBO),this._quadVAO=(0,w.O3)(this._quadVAO),this.disposeOverlays()}},{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||this._frameTask.updating||(0,S.oE)(this._drapeSourceRenderers,(function(e){return e.updating}))}},{key:"hasOverlays",get:function(){return(0,w.pC)(this._overlays)&&(0,w.pC)(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return(0,w.pC)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"createGeometryDrapeSourceRenderer",value:function(e){return this.createDrapeSourceRenderer(e,Xt)}},{key:"createDrapeSourceRenderer",value:function(e,t,n){var r=this,i=this._drapeSourceRenderers.get(e);(0,w.pC)(i)&&i.destroy();var a=new t((0,f.Z)((0,f.Z)({},n),{},{rendererContext:this,drapeSource:e}));return this._drapeSourceRenderers.set(e,a),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add((0,C.YP)((function(){return e.fullOpacity}),(function(){return r.events.emit("content-changed")})),e),a}},{key:"removeDrapeSourceRenderer",value:function(e){if(!(0,w.Wi)(e)){var t=this._drapeSourceRenderers.get(e);(0,w.Wi)(t)||(this._sortedDrapeSourceRenderersDirty=!0,this._drapeSourceRenderers.delete(e),this._handles.remove(e),t.destroy())}}},{key:"collectUnusedRenderTargetMemory",value:function(e){var t=!1;if((0,w.pC)(this._overlayRenderTarget)){var n,r=(0,h.Z)(this._overlayRenderTarget.renderTargets);try{for(r.s();!(n=r.n()).done;){var i=n.value,a=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(a,i,e)||t}}catch(o){r.e(o)}finally{r.f()}}return t}},{key:"overlays",get:function(){return(0,w.Pt)(this._overlays,[])}},{key:"ensureDrapeTargets",value:function(e){(0,w.pC)(this._overlays)&&this._overlays.forEach((function(t){t.hasTargetWithoutRasterImage=(0,b.f)(e,(function(e){return e.drapeTargetType===I.a.WithoutRasterImage}))}))}},{key:"ensureDrapeSources",value:function(e){(0,w.pC)(this._overlays)&&this._overlays.forEach((function(t){t.hasDrapedFeatureSource=(0,b.f)(e,(function(e){return e.drapeSourceType===I.L.Features})),t.hasDrapedRasterSource=(0,b.f)(e,(function(e){return e.drapeSourceType===I.L.RasterImage}))}))}},{key:"ensureOverlays",value:function(e,t){(0,w.Wi)(this._overlays)&&(this._overlayRenderTarget=new G(this._rctx),this._overlays=[new F(r.INNER,this._overlayRenderTarget),new F(r.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}},{key:"disposeOverlays",value:function(){this._overlays=null,this._overlayRenderTarget=(0,w.O3)(this._overlayRenderTarget),this.events.emit("textures-disposed")}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0};this._frameTask.processQueue(e),e.done||this._processDrapeSources(e,t)}},{key:"_processDrapeSources",value:function(e,t){var n,r=!1,i=(0,h.Z)(this._drapeSourceRenderers);try{for(i.s();!(n=i.n()).done;){var a=(0,d.Z)(n.value,2),o=a[0],s=a[1];if(e.done)break;(o.destroyed||t(o))&&s.commitChanges()&&(r=!0,e.madeProgress())}}catch(u){i.e(u)}finally{i.f()}this._updateSortedDrapeSourceRenderers(),r&&((0,w.pC)(this._overlays)&&0===this._drapeSourceRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}},{key:"processSyncDrapeSources",value:function(){this._processDrapeSources(wn.G5,(function(e){return e.updatePolicy===L.jq.SYNC}))}},{key:"isEmpty",value:function(){if(M.Z.OVERLAY_DRAW_DEBUG_TEXTURE)return!1;var e,t=(0,h.Z)(this._drapeSourceRenderers.values());try{for(t.s();!(e=t.n()).done;){if(!e.value.isEmpty)return!1}}catch(n){t.e(n)}finally{t.f()}return!0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"updateAnimation",value:function(e){var t=!1;return this._drapeSourceRenderers.forEach((function(n){return t=n.updateAnimation(e)||t})),t}},{key:"updateDrapeSourceOrder",value:function(){this._sortedDrapeSourceRenderersDirty=!0}},{key:"drawTarget",value:function(e,t,n){var i=this,a=e.canvasGeometries;if(0===a.numViews)return!1;this._screenToWorldRatio=n*e.mapUnitsPerPixel;var o=t.renderPass;if(this.isEmpty()||o===B.C.MATERIAL_HIGHLIGHT&&!this.hasHighlights||o===B.C.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;var u=t.fbo;if(!u.isValid())return!1;var l=2*e.resolution,c=e.resolution;u.resize(l,c);var d=this._rctx;An.pixelRatio=e.pixelRatio*n,this._renderContext.pass=o,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=o===B.C.MATERIAL_NORMAL?pe.r.DRAPED_WATER:pe.r.DRAPED_MATERIAL,e.applyViewport(this._rctx),u.bind(d),e.index===r.INNER&&(d.setClearColor(0,0,0,0),d.clearSafe(V.lk.COLOR_BUFFER_BIT));var h=t.type===s.ColorNoRasterImage?Sn.ExcludeRasterImage:t.type===s.Occluded?Sn.OccludedOnly:Sn.Normal;if(h===Sn.OccludedOnly&&(this._renderContext.renderOccludedMask=Pn),M.Z.OVERLAY_DRAW_DEBUG_TEXTURE&&h!==Sn.OccludedOnly)for(var f=0;f<a.numViews;f++)this._setViewParameters(a.extents[f],e,An),this._drawDebugTexture(e.resolution,bn[e.index]);return this._drapeSourceRenderers.size>0&&this._sortedDrapeSourceRenderers.forAll((function(t){var n=t.drapeSource,r=t.renderer;if(h!==Sn.ExcludeRasterImage||n.drapeSourceType!==I.L.RasterImage){var s=n.fullOpacity,f=(0,w.pC)(s)&&s<1&&o===B.C.MATERIAL;f&&(i.bindTemporaryFramebuffer(i._rctx,l,c),d.clearSafe(V.lk.COLOR_BUFFER_BIT));for(var p=0;p<a.numViews;p++)i._setViewParameters(a.extents[p],e,An),r.render(i._renderContext,i._bindParameters);f&&(0,w.pC)(i._temporaryFBO)&&(u.bind(d),i.view._stage.renderView.compositingHelper.composite(i._renderContext.bindParameters,i._temporaryFBO.getTexture(),gn.PremultipliedAlpha,s,vn.OverlayWithTransparency,e.index))}})),d.bindFramebuffer(null),u.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}},{key:"bindTemporaryFramebuffer",value:function(e,t,n){(0,w.Wi)(this._temporaryFBO)&&(this._temporaryFBO=new W(e,!1)),this._temporaryFBO.resize(t,n),this._temporaryFBO.bind(e)}},{key:"reloadShaders",value:function(){var e=(0,c.Z)((0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._shaderTechniqueRepository.reloadAll();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"notifyContentChanged",value:function(){this.events.emit("content-changed")}},{key:"intersect",value:function(e,t,n,r){var i,a=0,o=(0,h.Z)(this._drapeSourceRenderers.values());try{for(o.s();!(i=o.n()).done;){var s,u,l=i.value;a=null!==(s=null===(u=l.intersect)||void 0===u?void 0:u.call(l,e,t,n,r,a))&&void 0!==s?s:a}}catch(c){o.e(c)}finally{o.f()}}},{key:"_updateSortedDrapeSourceRenderers",value:function(){var e=this;if(this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,this._sortedDrapeSourceRenderers.clear(),0!==this._drapeSourceRenderers.size)){var t=this.view.map.allLayers;this._drapeSourceRenderers.forEach((function(n,r){var i=t.indexOf(r.layer);e._sortedDrapeSourceRenderers.push(new Cn(r,n,i<0?1/0:i))})),this._sortedDrapeSourceRenderers.sort((function(e,t){return e.index-t.index}))}}},{key:"_setViewParameters",value:function(e,t,n){n.viewport[0]=n.viewport[1]=0,n.viewport[2]=n.viewport[3]=t.resolution,(0,P.q)(n.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],n.near,n.far),(0,P.f)(n.viewMatrix,[-e[0],-e[1],0]),this._bindParameters.camera=n}},{key:"_updateHasWater",value:function(){var e=(0,S.oE)(this._drapeSourceRenderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}},{key:"_updateHasHighlights",value:function(){var e=(0,S.oE)(this._drapeSourceRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}},{key:"_updateRendersOccluded",value:function(){var e=(0,S.oE)(this._drapeSourceRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}},{key:"_drawDebugTexture",value:function(e,t){this._ensureDebugPatternResources(e,e);var n=this._rctx,r=n.bindTechnique(this._debugTextureTechnique);r.setUniform4f("uColor",t[0],t[1],t[2],1),r.bindTexture("tex",this._debugPatternTexture),n.bindVAO(this._quadVAO),n.drawArrays(V.MX.TRIANGLE_STRIP,0,(0,be._V)(this._quadVAO,"geometry"))}},{key:"_ensureDebugPatternResources",value:function(e,t){if(!this._debugPatternTexture){for(var n=new Uint8Array(e*t*4),r=0,i=0;i<t;i++)for(var a=0;a<e;a++){var o=Math.floor(a/10),s=Math.floor(i/10);o<2||s<2||10*o>e-20||10*s>t-20?(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=255):(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=1&o&&1&s?1&a^1&i?0:255:1&o^1&s?0:128)}this._debugPatternTexture=new Ce.x(this._rctx,{target:V.No.TEXTURE_2D,pixelFormat:V.VI.RGBA,dataType:V.Br.UNSIGNED_BYTE,samplingMode:V.cw.NEAREST,width:e,height:t},n);var u=new pn;u.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(hn,u),this._quadVAO=(0,oe.ow)(this._rctx)}}},{key:"test",get:function(){var e=this;return{drapeSourceRenderers:this._drapeSourceRenderers,getDrapeSourceRenderer:function(t){return e._drapeSourceRenderers.get(t)}}}}]),n}(K(_.Z));(0,y._)([(0,A.Cb)()],On.prototype,"_frameTask",void 0),(0,y._)([(0,A.Cb)()],On.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,y._)([function(e,t){var n,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(n=null===(r=e._managedDisposables)||void 0===r?void 0:r.slice())&&void 0!==n?n:[]),e._managedDisposables.unshift(t)}],On.prototype,"_shaderTechniqueRepository",void 0),(0,y._)([function(e,t){var n,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!==(n=null===(r=e._managedDisposables)||void 0===r?void 0:r.slice())&&void 0!==n?n:[]),e._managedDisposables.unshift(t)}],On.prototype,"_stippleTextureRepository",void 0),(0,y._)([(0,A.Cb)({constructOnly:!0})],On.prototype,"view",void 0),(0,y._)([(0,A.Cb)()],On.prototype,"worldToPCSRatio",void 0),(0,y._)([(0,A.Cb)()],On.prototype,"spatialReference",void 0),(0,y._)([(0,A.Cb)({type:Boolean,readOnly:!0})],On.prototype,"updating",null),On=(0,y._)([(0,R.j)("esri.views.3d.terrain.OverlayRenderer")],On),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(Sn||(Sn={}));var Cn=(0,v.Z)((function e(t,n,r){(0,p.Z)(this,e),this.drapeSource=t,this.renderer=n,this.index=r})),bn=[[1,.5,.5],[.5,.5,1]],An=new ee.V;An.near=1,An.far=1e4,An.relativeElevation=null;var Rn=-2,Pn=ue.yD.OccludeAndTransparent},74321:function(e,t,n){n.d(t,{k:function(){return u}});var r,i,a=n(30168),o=n(98634),s=n(4760);function u(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.attributes.add(s.T.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add((0,o.H)(r||(r=(0,a.Z)(["\n    void main(void) {\n      gl_Position = vec4(position, 0.0, 1.0);\n      ","\n    }\n  "])),t?(0,o.H)(i||(i=(0,a.Z)(["uv = position * 0.5 + vec2(0.5);"]))):""))}},48353:function(e,t,n){n.d(t,{U:function(){return m}});var r,i,a,o,s,u,l=n(30168),c=n(49450),d=n(59150),h=n(58406),f=n(699),p=n(98634),v=n(4760),g=n(65964);function m(e,t){var n=e.vertex;n.uniforms.add(new h.p("intrinsicWidth",(function(e){return e.width}))),t.vvSize?(e.attributes.add(v.T.SIZEFEATUREATTRIBUTE,"float"),n.uniforms.add(new c.J("vvSizeMinSize",(function(e){return e.vvSizeMinSize}))),n.uniforms.add(new c.J("vvSizeMaxSize",(function(e){return e.vvSizeMaxSize}))),n.uniforms.add(new c.J("vvSizeOffset",(function(e){return e.vvSizeOffset}))),n.uniforms.add(new c.J("vvSizeFactor",(function(e){return e.vvSizeFactor}))),n.code.add((0,p.H)(r||(r=(0,l.Z)(["float getSize() {\nreturn intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;\n}"]))))):(e.attributes.add(v.T.SIZE,"float"),n.code.add((0,p.H)(i||(i=(0,l.Z)(["float getSize(){\nreturn intrinsicWidth * size;\n}"]))))),t.vvOpacity?(e.attributes.add(v.T.OPACITYFEATUREATTRIBUTE,"float"),n.constants.add("vvOpacityNumber","int",8),n.uniforms.add([new f.O("vvOpacityValues",(function(e){return e.vvOpacityValues}),8),new f.O("vvOpacityOpacities",(function(e){return e.vvOpacityOpacities}),8)]),n.code.add((0,p.H)(a||(a=(0,l.Z)(["float interpolateOpacity( float value ){\nif (value <= vvOpacityValues[0]) {\nreturn vvOpacityOpacities[0];\n}\nfor (int i = 1; i < vvOpacityNumber; ++i) {\nif (vvOpacityValues[i] >= value) {\nfloat f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\nreturn mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);\n}\n}\nreturn vvOpacityOpacities[vvOpacityNumber - 1];\n}\nvec4 applyOpacity( vec4 color ){\nreturn vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));\n}"]))))):n.code.add((0,p.H)(o||(o=(0,l.Z)(["vec4 applyOpacity( vec4 color ){\nreturn color;\n}"])))),t.vvColor?(e.attributes.add(v.T.COLORFEATUREATTRIBUTE,"float"),n.constants.add("vvColorNumber","int",g.x),n.uniforms.add(new f.O("vvColorValues",(function(e){return e.vvColorValues}),g.x)),n.uniforms.add(new d.b("vvColorColors",(function(e){return e.vvColorColors}),g.x)),n.code.add((0,p.H)(s||(s=(0,l.Z)(["vec4 interpolateColor( float value ) {\nif (value <= vvColorValues[0]) {\nreturn vvColorColors[0];\n}\nfor (int i = 1; i < vvColorNumber; ++i) {\nif (vvColorValues[i] >= value) {\nfloat f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\nreturn mix(vvColorColors[i-1], vvColorColors[i], f);\n}\n}\nreturn vvColorColors[vvColorNumber - 1];\n}\nvec4 getColor(){\nreturn applyOpacity(interpolateColor(colorFeatureAttribute));\n}"]))))):(e.attributes.add(v.T.COLOR,"vec4"),n.code.add((0,p.H)(u||(u=(0,l.Z)(["vec4 getColor(){\nreturn applyOpacity(color);\n}"])))))}},28156:function(e,t,n){n.d(t,{H:function(){return s}});var r,i,a=n(30168),o=n(98634);function s(e){var t=(0,o.H)(r||(r=(0,a.Z)(["vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {\nvec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"]))),n=(0,o.H)(i||(i=(0,a.Z)(["vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {\nvec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"])));e.vertex.code.add(t),e.vertex.code.add(n),e.fragment.code.add(t),e.fragment.code.add(n)}},50600:function(e,t,n){n.d(t,{R:function(){return S},d:function(){return f}});var r,i=n(30168),a=n(49223);!function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(r||(r={}));var o,s,u,l,c,d,h,f,p=n(62993),v=n(82552),g=n(95276),m=n(58406),y=n(98634),_=n(8654),T=n(19253),x=n(4760);function S(e,t){e.include(p.cK),e.attributes.add(x.T.POSITION,"vec3"),e.attributes.add(x.T.NORMAL,"vec3"),e.attributes.add(x.T.AUXPOS1,"vec4");var n=e.vertex;(0,v.S)(e,t),(0,v.h)(n,t),n.uniforms.add([new g.N("viewport",(function(e,t){return t.camera.fullViewport})),new m.p("polygonOffset",(function(e){return e.shaderPolygonOffset})),new m.p("cameraGroundRelative",(function(e,t){return t.camera.aboveGround?1:-1})),new m.p("renderTransparentlyOccludedHUD",(function(e,t){return t.renderTransparentlyOccludedHUD===r.Occluded?1:t.renderTransparentlyOccludedHUD===r.NotOccluded?0:.75})),new T.A("hudVisibilityTexture",(function(e,t){return t.hudVisibilityTexture}))]),t.hasVerticalOffset&&(0,a.V)(n),n.constants.add("smallOffsetAngle","float",.984807753012208),n.code.add((0,y.H)(o||(o=(0,i.Z)(["struct ProjectHUDAux {\nvec3 posModel;\nvec3 posView;\nvec3 vnormal;\nfloat distanceToCamera;\nfloat absCosAngle;\n};"])))),n.code.add((0,y.H)(s||(s=(0,i.Z)(["float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {\nfloat pointGroundSign = sign(pointGroundDistance);\nif (pointGroundSign == 0.0) {\npointGroundSign = cameraGroundRelative;\n}\nfloat groundRelative = cameraGroundRelative * pointGroundSign;\nif (polygonOffset > .0) {\nfloat cosAlpha = clamp(absCosAngle, 0.01, 1.0);\nfloat tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;\nfloat factor = (1.0 - tanAlpha / viewport[2]);\nif (groundRelative > 0.0) {\nposView *= factor;\n}\nelse {\nposView /= factor;\n}\n}\nreturn groundRelative;\n}"])))),t.isDraped&&!t.hasVerticalOffset||n.uniforms.add(new _.g("viewNormal",(function(e,t){return t.camera.viewInverseTransposeMatrix}))),t.isDraped||(n.uniforms.add(new m.p("perDistancePixelRatio",(function(e,t){return Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)}))),n.code.add((0,y.H)(u||(u=(0,i.Z)(["void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {\nfloat distanceToCamera = length(posView);\nfloat pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;\nvec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;\nvec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\nposModel += modelOffset;\nposView += viewOffset;\n}"]))))),t.screenCenterOffsetUnitsEnabled===f.Screen&&n.uniforms.add(new m.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),t.hasScreenSizePerspective&&(0,p.m8)(n),n.code.add((0,y.H)(l||(l=(0,i.Z)(["\n    vec4 projectPositionHUD(out ProjectHUDAux aux) {\n      // centerOffset is in view space and is used to implement world size offsetting\n      // of labels with respect to objects. It also pulls the label towards the viewer\n      // so that the label is visible in front of the object.\n      vec3 centerOffset = auxpos1.xyz;\n\n      // The pointGroundDistance is the distance of the geometry to the ground and is\n      // negative if the point is below the ground, or positive if the point is above\n      // ground.\n      float pointGroundDistance = auxpos1.w;\n\n      aux.posModel = position;\n      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;\n      aux.vnormal = normal;\n      ","\n\n      // Screen sized offset in world space, used for example for line callouts\n      // Note: keep this implementation in sync with the CPU implementation, see\n      //   - MaterialUtil.verticalOffsetAtDistance\n      //   - HUDMaterial.applyVerticalOffsetTransformation\n\n      aux.distanceToCamera = length(aux.posView);\n\n      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);\n      float cosAngle = dot(aux.vnormal, viewDirObjSpace);\n\n      aux.absCosAngle = abs(cosAngle);\n\n      ","\n\n      ","\n\n      ","\n\n      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);\n\n      ","\n\n      vec4 posProj = proj * vec4(aux.posView, 1.0);\n\n      ","\n\n      ","\n\n      // constant part of polygon offset emulation\n      posProj.z -= groundRelative * polygonOffset * posProj.w;\n      return posProj;\n    }\n  "])),t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);",t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled===f.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":"",t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":"",t.hasVerticalOffset?(0,y.H)(c||(c=(0,i.Z)(["\n            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);\n            vec3 modelOffset = aux.vnormal * worldOffset;\n            aux.posModel += modelOffset;\n            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n            aux.posView += viewOffset;\n            // Since we elevate the object, we need to take that into account\n            // in the distance to ground\n            pointGroundDistance += worldOffset;"]))):"",t.screenCenterOffsetUnitsEnabled!==f.Screen?(0,y.H)(d||(d=(0,i.Z)(["\n            // Apply x/y in view space, but z in screen space (i.e. along posView direction)\n            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);\n\n            // Same material all have same z != 0.0 condition so should not lead to\n            // branch fragmentation and will save a normalization if it's not needed\n            if (centerOffset.z != 0.0) {\n              aux.posView -= normalize(aux.posView) * centerOffset.z;\n            }\n          "]))):"",t.screenCenterOffsetUnitsEnabled===f.Screen?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":"",t.screenCenterOffsetUnitsEnabled===f.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":"")),n.code.add((0,y.H)(h||(h=(0,i.Z)(["bool testVisibilityHUD(vec4 posProj) {\nvec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);\nvec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);\nif (renderTransparentlyOccludedHUD > 0.5) {\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;\n}\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;\n}"]))))}!function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"}(f||(f={}))},50913:function(e,t,n){n.d(t,{R:function(){return p}});var r,i,a,o,s=n(30168),u=n(21002),l=n(43565),c=n(78980),d=n(82999),h=n(98634),f=n(19253);function p(e,t){var n=e.vertex,p=e.fragment;t.hasMultipassGeometry&&n.include(l.S),t.hasMultipassTerrain&&e.varyings.add("depth","float"),n.code.add((0,h.H)(r||(r=(0,s.Z)(["\n  void main(void) {\n    vec4 posProjCenter;\n    if (dot(position, position) > 0.0) {\n      // Render single point to center of the pixel to avoid subpixel\n      // filtering to affect the marker color\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      posProjCenter = alignToPixelCenter(posProj, viewport.zw);\n\n      ","\n\n      ","\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        // Project out of clip space\n        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n      }\n\n    } else {\n      // Project out of clip space\n      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n\n    gl_Position = posProjCenter;\n    gl_PointSize = 1.0;\n  }\n  "])),t.hasMultipassGeometry?(0,h.H)(i||(i=(0,s.Z)(["\n        // Don't draw vertices behind geometry\n        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){\n          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n        }"]))):"",t.hasMultipassTerrain?"depth = projectAux.posView.z;":"")),t.hasMultipassTerrain&&p.include(u.S),t.hasMultipassTerrain&&p.uniforms.add([new f.A("terrainDepthTexture",(function(e,t){return t.multipassTerrain.linearDepthTexture})),new d.A("nearFar",(function(e,t){return t.camera.nearFar})),new d.A("inverseViewport",(function(e,t){return t.inverseViewport}))]),p.include(c.n),p.code.add((0,h.H)(a||(a=(0,s.Z)(["\n  void main() {\n    gl_FragColor = vec4(1, 1, 1, 1);\n    ","\n  }\n  "])),t.hasMultipassTerrain?(0,h.H)(o||(o=(0,s.Z)(["\n          vec2 uv = gl_FragCoord.xy * inverseViewport;\n\n          //Read the rgba data from the texture linear depth\n          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);\n\n          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);\n\n          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)\n          //Mark the HUD vertex as occluded by transparent terrain\n          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){\n            gl_FragColor.g = 0.5;\n          }"]))):""))}},7683:function(e,t,n){n.d(t,{E:function(){return u},K:function(){return s}});var r,i,a=n(30168),o=n(98634);function s(e){e.fragment.code.add((0,o.H)(r||(r=(0,a.Z)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function u(e){e.fragment.code.add((0,o.H)(i||(i=(0,a.Z)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}},60300:function(e,t,n){n.d(t,{q:function(){return Z}});var r=n(30168),i=n(78980),a=n(82552),o=n(95276),s=n(58406),u=n(60465),l=n(98634),c=n(2104),d=n(92026),h=n(90045),f=n(67077);function p(e){return(0,d.Wi)(e)?f.Z:4===e.length?e:(0,h.s)(M,e[0],e[1],e[2],1)}var v,g,m,y,_,T,x,S,w,O,C,b,A,R,P,E,D,I,M=(0,f.c)();function Z(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?H(e,t):function(e){e.fragment.code.add((0,l.H)(I||(I=(0,r.Z)(["float getStippleAlpha() { return 1.0; }\n#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}\n#define blendStipple(color, _stippleAlpha_) color"]))))}(e)}function H(e,t){var n=!(t.draped&&t.stipplePreferContinuous),d=e.vertex,h=e.fragment;h.include(i.n),d.uniforms.add(new u.d("stipplePatternPixelSize")),t.draped||((0,a.h)(d,t),d.uniforms.add(new s.p("worldToScreenPerDistanceRatio",(function(e,t){return 1/t.camera.perScreenPixelRatio}))),d.code.add((0,l.H)(v||(v=(0,r.Z)(["float computeWorldToScreenRatio(vec3 segmentCenter) {\nfloat segmentDistanceToCamera = length(segmentCenter - cameraPosition);\nreturn worldToScreenPerDistanceRatio / segmentDistanceToCamera;\n}"]))))),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),d.code.add((0,l.H)(g||(g=(0,r.Z)(["\n    float discretizeWorldToScreenRatio(float worldToScreenRatio) {\n      float step = ",";\n\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n      return discreteWorldToScreenRatio;\n    }\n  "])),N)),d.code.add((0,l.H)(m||(m=(0,r.Z)(["vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {"])))),d.code.add((0,l.H)(y||(y=(0,r.Z)(["\n    if (segmentLengthPseudoScreen >= ",") {\n  "])),n?"patternLength":"1e4")),d.uniforms.add(new s.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))),d.code.add((0,l.H)(_||(_=(0,r.Z)(["\n        // Round the screen length to get an integer number of pattern repetitions (minimum 1).\n        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);\n        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));\n        float segmentLengthScreenRounded = flooredRepetitions * patternLength;\n\n        ","\n\n        return vec2(0.0, segmentLengthScreenRounded);\n      }\n      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);\n    }\n  "])),t.stippleRequiresStretchMeasure?(0,l.H)(T||(T=(0,r.Z)(["\n              float stretch = repetitions / flooredRepetitions;\n\n              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.\n              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.\n              vStipplePatternStretch = max(0.75, stretch);"]))):"")),h.uniforms.add(new c.Q("stipplePatternTexture")),h.uniforms.add(new u.d("stipplePatternSDFNormalizer")),h.uniforms.add(new u.d("stipplePatternTextureSize")),h.uniforms.add(new u.d("stipplePatternPixelSizeInv")),h.code.add((0,l.H)(x||(x=(0,r.Z)(["float padTexture(float u) {\nreturn (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);\n}"])))),h.code.add((0,l.H)(S||(S=(0,r.Z)(["\n    float getStippleSDF(out bool isClamped) {\n      ","\n\n      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;\n      ","\n      u = padTexture(fract(u));\n\n      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));\n      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;\n\n      ","\n    }\n\n    float getStippleSDF() {\n      bool ignored;\n      return getStippleSDF(ignored);\n    }\n\n    float getStippleAlpha() {\n      bool isClamped;\n      float stippleSDF = getStippleSDF(isClamped);\n\n      float antiAliasedResult = ","\n\n      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;\n    }\n  "])),t.stippleRequiresClamp?(0,l.H)(w||(w=(0,r.Z)(["\n          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);\n          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;\n          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;"]))):(0,l.H)(O||(O=(0,r.Z)(["\n          float stippleDistanceClamped = vStippleDistance;\n          isClamped = false;"]))),t.stippleScaleWithLineWidth?(0,l.H)(C||(C=(0,r.Z)(["u *= vLineSizeInv;"]))):"",t.stippleRequiresStretchMeasure?(0,l.H)(b||(b=(0,r.Z)(["return (sdf - 0.5) * vStipplePatternStretch + 0.5;"]))):(0,l.H)(A||(A=(0,r.Z)(["return sdf;"]))),t.stippleScaleWithLineWidth?(0,l.H)(R||(R=(0,r.Z)(["clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);"]))):(0,l.H)(P||(P=(0,r.Z)(["clamp(stippleSDF + 0.5, 0.0, 1.0);"]))))),t.stippleOffColorEnabled?(h.uniforms.add(new o.N("stippleOffColor",(function(e){return p(e.stippleOffColor)}))),h.code.add((0,l.H)(E||(E=(0,r.Z)(["#define discardByStippleAlpha(stippleAlpha, threshold) {}\n#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)"]))))):h.code.add((0,l.H)(D||(D=(0,r.Z)(["#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }\n#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)"]))))}var N=l.H.float(.4)},43565:function(e,t,n){n.d(t,{S:function(){return d},_:function(){return h}});var r,i=n(43144),a=n(15671),o=n(30168),s=n(21002),u=n(82999),l=n(98634),c=n(19253);function d(e){e.include(s.S),e.uniforms.add([new c.A("geometryDepthTexture",(function(e,t){return t.multipassGeometry.linearDepthTexture})),new u.A("nearFar",(function(e,t){return t.camera.nearFar}))]),e.code.add((0,l.H)(r||(r=(0,o.Z)(["bool geometryDepthTest(vec2 pos, float elementDepth) {\nfloat geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);\nreturn (elementDepth < (geometryDepth - 1.0));\n}"]))))}var h=(0,i.Z)((function e(){(0,a.Z)(this,e),this.enabled=!1}))},8555:function(e,t,n){n.d(t,{n:function(){return l}});var r,i,a,o,s=n(30168),u=n(98634);function l(e,t){t.spherical?e.vertex.code.add((0,u.H)(r||(r=(0,s.Z)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):e.vertex.code.add((0,u.H)(i||(i=(0,s.Z)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),t.spherical?e.vertex.code.add((0,u.H)(a||(a=(0,s.Z)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):e.vertex.code.add((0,u.H)(o||(o=(0,s.Z)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}},40854:function(e,t,n){n.d(t,{O:function(){return v},P:function(){return p}});var r,i=n(43144),a=n(15671),o=n(30168),s=n(81949),u=n(21002),l=n(82999),c=n(58406),d=n(98634),h=n(8654),f=n(19253);function p(e,t){var n=e.fragment.uniforms;n.add(new l.A("nearFar",(function(e,t){return t.camera.nearFar}))),n.add(new f.A("depthMap",(function(e,t){return t.linearDepthTexture}))),n.add(new h.g("view",(function(e,t){return t.ssr.camera.viewMatrix}))),n.add(new h.g("proj",(function(e,t){return t.ssr.camera.projectionMatrix}))),n.add(new c.p("invResolutionHeight",(function(e,t){return 1/t.ssr.camera.height}))),n.add(new f.A("lastFrameColorMap",(function(e,t){return t.ssr.lastFrameColorTexture}))),n.add(new h.g("reprojectionMatrix",(function(e,t){return t.ssr.reprojectionMatrix}))),e.fragment.include(u.S),e.fragment.code.add((0,d.H)(r||(r=(0,o.Z)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy * 0.5 + 0.5;\n  }\n\n  const int maxSteps = ","\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n        return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150;":"75;"))}var v=(0,i.Z)((function e(){(0,a.Z)(this,e),this.reprojectionMatrix=(0,s.c)()}))},77652:function(e,t,n){n.d(t,{B:function(){return G}});var r,i=n(30168),a=n(7683),o=n(98634);function s(e){e.fragment.code.add((0,o.H)(r||(r=(0,i.Z)(["const float GAMMA = 2.2;\nconst float INV_GAMMA = 0.4545454545;\nvec4 delinearizeGamma(vec4 color) {\nreturn vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n}\nvec3 linearizeGamma(vec3 color) {\nreturn pow(color, vec3(GAMMA));\n}"]))))}var u,l,c,d,h,f,p,v,g=n(2116),m=n(40854),y=n(16889),_=n(92026),T=n(88396),x=n(6394),S=n(22186),w=n(91226),O=n(13773),C=n(82999),b=n(49450),A=n(58406),R=n(8654),P=n(43144),E=n(15671),D=n(60136),I=n(54062),M=n(61809),Z=n(99340),H=function(e){(0,D.Z)(n,e);var t=(0,I.Z)(n);function n(e,r){return(0,E.Z)(this,n),t.call(this,e,"samplerCube",Z.P.Pass,(function(t,n,i){return t.bindTexture(e,r(n,i))}))}return(0,P.Z)(n)}(M.x);function N(e){var t=e.fragment;t.uniforms.add([new R.g("rotationMatrixClouds",(function(e,t){return t.clouds.parallax.transform})),new R.g("rotationMatrixCloudsCrossFade",(function(e,t){return t.clouds.parallaxNew.transform})),new b.J("anchorPosition",(function(e,t){return t.clouds.parallax.anchorPointClouds})),new b.J("anchorPositionCrossFade",(function(e,t){return t.clouds.parallaxNew.anchorPointClouds})),new C.A("cloudVariables",(function(e,t){return(0,_.pC)(t.clouds.data)?(0,T.a)(B,t.clouds.data.coverage,t.clouds.data.absorption):x.Z})),new A.p("cloudsHeight",(function(e,t){return t.clouds.parallax.cloudsHeight})),new A.p("radiusCurvatureCorrectionFactor",(function(e,t){return t.clouds.parallax.radiusCurvatureCorrectionFactor})),new A.p("totalFadeInOut",(function(e,t){return t.clouds.fadeInOut.stage===w.co.FINISHED?t.clouds.fadeInOutHeight.factor+Math.max((0,y.uZ)(t.clouds.fadeIn.factor,0,1)):t.clouds.fadeInOutHeight.factor+Math.max((0,y.uZ)(t.clouds.fadeInOut.factor,0,1))})),new A.p("crossFadeAnchorFactor",(function(e,t){return(0,y.uZ)(t.clouds.crossFade.factor,0,1)})),new H("cubeMap",(function(e,t){return(0,_.pC)(t.clouds.data)?t.clouds.data.cubeMap.colorTexture:null})),new O.U("crossFade",(function(e,t){return t.clouds.crossFade.enabled}))]),t.constants.add("planetRadius","float",S.sv.radius),t.code.add((0,o.H)(u||(u=(0,i.Z)(["vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)\n{\nfloat radiusClouds = planetRadius + cloudsHeight;\nfloat B = 2.0 * dot(cameraPosition, dir);\nfloat C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;\nfloat det = B * B - 4.0 * C;\nfloat pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));\nvec3 intersectionPont = cameraPosition + dir * pointIntDist;\nintersectionPont =  intersectionPont - spherePos;\nreturn intersectionPont;\n}"])))),t.code.add((0,o.H)(l||(l=(0,i.Z)(["vec3 correctForPlanetCurvature(vec3 dir)\n{\ndir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;\nreturn dir;\n}"])))),t.code.add((0,o.H)(c||(c=(0,i.Z)(["vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)\n{\nreturn (rotMat * vec4(inVec, 0.0)).xyz;\n}"])))),t.uniforms.add([new b.J("lightingMainDirection",(function(e,t){return t.lighting.lightingMainDirection})),new b.J("lightingMainIntensity",(function(e,t){return t.lighting.mainLight.intensity}))]),t.code.add((0,o.H)(d||(d=(0,i.Z)(["const float SUNSET_TRANSITION_FACTOR = 0.3;\nconst vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);\nconst float RIM_SCATTERING_FACTOR = 140.0;\nconst float BACKLIGHT_FACTOR = 0.2;\nconst float BACKLIGHT_SCATTERING_FACTOR = 10.0;\nconst float BACKLIGHT_TRANSITION_FACTOR = 0.3;\nvec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)\n{\nfloat upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));\nfloat dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);\nfloat sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);\nvec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);\nvec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);\nvec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));\nvec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));\nfloat scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);\nfloat rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);\nvec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;\nfloat additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;\nreturn vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);\n}"])))),t.code.add((0,o.H)(h||(h=(0,i.Z)(["vec4 getCloudData(vec3 rayDir)\n{\nvec4 cloudData = textureCube(cubeMap, rayDir);\nfloat mu = dot(rayDir, vec3(0, 0, 1));\nreturn mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));\n}"])))),t.code.add((0,o.H)(f||(f=(0,i.Z)(["vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected);\nfloat totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudData.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);\n}"])))),t.code.add((0,o.H)(p||(p=(0,i.Z)(["vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected);\nvec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\nintersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);\nworldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));\nworldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\ncloudData = getCloudData(worldRayRotatedCorrected);\nvec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\ncloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);\nfloat totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudColor.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(cloudColor.rgb, totalTransmittance);\n}"])))),t.code.add((0,o.H)(v||(v=(0,i.Z)(["vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)\n{\nreturn crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);\n}"]))))}var L,k,F,z,U,V,j,W,B=(0,x.a)();function G(e,t){e.include(g.T,t),e.include(s),e.include(a.E),t.hasCloudsReflections&&e.include(N,t),t.hasScreenSpaceReflections&&e.include(m.P,t);var n=e.fragment;n.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),n.code.add((0,o.H)(L||(L=(0,i.Z)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),n.uniforms.add([new A.p("lightingSpecularStrength",(function(e,t){return t.lighting.mainLight.specularStrength})),new A.p("lightingEnvironmentStrength",(function(e,t){return t.lighting.mainLight.environmentStrength}))]),n.code.add((0,o.H)(k||(k=(0,i.Z)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {\nfloat reflectionHit = 0.0;\nfloat reflectionHitDiffused = 0.0;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nspecular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}\nfloat correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);\nvec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);\nvec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));"])))),t.hasCloudsReflections&&n.code.add((0,o.H)(F||(F=(0,i.Z)(["vec4 cloudsColor = renderClouds(reflectedWorld, position);\ncloudsColor.a = 1.0 - cloudsColor.a;\ncloudsColor = pow(cloudsColor, vec4(GAMMA));\ncloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);"])))),t.hasScreenSpaceReflections?n.code.add((0,o.H)(z||(z=(0,i.Z)(["vec3 viewDir = normalize(viewPosition);\nvec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = view *vec4(localUp, 0.0);\nvec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));\nvec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);\nreflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\nreflectionHitDiffused = waterDiffusion * reflectionHit;\nreflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;\n}\nfloat seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);\nvec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);"])))):n.code.add((0,o.H)(U||(U=(0,i.Z)(["vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);"])))),t.hasCloudsReflections?t.hasScreenSpaceReflections?n.code.add((0,o.H)(V||(V=(0,i.Z)(["return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;\n}"])))):n.code.add((0,o.H)(j||(j=(0,i.Z)(["return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;\n}"])))):n.code.add((0,o.H)(W||(W=(0,i.Z)(["return waterRenderedColor;\n}"]))))}},79246:function(e,t,n){n.d(t,{M:function(){return p}});var r,i=n(30168),a=n(88396),o=n(6394),s=n(90045),u=n(67077),l=n(7683),c=n(82999),d=n(95276),h=n(98634),f=n(2104);function p(e){e.fragment.uniforms.add(new f.Q("texWaveNormal")),e.fragment.uniforms.add(new f.Q("texWavePerturbation")),e.fragment.uniforms.add([new d.N("waveParams",(function(e){return(0,s.s)(v,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)})),new c.A("waveDirection",(function(e){return(0,a.a)(g,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)}))]),e.include(l.K),e.fragment.code.add((0,h.H)(r||(r=(0,i.Z)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture2D(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}var v=(0,u.c)(),g=(0,o.a)()},96415:function(e,t,n){n.d(t,{G:function(){return h},R:function(){return p}});var r,i=n(30168),a=n(88396),o=n(6394),s=n(90045),u=n(67077),l=n(82999),c=n(95276),d=n(98634);function h(e){e.fragment.uniforms.add(new c.N("projInfo",(function(e,t){return function(e){var t=e.camera.projectionMatrix;return 0===t[11]?(0,s.s)(f,2/(e.camera.fullWidth*t[0]),2/(e.camera.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):(0,s.s)(f,-2/(e.camera.fullWidth*t[0]),-2/(e.camera.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}(t)}))),e.fragment.uniforms.add(new l.A("zScale",(function(e,t){return p(t)}))),e.fragment.code.add((0,d.H)(r||(r=(0,i.Z)(["vec3 reconstructPosition(vec2 fragCoord, float depth) {\nreturn vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);\n}"]))))}var f=(0,u.c)();function p(e){return 0===e.camera.projectionMatrix[11]?(0,a.a)(v,0,1):(0,a.a)(v,1,0)}var v=(0,o.a)()},17943:function(e,t,n){n.d(t,{e:function(){return s}});var r=n(43144),i=n(15671),a=n(60136),o=n(54062),s=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e,"vec2")}return(0,r.Z)(n)}(n(61809).x)},68827:function(e,t,n){n.d(t,{y:function(){return s}});var r=n(43144),i=n(15671),a=n(60136),o=n(54062),s=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e,"vec4")}return(0,r.Z)(n)}(n(61809).x)},60465:function(e,t,n){n.d(t,{d:function(){return s}});var r=n(43144),i=n(15671),a=n(60136),o=n(54062),s=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e,"float")}return(0,r.Z)(n)}(n(61809).x)},2104:function(e,t,n){n.d(t,{Q:function(){return s}});var r=n(43144),i=n(15671),a=n(60136),o=n(54062),s=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,e,"sampler2D")}return(0,r.Z)(n)}(n(61809).x)},30425:function(e,t,n){n.d(t,{V:function(){return O}});var r,i=n(15671),a=n(43144),o=n(32718),s=n(16889),u=n(92026),l=n(17842),c=n(14226),d=n(81949),h=n(88396),f=n(6394),p=n(11186),v=n(71353),g=n(90045),m=n(67077),y=n(95773),_=n(40885),T=n(40927),x=n(50951),S=n(97731),w=o.Z.getLogger("esri.views.3d.webgl-engine.lib.Camera"),O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,i.Z)(this,e),this._viewUp=(0,v.c)(),this._viewForward=(0,v.c)(),this._viewRight=(0,v.c)(),this._ray=(0,_.Ue)(),this._viewport=(0,m.f)(0,0,1,1),this._padding=(0,m.f)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,f.f)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,d.c)(),this._projectionDirty=!0,this._projectionMatrix=(0,d.c)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,d.c)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,d.c)(),this._inverseProjectionDirty=!0,this._inverseProjectionMatrix=null,this._frustumDirty=!0,this._frustum=(0,y.Ue)(),this._fullViewport=(0,m.c)(),this._pixelRatio=1,this.relativeElevation=0,(0,u.pC)(t)&&(0,p.c)(this._ray.origin,t),this._center=(0,u.pC)(n)?(0,v.a)(n):(0,v.c)(),this._up=(0,u.pC)(r)?(0,v.a)(r):(0,v.f)(0,0,1)}return(0,a.Z)(e,[{key:"pixelRatio",get:function(){return this._pixelRatio},set:function(e){this._pixelRatio=e>0?e:1}},{key:"eye",get:function(){return this._ray.origin},set:function(e){this._compareAndSetView(e,this._ray.origin)}},{key:"center",get:function(){return this._center},set:function(e){this._compareAndSetView(e,this._center)}},{key:"ray",get:function(){return(0,p.b)(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(e){this._compareAndSetView(e,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(e){(0,c.c)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(e){e+=this._padding[r.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(e){e+=this._padding[r.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[r.RIGHT]+this._padding[r.LEFT]},set:function(e){this.width=e-(this._padding[r.RIGHT]+this._padding[r.LEFT])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[r.TOP]+this._padding[r.BOTTOM]},set:function(e){this.height=e-(this._padding[r.TOP]+this._padding[r.BOTTOM])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[r.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[r.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding[r.TOP]===e[r.TOP]&&this._padding[r.RIGHT]===e[r.RIGHT]&&this._padding[r.BOTTOM]===e[r.BOTTOM]&&this._padding[r.LEFT]===e[r.LEFT]||(this._viewport[0]+=e[r.LEFT]-this._padding[r.LEFT],this._viewport[1]+=e[r.BOTTOM]-this._padding[r.BOTTOM],this._viewport[2]-=e[r.RIGHT]+e[r.LEFT]-(this._padding[r.RIGHT]+this._padding[r.LEFT]),this._viewport[3]-=e[r.TOP]+e[r.BOTTOM]-(this._padding[r.TOP]+this._padding[r.BOTTOM]),(0,g.c)(this._padding,e),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&((0,c.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){var e=this.width,t=this.height,n=this.near*Math.tan(this.fovY/2),i=n*this.aspect;(0,c.l)(this._projectionMatrix,-i*(1+2*this._padding[r.LEFT]/e),i*(1+2*this._padding[r.RIGHT]/e),-n*(1+2*this._padding[r.BOTTOM]/t),n*(1+2*this._padding[r.TOP]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(e){(0,c.c)(this._projectionMatrix,e),this._projectionDirty=!1,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"inverseProjectionMatrix",get:function(){return(0,u.Wi)(this._inverseProjectionMatrix)&&(this._inverseProjectionMatrix=(0,d.c)()),this._inverseProjectionDirty&&(0,c.a)(this._inverseProjectionMatrix,this.projectionMatrix),this._inverseProjectionMatrix}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return(0,S.tM)(this._fov,this.width,this.height)},set:function(e){this._fov=(0,S.Kj)(e,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return(0,S.RQ)(this._fov,this.width,this.height)},set:function(e){this._fov=(0,S.zF)(e,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return(0,p.i)(this._center,this.eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,c.a)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,c.t)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"depthNDCToWorld",value:function(e){var t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this._pixelRatio}},{key:"aboveGround",get:function(){return this.relativeElevation&&this.relativeElevation>=0}},{key:"copyFrom",value:function(e){(0,p.c)(this._ray.origin,e.eye),(0,p.c)(this._center,e.center),(0,p.c)(this._up,e.up),(0,g.c)(this._viewport,e.viewport),(0,g.c)(this._padding,e.padding),(0,h.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;var t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,c.c)(this._viewMatrix,e.viewMatrix),(0,p.c)(this._viewRight,e.viewRight),(0,p.c)(this._viewUp,e.viewUp),(0,p.c)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,c.c)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._inverseProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,y.JG)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,c.c)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,g.c)(this._fullViewport,e.fullViewport),this._pixelRatio=e.pixelRatio,this}},{key:"copyViewFrom",value:function(e){this.eye=e.eye,this.center=e.center,this.up=e.up}},{key:"clone",value:function(){return(new e).copyFrom(this)}},{key:"equals",value:function(e){return(0,p.k)(this.eye,e.eye)&&(0,p.k)(this._center,e.center)&&(0,p.k)(this._up,e.up)&&(0,g.g)(this._viewport,e.viewport)&&(0,g.g)(this._padding,e.padding)&&(0,h.e)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this._pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}},{key:"almostEquals",value:function(e){if(this._pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;var t=5e-4;(0,p.v)(A,e.eye,e.center),(0,p.v)(R,this.eye,this._center);var n=(0,p.e)(A,R),r=(0,p.w)(A),i=(0,p.w)(R);return n*n>=(1-1e-10)*r*i&&(0,p.x)(e.eye,this.eye)<Math.max(r,i)*t*t&&(0,g.i)(e.padding,this._padding)<.5&&(0,g.i)(e.viewport,this._viewport)<.5}},{key:"computeRenderPixelSizeAt",value:function(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}},{key:"computeRenderPixelSizeAtDist",value:function(e){return e*this.perRenderPixelRatio}},{key:"computeScreenPixelSizeAt",value:function(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}},{key:"_viewDirectionDistance",value:function(e){return Math.abs((0,T.SR)(this.viewForward,(0,p.b)(A,e,this.eye)))}},{key:"computeScreenPixelSizeAtDist",value:function(e){return e*this.perScreenPixelRatio}},{key:"computeDistanceFromRadius",value:function(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}},{key:"getScreenCenter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,l.s1)();return e[0]=(this.padding[r.LEFT]+this.width/2)/this._pixelRatio,e[1]=(this.padding[r.TOP]+this.height/2)/this._pixelRatio,e}},{key:"getRenderCenter",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e[0]=this.padding[r.LEFT]+this.width*t,e[1]=this.padding[r.BOTTOM]+this.height*n,e[2]=.5,e}},{key:"setGLViewport",value:function(e){var t=this.viewport,n=this.padding;e.setViewport(t[0]-n[3],t[1]-n[2],t[2]+n[1]+n[3],t[3]+n[0]+n[2])}},{key:"applyProjection",value:function(e,t){e!==C&&(0,p.c)(C,e),C[3]=1,(0,g.t)(C,C,this.projectionMatrix);var n=Math.abs(C[3]);(0,p.g)(C,C,1/n);var r=this.fullViewport;t[0]=(0,s.t7)(0,r[0]+r[2],.5+.5*C[0]),t[1]=(0,s.t7)(0,r[1]+r[3],.5+.5*C[1]),t[2]=.5*(C[2]+1),t[3]=n}},{key:"unapplyProjection",value:function(e,t){var n=this.fullViewport;C[0]=(e[0]/(n[0]+n[2])*2-1)*e[3],C[1]=(e[1]/(n[1]+n[3])*2-1)*e[3],C[2]=(2*e[2]-1)*e[3],C[3]=e[3],(0,g.t)(C,C,this.inverseProjectionMatrix),t[0]=C[0],t[1]=C[1],t[2]=C[2]}},{key:"projectToScreen",value:function(e,t){this.projectToRenderScreen(e,P),this.renderToScreen(P,t)}},{key:"projectToRenderScreen",value:function(e,t){if(C[0]=e[0],C[1]=e[1],C[2]=e[2],C[3]=1,(0,g.t)(C,C,this.viewProjectionMatrix),0===C[3])return null;(0,p.g)(C,C,1/Math.abs(C[3]));var n=this.fullViewport;return"x"in t?(t.x=(0,s.t7)(0,n[0]+n[2],.5+.5*C[0]),t.y=(0,s.t7)(0,n[1]+n[3],.5+.5*C[1])):(t[0]=(0,s.t7)(0,n[0]+n[2],.5+.5*C[0]),t[1]=(0,s.t7)(0,n[1]+n[3],.5+.5*C[1]),t.length>2&&(t[2]=.5*(C[2]+1))),t}},{key:"unprojectFromScreen",value:function(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,P),t)}},{key:"unprojectFromRenderScreen",value:function(e,t){if((0,c.m)(b,this.projectionMatrix,this.viewMatrix),!(0,c.a)(b,b))return null;var n=this.fullViewport;return C[0]=2*(e[0]-n[0])/n[2]-1,C[1]=2*(e[1]-n[1])/n[3]-1,C[2]=2*e[2]-1,C[3]=1,(0,g.t)(C,C,b),0===C[3]?null:(t[0]=C[0]/C[3],t[1]=C[1]/C[3],t[2]=C[2]/C[3],t)}},{key:"constrainWindowSize",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n,i=e*this._pixelRatio,a=t*this._pixelRatio,o=Math.max(i-n/2,0),s=Math.max(this.fullHeight-a-r/2,0),u=-Math.min(i-n/2,0),l=-Math.min(this.fullHeight-a-r/2,0);return[o,s,n-u- -Math.min(this.fullWidth-i-n/2,0),r-l- -Math.min(a-r/2,0)]}},{key:"computeUp",value:function(e){e===x.JY.Global?this._computeUpGlobal():this._computeUpLocal()}},{key:"screenToRender",value:function(e,t){var n=e[0]*this._pixelRatio,r=this.fullHeight-e[1]*this._pixelRatio;return t[0]=n,t[1]=r,t}},{key:"renderToScreen",value:function(e,t){var n=e[0]/this._pixelRatio,r=(this.fullHeight-e[1])/this._pixelRatio;t[0]=n,t[1]=r}},{key:"_computeUpGlobal",value:function(){(0,p.b)(A,this.center,this.eye);var e=(0,p.l)(this.center);e<1?((0,p.s)(this._up,0,0,1),this._markViewDirty()):Math.abs((0,p.e)(A,this.center))>.9999*(0,p.l)(A)*e||((0,p.f)(this._up,A,this.center),(0,p.f)(this._up,this._up,A),(0,p.n)(this._up,this._up),this._markViewDirty())}},{key:"_computeUpLocal",value:function(){(0,p.r)(A,this.eye,this.center),Math.abs(A[2])<=.9999&&((0,p.g)(A,A,A[2]),(0,p.s)(this._up,-A[0],-A[1],1-A[2]),(0,p.n)(this._up,this._up),this._markViewDirty())}},{key:"_compareAndSetView",value:function(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,p.k)(e,t)||((0,p.c)(t,e),this._markViewDirty()):w.warn("Camera vector contains invalid number, ignoring value")}},{key:"_markViewDirty",value:function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}},{key:"_recomputeFrustum",value:function(){this._frustumDirty&&((0,y.q_)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}},{key:"_ensureViewClean",value:function(){this._viewDirty&&((0,c.n)(this._viewMatrix,this.eye,this._center,this._up),(0,p.s)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,p.s)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,p.s)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}]),e}(),C=(0,m.c)(),b=(0,d.c)(),A=(0,v.c)(),R=(0,v.c)(),P=(0,l.J$)();!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(r||(r={}))},94425:function(e,t,n){n.d(t,{S:function(){return c},p:function(){return l}});var r=n(15671),i=n(43144),a=n(92026),o=n(71011),s=n(68401),u=n(68198),l=function(){function e(t,n){(0,r.Z)(this,e),this._material=t,this._repository=n,this._map=new Map}return(0,i.Z)(e,[{key:"destroy",value:function(){var e=this;this._map.forEach((function(t,n){(0,a.pC)(t)&&e._repository.release(e._material,c(n))}))}},{key:"load",value:function(e,t){this._map.has(t)||this._map.set(t,this._repository.acquire(this._material,c(t)));var n=this._map.get(t);if((0,a.pC)(n)){if(n.ensureResources(e)===s.Rw.LOADED)return n;this._repository.requestRender()}return null}}]),e}();function c(e){switch(e){case u.C.MATERIAL:return o.H.Color;case u.C.MATERIAL_ALPHA:return o.H.Alpha;case u.C.MATERIAL_DEPTH:return o.H.Depth;case u.C.MATERIAL_NORMAL:return o.H.Normal;case u.C.MATERIAL_DEPTH_SHADOWMAP_ALL:return o.H.Shadow;case u.C.MATERIAL_HIGHLIGHT:return o.H.Highlight;case u.C.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case u.C.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return o.H.Shadow}}},70619:function(e,t,n){n.d(t,{Z:function(){return x}});var r,i=n(11186),a=n(8229),o=n(71353),s=n(55652),u=n(40885),l=n(68401);!function(e){e.length=function(e,t){var n=e[t],r=e[t+1],i=e[t+2];return Math.sqrt(n*n+r*r+i*i)},e.normalize=function(e,t){var n=e[t],r=e[t+1],i=e[t+2],a=1/Math.sqrt(n*n+r*r+i*i);e[t]*=a,e[t+1]*=a,e[t+2]*=a},e.scale=function(e,t,n){e[t]*=n,e[t+1]*=n,e[t+2]*=n},e.add=function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(i=i||e)[a]=e[t]+n[r],i[a+1]=e[t+1]+n[r+1],i[a+2]=e[t+2]+n[r+2]},e.subtract=function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t;(i=i||e)[a]=e[t]-n[r],i[a+1]=e[t+1]-n[r+1],i[a+2]=e[t+2]-n[r+2]}}(r||(r={}));var c,d,h,f,p=n(74894),v=n(81955),g=n(97731),m=n(4760),y=r;!function(e){for(var t=.5,n=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i=[0,0,1,0,1,1,0,1],a=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),o=new Uint16Array(36),s=0;s<6;s++)for(var u=0;u<6;u++)o[6*s+u]=s;for(var l=new Uint16Array(36),c=0;c<6;c++)l[6*c+0]=0,l[6*c+1]=1,l[6*c+2]=2,l[6*c+3]=2,l[6*c+4]=3,l[6*c+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(24),s=0;s<8;s++)t[3*s]=n[s][0]*e[0],t[3*s+1]=n[s][1]*e[1],t[3*s+2]=n[s][2]*e[2];return new p.Z([[m.T.POSITION,{size:3,data:t,exclusive:!0}],[m.T.NORMAL,{size:3,data:r}],[m.T.UV0,{size:2,data:i}]],[[m.T.POSITION,a],[m.T.NORMAL,o],[m.T.UV0,l]])}}(c||(c={})),function(e){var t=.5,n=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],i=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),a=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(18),o=0;o<6;o++)t[3*o]=n[o][0]*e[0],t[3*o+1]=n[o][1]*e[1],t[3*o+2]=n[o][2]*e[2];return new p.Z([[m.T.POSITION,{size:3,data:t,exclusive:!0}],[m.T.NORMAL,{size:3,data:r}]],[[m.T.POSITION,i],[m.T.NORMAL,a]])}}(d||(d={})),function(e){var t=.5,n=(0,a.f)(-t,0,-t),r=(0,a.f)(t,0,-t),o=(0,a.f)(0,0,t),s=(0,a.f)(0,.5,0),u=(0,a.c)(),l=(0,a.c)(),c=(0,a.c)(),d=(0,a.c)(),h=(0,a.c)();(0,i.b)(u,n,s),(0,i.b)(l,n,r),(0,i.f)(c,u,l),(0,i.n)(c,c),(0,i.b)(u,r,s),(0,i.b)(l,r,o),(0,i.f)(d,u,l),(0,i.n)(d,d),(0,i.b)(u,o,s),(0,i.b)(l,o,n),(0,i.f)(h,u,l),(0,i.n)(h,h);var f=[n,r,o,s],v=[0,-1,0,c[0],c[1],c[2],d[0],d[1],d[2],h[0],h[1],h[2]],g=[0,1,2,3,1,0,3,2,1,3,0,2],y=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);for(var t=new Array(12),n=0;n<4;n++)t[3*n]=f[n][0]*e[0],t[3*n+1]=f[n][1]*e[1],t[3*n+2]=f[n][2]*e[2];return new p.Z([[m.T.POSITION,{size:3,data:t,exclusive:!0}],[m.T.NORMAL,{size:3,data:v}]],[[m.T.POSITION,new Uint16Array(g)],[m.T.NORMAL,new Uint16Array(y)]])}}(h||(h={})),function(e){e.createBoxGeometry=c.createGeometry,e.createDiamondGeometry=d.createGeometry,e.createTetrahedronGeometry=h.createGeometry,e.createSphereGeometry=function(e,t,n){for(var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{uv:!0},i=-Math.PI,a=2*Math.PI,o=-Math.PI/2,s=Math.PI,u=Math.max(3,Math.floor(t)),l=Math.max(2,Math.floor(n)),c=(u+1)*(l+1),d=new Float32Array(3*c),h=new Float32Array(3*c),f=new Float32Array(2*c),v=[],g=0,y=0;y<=l;y++){for(var _=[],T=y/l,x=o+T*s,S=Math.cos(x),w=0;w<=u;w++){var O=w/u,C=i+O*a,b=Math.cos(C)*S,A=Math.sin(x),R=-Math.sin(C)*S;d[3*g]=b*e,d[3*g+1]=A*e,d[3*g+2]=R*e,h[3*g]=b,h[3*g+1]=A,h[3*g+2]=R,f[2*g]=O,f[2*g+1]=T,_.push(g),++g}v.push(_)}var P=new Uint32Array(2*u*(l-1)*3);g=0;for(var E=0;E<l;E++)for(var D=0;D<u;D++){var I=v[E][D],M=v[E][D+1],Z=v[E+1][D+1],H=v[E+1][D];0===E?(P[g++]=I,P[g++]=Z,P[g++]=H):E===l-1?(P[g++]=I,P[g++]=M,P[g++]=Z):(P[g++]=I,P[g++]=M,P[g++]=Z,P[g++]=Z,P[g++]=H,P[g++]=I)}var N=[[m.T.POSITION,P],[m.T.NORMAL,P]],L=[[m.T.POSITION,{size:3,data:d,exclusive:!0}],[m.T.NORMAL,{size:3,data:h,exclusive:!0}]];return r.uv&&(L.push([m.T.UV0,{size:2,data:f,exclusive:!0}]),N.push([m.T.UV0,P])),r.offset&&(N[0][0]=m.T.OFFSET,L[0][0]=m.T.OFFSET,N.push([m.T.POSITION,new Uint32Array(P.length)]),L.push([m.T.POSITION,{size:3,data:Float64Array.from(r.offset),exclusive:!0}])),new p.Z(L,N)},e.createPolySphereGeometry=function(e,t,n){var r,i,a=e;if(n)r=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],i=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{var o=a*(1+Math.sqrt(5))/2;r=[-a,o,0,a,o,0,-a,-o,0,a,-o,0,0,-a,o,0,a,o,0,-a,-o,0,a,-o,o,0,-a,o,0,a,-o,0,-a,-o,0,a],i=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(var s=0;s<r.length;s+=3)y.scale(r,s,e/y.length(r,s));var u={};function l(t,n){var i;t>n&&(t=(i=[n,t])[0],n=i[1]);var a=t.toString()+"."+n.toString();if(u[a])return u[a];var o=r.length;return r.length+=3,y.add(r,3*t,r,3*n,r,o),y.scale(r,o,e/y.length(r,o)),o/=3,u[a]=o,o}for(var c=0;c<t;c++){for(var d=i.length,h=new Uint32Array(4*d),f=0;f<d;f+=3){var v=i[f],g=i[f+1],_=i[f+2],T=l(v,g),x=l(g,_),S=l(_,v),w=4*f;h[w]=v,h[w+1]=T,h[w+2]=S,h[w+3]=g,h[w+4]=x,h[w+5]=T,h[w+6]=_,h[w+7]=S,h[w+8]=x,h[w+9]=T,h[w+10]=x,h[w+11]=S}i=h,u={}}for(var O=new Float32Array(r),C=0;C<O.length;C+=3)y.normalize(O,C);var b=[[m.T.POSITION,i],[m.T.NORMAL,i]],A=[[m.T.POSITION,{size:3,data:new Float32Array(r),exclusive:!0}],[m.T.NORMAL,{size:3,data:O,exclusive:!0}]];return new p.Z(A,b)},e.createPointGeometry=function(e,t,n,r,i,a,o){var s=t?[t[0],t[1],t[2]]:[0,0,0],u=e?[e[0],e[1],e[2]]:[0,0,1];a=a||[0,0];var c=n?[255*n[0],255*n[1],255*n[2],n.length>3?255*n[3]:255]:[255,255,255,255],d=null!=r&&2===r.length?r:[1,1],h=[[m.T.POSITION,{size:3,data:s,exclusive:!0}],[m.T.NORMAL,{size:3,data:u,exclusive:!0}],[m.T.UV0,{size:a.length,data:a}],[m.T.COLOR,{size:4,data:c,exclusive:!0}],[m.T.SIZE,{size:2,data:d}]];if(null!=i){var f=new Float32Array([i[0],i[1],i[2],i[3]]);h.push([m.T.AUXPOS1,{size:4,data:f}])}if(null!=o){var v=new Float32Array([o[0],o[1],o[2],o[3]]);h.push([m.T.AUXPOS2,{size:4,data:v}])}return new p.Z(h,null,l.MX.Point)},e.updatePointGeometry=function(e,t,n,r,i,a,o,s){if(null!=e){var u=s.getMutableAttribute(m.T.NORMAL).data;u[0]=e[0],u[1]=e[1],u[2]=e[2]}if(null!=t){var l=s.getMutableAttribute(m.T.POSITION).data;l[0]=t[0],l[1]=t[1],l[2]=t[2]}if(null!=n){var c=s.getMutableAttribute(m.T.COLOR).data;c[0]=n[0],c[1]=n[1],c[2]=n[2],c[3]=n[3]}if(null!=r){var d=s.getMutableAttribute(m.T.SIZE).data;d[0]=r[0],d[1]=r[1]}if(null!=i){var h=s.getMutableAttribute(m.T.AUXPOS1).data;h[0]=i[0],h[1]=i[1],h[2]=i[2],h[3]=i[3]}if(null!=a){var f=s.getMutableAttribute(m.T.UV0).data;f[0]=a[0],f[1]=a[1]}if(null!=o){var p=s.getMutableAttribute(m.T.AUXPOS2).data;p[0]=o[0],p[1]=o[1],p[2]=o[2],p[3]=o[3]}},e.createPointArrayGeometry=function(e,t){for(var n=new Float32Array(3*e.length),r=new Float32Array(t?3*e.length:3),i=new Uint32Array(e.length),a=new Uint32Array(e.length),o=0;o<e.length;o++)n[3*o]=e[o][0],n[3*o+1]=e[o][1],n[3*o+2]=e[o][2],t&&(r[3*o]=t[o][0],r[3*o+1]=t[o][1],r[3*o+2]=t[o][2]),i[o]=o,a[o]=0;t||(r[0]=0,r[1]=1,r[2]=0);var s=[[m.T.POSITION,i],[m.T.NORMAL,t?i:a],[m.T.UV0,a]],u=[[m.T.POSITION,{size:3,data:n,exclusive:!0}],[m.T.NORMAL,{size:3,data:r,exclusive:!0}],[m.T.UV0,{size:2,data:[0,0],exclusive:!0}]];return new p.Z(u,s,l.MX.Point)},e.createTriangleGeometry=function(){var e=new Uint16Array([0,1,2]),t=new Uint16Array([0,0,0]),n=new Uint16Array([0,0,0]),r=[[m.T.POSITION,e],[m.T.NORMAL,t],[m.T.UV0,n]],i=[[m.T.POSITION,{size:3,data:[0,0,0,0,0,100,100,0,0],exclusive:!0}],[m.T.NORMAL,{size:3,data:[0,1,0],exclusive:!0}],[m.T.UV0,{size:2,data:[0,0],exclusive:!0}]];return new p.Z(i,r)};var t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function n(e,t,n,r,a){return!(Math.abs((0,i.e)(t,e))>a)&&((0,i.f)(n,e,t),(0,i.n)(n,n),(0,i.f)(r,n,e),(0,i.n)(r,r),!0)}function r(e,t,r,i,a,o,s){return n(e,t,a,o,s)||n(e,r,a,o,s)||n(e,i,a,o,s)}e.createSquareGeometry=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t,n=new Array(12),r=0;r<4;r++)for(var i=0;i<3;i++)n[3*r+i]=e[r][i];var a=new Uint32Array([0,1,2,2,3,0]),o=[0,0,1],s=new Uint32Array([0,0,0,0,0,0]),u=[0,0,1,0,1,1,0,1],l=[255,255,255,255],c=[[m.T.POSITION,a],[m.T.NORMAL,s],[m.T.UV0,a],[m.T.COLOR,s]],d=[[m.T.POSITION,{size:3,data:n,exclusive:!0}],[m.T.NORMAL,{size:3,data:o,exclusive:!0}],[m.T.UV0,{size:2,data:u,exclusive:!0}],[m.T.COLOR,{size:4,data:l,exclusive:!0}]];return new p.Z(d,c)},e.createConeGeometry=function(e,t,n,r){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=0,u=t,l=e,c=(0,a.f)(0,s,0),d=(0,a.f)(0,s+l,0),h=(0,a.f)(0,-1,0),f=(0,a.f)(0,1,0);r&&(s=l,d=(0,a.f)(0,0,0),c=(0,a.f)(0,s,0),h=(0,a.f)(0,1,0),f=(0,a.f)(0,-1,0));var v=[d,c],g=[h,f],y=n+2,_=Math.sqrt(l*l+u*u);if(r)for(var T=n-1;T>=0;T--){var x=T*(2*Math.PI/n),S=(0,a.f)(Math.cos(x)*u,s,Math.sin(x)*u);v.push(S);var w=(0,a.f)(l*Math.cos(x)/_,-u/_,l*Math.sin(x)/_);g.push(w)}else for(var O=0;O<n;O++){var C=O*(2*Math.PI/n),b=(0,a.f)(Math.cos(C)*u,s,Math.sin(C)*u);v.push(b);var A=(0,a.f)(l*Math.cos(C)/_,u/_,l*Math.sin(C)/_);g.push(A)}var R=new Uint32Array(2*(n+2)*3),P=new Uint32Array(2*(n+2)*3),E=0,D=0;if(i){for(var I=3;I<v.length;I++)R[E++]=1,R[E++]=I-1,R[E++]=I,P[D++]=0,P[D++]=0,P[D++]=0;R[E++]=v.length-1,R[E++]=2,R[E++]=1,P[D++]=0,P[D++]=0,P[D++]=0}if(o){for(var M=3;M<v.length;M++)R[E++]=M,R[E++]=M-1,R[E++]=0,P[D++]=M,P[D++]=M-1,P[D++]=1;R[E++]=0,R[E++]=2,R[E++]=v.length-1,P[D++]=1,P[D++]=2,P[D++]=g.length-1}for(var Z=new Float32Array(3*y),H=0;H<y;H++)Z[3*H]=v[H][0],Z[3*H+1]=v[H][1],Z[3*H+2]=v[H][2];for(var N=new Float32Array(3*y),L=0;L<y;L++)N[3*L]=g[L][0],N[3*L+1]=g[L][1],N[3*L+2]=g[L][2];var k=[[m.T.POSITION,R],[m.T.NORMAL,P]],F=[[m.T.POSITION,{size:3,data:Z,exclusive:!0}],[m.T.NORMAL,{size:3,data:N,exclusive:!0}]];return new p.Z(F,k)},e.createCylinderGeometry=function(e,t,n,r,o,s){var u=r?(0,a.a)(r):(0,a.f)(1,0,0),l=o?(0,a.a)(o):(0,a.f)(0,0,0);s=null==s||s;var c=(0,a.c)();(0,i.n)(c,u);var d=(0,a.c)();(0,i.g)(d,c,Math.abs(e));var h=(0,a.c)();(0,i.g)(h,d,-.5),(0,i.a)(h,h,l);var f=(0,a.f)(0,1,0);Math.abs(1-(0,i.e)(c,f))<.2&&(0,i.s)(f,0,0,1);var v=(0,a.c)();(0,i.f)(v,c,f),(0,i.n)(v,v),(0,i.f)(f,v,c);var g=2*n+(s?2:0),y=n+(s?2:0),_=new Float32Array(3*g),T=new Float32Array(3*y),x=new Float32Array(2*g),S=new Uint32Array(3*n*(s?4:2)),w=new Uint32Array(3*n*(s?4:2));s&&(_[3*(g-2)+0]=h[0],_[3*(g-2)+1]=h[1],_[3*(g-2)+2]=h[2],x[2*(g-2)]=0,x[2*(g-2)+1]=0,_[3*(g-1)+0]=_[3*(g-2)+0]+d[0],_[3*(g-1)+1]=_[3*(g-2)+1]+d[1],_[3*(g-1)+2]=_[3*(g-2)+2]+d[2],x[2*(g-1)]=1,x[2*(g-1)+1]=1,T[3*(y-2)+0]=-c[0],T[3*(y-2)+1]=-c[1],T[3*(y-2)+2]=-c[2],T[3*(y-1)+0]=c[0],T[3*(y-1)+1]=c[1],T[3*(y-1)+2]=c[2]);for(var O=function(e,t,n){S[e]=t,w[e]=n},C=0,b=(0,a.c)(),A=(0,a.c)(),R=0;R<n;R++){var P=R*(2*Math.PI/n);(0,i.g)(b,f,Math.sin(P)),(0,i.g)(A,v,Math.cos(P)),(0,i.a)(b,b,A),T[3*R+0]=b[0],T[3*R+1]=b[1],T[3*R+2]=b[2],(0,i.g)(b,b,t),(0,i.a)(b,b,h),_[3*R+0]=b[0],_[3*R+1]=b[1],_[3*R+2]=b[2],x[2*R+0]=R/n,x[2*R+1]=0,_[3*(R+n)+0]=_[3*R+0]+d[0],_[3*(R+n)+1]=_[3*R+1]+d[1],_[3*(R+n)+2]=_[3*R+2]+d[2],x[2*(R+n)+0]=R/n,x[2*R+1]=1;var E=(R+1)%n;O(C++,R,R),O(C++,R+n,R),O(C++,E,E),O(C++,E,E),O(C++,R+n,R),O(C++,E+n,E)}if(s){for(var D=0;D<n;D++){var I=(D+1)%n;O(C++,g-2,y-2),O(C++,D,y-2),O(C++,I,y-2)}for(var M=0;M<n;M++){var Z=(M+1)%n;O(C++,M+n,y-1),O(C++,g-1,y-1),O(C++,Z+n,y-1)}}var H=[[m.T.POSITION,S],[m.T.NORMAL,w],[m.T.UV0,S]],N=[[m.T.POSITION,{size:3,data:_,exclusive:!0}],[m.T.NORMAL,{size:3,data:T,exclusive:!0}],[m.T.UV0,{size:2,data:x,exclusive:!0}]];return new p.Z(N,H)},e.createTubeGeometry=function(t,n,r,i,a){r=r||10,i=null==i||i,(0,g.hu)(t.length>1);for(var o=[],s=[],u=0;u<r;u++){o.push([0,-u-1,-(u+1)%r-1]);var l=u/r*2*Math.PI;s.push([Math.cos(l)*n,Math.sin(l)*n])}return e.createPathExtrusionGeometry(s,t,[[0,0,0]],o,i,a)},e.createPathExtrusionGeometry=function(e,t,n,l,c){var d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:(0,a.f)(0,0,0),h=e.length,f=new Float32Array(t.length*h*3+(6*n.length||0)),v=new Float32Array(t.length*h*3+(n?6:0)),g=(t.length-1)*h*6+3*l.length*2,y=new Uint32Array(g),T=new Uint32Array(g),x=0,S=0,w=0,O=0,C=(0,a.c)(),b=(0,a.c)(),A=(0,a.c)(),R=(0,a.c)(),P=(0,a.c)(),E=(0,a.c)(),D=(0,a.c)(),I=(0,o.c)(),M=(0,a.c)(),Z=(0,a.c)(),H=(0,a.c)(),N=(0,a.c)(),L=(0,a.c)(),k=(0,s.Ue)();(0,i.s)(M,0,1,0),(0,i.b)(b,t[1],t[0]),(0,i.n)(b,b),c?((0,i.a)(I,t[0],d),(0,i.n)(A,I)):(0,i.s)(A,0,0,1),r(b,A,M,M,P,A,_),(0,i.c)(R,A),(0,i.c)(N,P);for(var F=0;F<n.length;F++)(0,i.g)(E,P,n[F][0]),(0,i.g)(I,A,n[F][2]),(0,i.a)(E,E,I),(0,i.a)(E,E,t[0]),f[x++]=E[0],f[x++]=E[1],f[x++]=E[2];v[S++]=-b[0],v[S++]=-b[1],v[S++]=-b[2];for(var z=0;z<l.length;z++)y[w++]=l[z][0]>0?l[z][0]:-l[z][0]-1+n.length,y[w++]=l[z][1]>0?l[z][1]:-l[z][1]-1+n.length,y[w++]=l[z][2]>0?l[z][2]:-l[z][2]-1+n.length,T[O++]=0,T[O++]=0,T[O++]=0;for(var U=n.length,V=n.length-1,j=0;j<t.length;j++){var W=!1;j>0&&((0,i.c)(C,b),j<t.length-1?((0,i.b)(b,t[j+1],t[j]),(0,i.n)(b,b)):W=!0,(0,i.a)(Z,C,b),(0,i.n)(Z,Z),(0,i.a)(H,t[j-1],R),(0,s.Yq)(t[j],Z,k),(0,s.BR)(k,(0,u.re)(H,C),I)?((0,i.b)(I,I,t[j]),(0,i.n)(A,I),(0,i.f)(P,Z,A),(0,i.n)(P,P)):r(Z,R,N,M,P,A,_),(0,i.c)(R,A),(0,i.c)(N,P)),c&&((0,i.a)(I,t[j],d),(0,i.n)(L,I));for(var B=0;B<h;B++)if((0,i.g)(E,P,e[B][0]),(0,i.g)(I,A,e[B][1]),(0,i.a)(E,E,I),(0,i.n)(D,E),v[S++]=D[0],v[S++]=D[1],v[S++]=D[2],(0,i.a)(E,E,t[j]),f[x++]=E[0],f[x++]=E[1],f[x++]=E[2],!W){var G=(B+1)%h;y[w++]=U+B,y[w++]=U+h+B,y[w++]=U+G,y[w++]=U+G,y[w++]=U+h+B,y[w++]=U+h+G;for(var q=0;q<6;q++)T[O++]=y[w-6+q]-V}U+=h}for(var X=t[t.length-1],J=0;J<n.length;J++)(0,i.g)(E,P,n[J][0]),(0,i.g)(I,A,n[J][1]),(0,i.a)(E,E,I),(0,i.a)(E,E,X),f[x++]=E[0],f[x++]=E[1],f[x++]=E[2];var Y=S/3;v[S++]=b[0],v[S++]=b[1],v[S++]=b[2];for(var Q=U-h,K=0;K<l.length;K++)y[w++]=l[K][0]>=0?U+l[K][0]:-l[K][0]-1+Q,y[w++]=l[K][2]>=0?U+l[K][2]:-l[K][2]-1+Q,y[w++]=l[K][1]>=0?U+l[K][1]:-l[K][1]-1+Q,T[O++]=Y,T[O++]=Y,T[O++]=Y;var $=[[m.T.POSITION,y],[m.T.NORMAL,T]],ee=[[m.T.POSITION,{size:3,data:f,exclusive:!0}],[m.T.NORMAL,{size:3,data:v,exclusive:!0}]];return new p.Z(ee,$)},e.createPolylineGeometry=function(e,t,n){(0,g.hu)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,g.hu)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),(0,g.hu)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),(0,g.hu)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");for(var r=new Float64Array(3*e.length),i=new Uint32Array(2*(e.length-1)),a=0,o=0,s=0;s<e.length;s++){for(var u=0;u<3;u++)r[a++]=e[s][u];s>0&&(i[o++]=s-1,i[o++]=s)}var c=[],d=[];if(c.push([m.T.POSITION,i]),d.push([m.T.POSITION,{size:3,data:r,exclusive:!0}]),t){for(var h=new Float32Array(3*t.length),f=0,y=0;y<e.length;y++)for(var _=0;_<3;_++)h[f++]=t[y][_];c.push([m.T.NORMAL,i]),d.push([m.T.NORMAL,{size:3,data:h,exclusive:!0}])}return n&&(d.push([m.T.COLOR,{size:4,data:n}]),c.push([m.T.COLOR,(0,v.p)(n.length/4)])),new p.Z(d,c,l.MX.Line)},e.createExtrudedTriangle=function(e,t,n,r){for(var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=new Array(18),o=[[-t,i,r/2],[n,i,r/2],[0,e+i,r/2],[-t,i,-r/2],[n,i,-r/2],[0,e+i,-r/2]],s=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]),u=0;u<6;u++)a[3*u]=o[u][0],a[3*u+1]=o[u][1],a[3*u+2]=o[u][2];return new p.Z([[m.T.POSITION,{size:3,data:a,exclusive:!0}]],[[m.T.POSITION,s]])},e.transformInPlace=function(e,t){for(var n=e.getMutableAttribute(m.T.POSITION).data,r=0;r<n.length;r+=3){var a=n[r],o=n[r+1],s=n[r+2];(0,i.s)(T,a,o,s),(0,i.m)(T,T,t),n[r]=T[0],n[r+1]=T[1],n[r+2]=T[2]}},e.cgToGIS=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,n=e.vertexAttributes,r=n.get(m.T.POSITION).data,i=n.get(m.T.NORMAL).data;if(i)for(var a=t.getMutableAttribute(m.T.NORMAL).data,o=0;o<i.length;o+=3){var s=i[o+1];a[o+1]=-i[o+2],a[o+2]=s}if(r)for(var u=t.getMutableAttribute(m.T.POSITION).data,l=0;l<r.length;l+=3){var c=r[l+1];u[l+1]=-r[l+2],u[l+2]=c}return t},e.makeOrthoBasisDirUp=n,e.makeOrthoBasisDirUpFallback=r}(f||(f={}));var _=.99619469809,T=(0,a.c)(),x=f},87145:function(e,t,n){n.d(t,{C:function(){return x}});var r=n(93433),i=n(15671),a=n(43144),o=n(92026),s=n(95439),u=n(81949),l=n(11186),c=n(71353),d=n(67077),h=n(79803),f=n(68401),p=n(74894),v=n(61403),g=n(59887),m=null,y=n(4760),_=n(97882),T=n(58901),x=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:125e4;(0,i.Z)(this,e),this._originSR=t,this._gridSize=n,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+(0,s.D)()}return(0,a.Z)(e,[{key:"getOrigin",value:function(e){var t=this._origins.get(this._rootOriginId);if(null==t){var n=m;if((0,o.pC)(n))return this._origins.set(this._rootOriginId,(0,v.al)(n[0],n[1],n[2],this._rootOriginId)),this.getOrigin(e);var i=(0,v.al)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,i),i}var a=this._gridSize,s=Math.round(e[0]/a),u=Math.round(e[1]/a),c=Math.round(e[2]/a),d="".concat(s,"/").concat(u,"/").concat(c),h=this._origins.get(d),f=.5*a;if((0,l.b)(S,e,t.vec3),S[0]=Math.abs(S[0]),S[1]=Math.abs(S[1]),S[2]=Math.abs(S[2]),S[0]<f&&S[1]<f&&S[2]<f){if(h){var p=Math.max.apply(Math,(0,r.Z)(S));if((0,l.b)(S,e,h.vec3),S[0]=Math.abs(S[0]),S[1]=Math.abs(S[1]),S[2]=Math.abs(S[2]),Math.max.apply(Math,(0,r.Z)(S))<p)return h}return t}return h||(h=(0,v.al)(s*a,u*a,c*a,d),this._origins.set(d,h)),h}},{key:"_drawOriginBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.f)(1,1,0,1),n=window.view,r=n._stage,i=t.toString();if(!this._objects.has(i)){this._material=new T.U({width:2,color:t}),r.add(this._material);var a=new _.F({isPickable:!1}),o=new g.T({castShadow:!1});r.add(o),a.add(o),r.add(a),this._objects.set(i,o)}for(var s=this._objects.get(i),l=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],c=l.length,v=new Array(3*c),m=new Uint16Array(2*(c-1)),x=.5*this._gridSize,S=0;S<c;S++)v[3*S+0]=e[0]+(1&l[S]?x:-x),v[3*S+1]=e[1]+(2&l[S]?x:-x),v[3*S+2]=e[2]+(4&l[S]?x:-x),S>0&&(m[2*S+0]=S-1,m[2*S+1]=S);(0,h.CM)(v,this._originSR,0,v,n.renderSpatialReference,0,c);var w=new p.Z([[y.T.POSITION,{size:3,data:v,exclusive:!0}]],[[y.T.POSITION,m]],f.MX.Line);r.add(w),s.addGeometry(w,this._material,u.I)}}]),e}(),S=(0,c.c)()},81268:function(e,t,n){n.d(t,{Z8:function(){return w},LP:function(){return A}});var r=n(60136),i=n(54062),a=n(37762),o=n(15671),s=n(43144),u=n(92026),l=n(14226),c=n(81949),d=n(11186),h=n(71353),f=n(90045),p=n(67077),v=n(40885),g=n(50951),m=n(54463);n(82218);function y(e){return(0,u.pC)(e)&&(0,u.pC)(e.dist)}(0,h.c)();var _=n(76783),T=n(32683),x=1e-5,S=function(){function e(t){(0,o.Z)(this,e),this.options=new m.om,this._results=new O,this.transform=new _.yn,this.tolerance=x,this.verticalOffset=null,this._ray=(0,v.Ue)(),this._rayEnd=(0,h.c)(),this._rayBeginTransformed=(0,h.c)(),this._rayEndTransformed=(0,h.c)(),this.viewingMode=null==t?g.JY.Global:t}return(0,s.Z)(e,[{key:"results",get:function(){return this._results}},{key:"ray",get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}},{key:"reset",value:function(e,t,n){this.resetWithRay((0,v.zk)(e,t,this._ray),n)}},{key:"resetWithRay",value:function(e,t){this.camera=t,e!==this._ray&&(0,v.JG)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===g.JY.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,d.a)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}},{key:"intersect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;this.point=n,this.filterPredicate=i,this.tolerance=null==r?x:r;var s=(0,_.W9)(this.verticalOffset);(0,u.pC)(t)&&t.length>0&&function(){var n,r=o?function(t){o(t)&&e.intersectObject(t)}:function(t){e.intersectObject(t)},i=(0,a.Z)(t);try{for(i.s();!(n=i.n()).done;){var l=n.value,c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();(0,u.pC)(c)?((0,u.pC)(s)?c.forEachAlongRayWithVerticalOffset(e._ray.origin,e._ray.direction,r,s):c.forEachAlongRay(e._ray.origin,e._ray.direction,r),e.options.selectionMode&&e.options.hud&&c.forEachDegenerateObject(r)):l.objects.forAll((function(e){return r(e)}))}}catch(d){i.e(d)}finally{i.f()}}(),this.sortResults()}},{key:"intersectObject",value:function(e){var t=this,n=e.geometryRecords;if(n){var r,i=e.transformation,o=(0,_.W9)(this.verticalOffset),s=(0,a.Z)(n);try{var l=function(){var n=r.value,a=n.geometry,s=n.material,l=n.instanceParameters;if((0,T.PD)(l))return"continue";var h=a.id;t.transform.setAndInvalidateLazyTransforms(i,n.getShaderTransformation()),(0,d.m)(t._rayBeginTransformed,t.rayBegin,t.transform.inverse),(0,d.m)(t._rayEndTransformed,t.rayEnd,t.transform.inverse);var f=t.transform.transform;(0,u.pC)(o)&&(o.objectTransform=t.transform),s.intersect(a,l,t.transform.transform,t,t._rayBeginTransformed,t._rayEndTransformed,(function(n,r,i,a,o,s){if(n>=0){if((0,u.pC)(t.filterPredicate)&&!t.filterPredicate(t._ray.origin,t._rayEnd,n))return;var l=a?t._results.hud:t._results,d=a?function(t){var a={object:e,geometryId:h,triangleNr:i,center:(0,u.pC)(s)?[s[0],s[1],s[2]]:null};t.set(m.q7.HUD,a,n,r,c.I,o)}:function(t){return t.set(m.q7.OBJECT,{object:e,geometryId:h,triangleNr:i},n,r,f,o)};if((null==l.min.drapedLayerOrder||o>=l.min.drapedLayerOrder)&&(null==l.min.dist||n<l.min.dist)&&d(l.min),t.options.store!==m.eC.MIN&&(null==l.max.drapedLayerOrder||o<l.max.drapedLayerOrder)&&(null==l.max.dist||n>l.max.dist)&&d(l.max),t.options.store===m.eC.ALL)if(a){var p=new b(t._ray);d(p),t._results.hud.all.push(p)}else{var v=new C(t._ray);d(v),t._results.all.push(v)}}}),n.shaderTransformation)};for(s.s();!(r=s.n()).done;)l()}catch(h){s.e(h)}finally{s.f()}}}},{key:"sortResults",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._results.all;e.sort((function(e,t){return e.dist!==t.dist?(0,u.Pt)(e.dist,0)-(0,u.Pt)(t.dist,0):e.drapedLayerOrder!==t.drapedLayerOrder?(0,u.Pt)(e.drapedLayerOrder,Number.MAX_VALUE)-(0,u.Pt)(t.drapedLayerOrder,Number.MAX_VALUE):(0,u.Pt)(t.drapedLayerGraphicOrder,Number.MIN_VALUE)-(0,u.Pt)(e.drapedLayerGraphicOrder,Number.MIN_VALUE)}))}}]),e}();function w(e){return new S(e)}var O=function(){function e(){(0,o.Z)(this,e),this.min=new C((0,v.Ue)()),this.max=new C((0,v.Ue)()),this.hud={min:new b((0,v.Ue)()),max:new b((0,v.Ue)()),all:new Array},this.ground=new C((0,v.Ue)()),this.all=[]}return(0,s.Z)(e,[{key:"init",value:function(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}]),e}(),C=function(){function e(t){(0,o.Z)(this,e),this.intersector=m.q7.OBJECT,this.normal=(0,h.c)(),this.transformation=(0,c.c)(),this._ray=(0,v.Ue)(),this.init(t)}return(0,s.Z)(e,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return(0,u.pC)(this.dist)?((0,d.g)(R,this.ray.direction,this.dist),(0,d.l)(R)):null}},{key:"getIntersectionPoint",value:function(e){return!!y(this)&&((0,d.g)(R,this.ray.direction,this.dist),(0,d.a)(e,this.ray.origin,R),!0)}},{key:"getTransformedNormal",value:function(e){return(0,d.c)(P,this.normal),P[3]=0,(0,f.t)(P,P,this.transformation),(0,d.c)(e,P),(0,d.n)(e,e)}},{key:"init",value:function(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=m.q7.OBJECT,(0,v.JG)(e,this._ray)}},{key:"set",value:function(e,t,n,r,i,a,o){this.intersector=e,this.dist=n,(0,d.c)(this.normal,(0,u.Pt)(r,h.U)),(0,l.c)(this.transformation,(0,u.Pt)(i,c.I)),this.target=t,this.drapedLayerOrder=a,this.drapedLayerGraphicOrder=o}},{key:"copy",value:function(e){(0,v.JG)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,d.c)(this.normal,e.normal),(0,l.c)(this.transformation,e.transformation)}}]),e}(),b=function(e){(0,r.Z)(n,e);var t=(0,i.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).intersector=m.q7.HUD,e}return(0,s.Z)(n)}(C);function A(e){return new C(e)}var R=(0,h.c)(),P=(0,p.c)()},54463:function(e,t,n){n.d(t,{eC:function(){return i},om:function(){return s},q7:function(){return r}});var r,i,a=n(43144),o=n(15671);!function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"}(r||(r={}));var s=(0,a.Z)((function e(){(0,o.Z)(this,e),this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=i.ALL}));!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(i||(i={}))},61403:function(e,t,n){n.d(t,{al:function(){return s}});var r=n(43144),i=n(15671),a=n(71353),o=(0,r.Z)((function e(t,n){(0,i.Z)(this,e),this.vec3=t,this.id=n}));function s(e,t,n,r){return new o((0,a.f)(e,t,n),r)}},78289:function(e,t,n){var r;n.d(t,{$:function(){return r}}),function(e){var t,n;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(n=e.State||(e.State={}))[n.VISIBILITIES=1]="VISIBILITIES",n[n.VERTEXATTRS=2]="VERTEXATTRS",n[n.TRANSFORMATION=4]="TRANSFORMATION",n[n.HIGHLIGHTS=8]="HIGHLIGHTS",n[n.OCCLUDEES=16]="OCCLUDEES"}(r||(r={}))},59887:function(e,t,n){n.d(t,{T:function(){return O}});var r=n(37762),i=n(15671),a=n(43144),o=n(60136),s=n(54062),u=n(92026),l=n(14226),c=n(81949),d=n(11186),h=n(71353),f=n(23470),p=n(80064),v=n(68401),g=n(1395),m=n(79100),y=n(13005),_=n(95439),T=function(){function e(){(0,i.Z)(this,e),this._disposed=!1}return(0,a.Z)(e,[{key:"disposed",get:function(){return this._disposed}},{key:"shaderTransformation",get:function(){return this._shaderTransformation}},{key:"acquire",value:function(e,t,n,r,i,a){this.id=(0,_.D)(),this.geometry=e,this.material=t,this.transformation=n,this.instanceParameters=r,this.origin=i,this._shaderTransformation=a,this._disposed=!1}},{key:"release",value:function(){this._disposed=!1}},{key:"dispose",value:function(){this._disposed=!0}},{key:"getStaticTransformation",value:function(){return this.transformation}},{key:"getShaderTransformation",value:function(){return(0,u.pC)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}},{key:"computeAttachmentOrigin",value:function(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&((0,d.m)(e,e,this.getStaticTransformation()),!0)}}]),e}();T.pool=new y.Z(T);var x=n(47669),S=n(97731),w=n(32683),O=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.Z)(this,n),(e=t.call(this)).type=m.U.Object,e._geometryRecords=new Array,e._geometries=new Array,e._objectTransformation=(0,c.c)(),e._bvObjectSpace=new b,e._bvWorldSpace=new b,e._bvDirty=!0,e._hasVolatileTransformation=!1,e._visible=!0,e.castShadow=null==r.castShadow||r.castShadow,e.metadata=r.metadata,e.metadata&&e.metadata.isElevationSource&&(e.metadata.lastValidElevationBB=new C),e.transformation=(0,c.c)();var a=r.geometries,o=r.materials,s=r.transformations,u=r.origins;if(Array.isArray(a)){(0,S.hu)(o.length===a.length,"Object3D: materials don't match geometries"),(0,S.hu)(s.length===a.length,"Object3D: transformations don't match geometries"),e._geometryRecords.length=a.length,e._geometries.length=a.length;for(var l=0;l<a.length;l++)e._geometries[l]=a[l],e._geometryRecords[l]=T.pool.acquire(a[l],o[l],(0,c.b)(s[l]),{highlights:null,occludees:null,visible:e._visible},u&&u[l])}return e}return(0,a.Z)(n,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"transformation",get:function(){return this._objectTransformation},set:function(e){(0,l.c)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}},{key:"dispose",value:function(){this._geometryRecords.length=0,this._geometries.length=0}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(e){(0,S.hu)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}},{key:"addGeometry",value:function(e,t,n,r,i){n=n||c.I,this._geometries.push(e);var a=T.pool.acquire(e,t,n,{highlights:null,occludees:null,visible:this._visible},r,i);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._hasVolatileTransformation||(0,u.pC)(a.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:a}),this._invalidateBoundingVolume(),a}},{key:"removeGeometry",value:function(e){var t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=(0,u.pC)(t.shaderTransformation)?this._geometryRecords.some((function(e){return(0,u.pC)(e.shaderTransformation)})):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}},{key:"removeAllGeometries",value:function(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}},{key:"geometryVertexAttrsUpdated",value:function(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}},{key:"isVisible",get:function(){return this._visible}},{key:"setVisible",value:function(e){if(this._visible!==e){this._visible=e;var t,n=(0,r.Z)(this._geometryRecords);try{for(n.s();!(t=n.n()).done;){t.value.instanceParameters.visible=this._visible}}catch(i){n.e(i)}finally{n.f()}this._emit("visibilityChanged",this)}}},{key:"maskOccludee",value:function(){var e,t=new x.O(v.V_.MaskOccludee),n=(0,r.Z)(this._geometryRecords);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.instanceParameters.occludees=(0,w.lr)(i.instanceParameters.occludees,t)}}catch(a){n.e(a)}finally{n.f()}return this._emit("occlusionChanged",this),t}},{key:"removeOcclude",value:function(e){var t,n=(0,r.Z)(this._geometryRecords);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.instanceParameters.occludees=(0,w.U_)(i.instanceParameters.occludees,e)}}catch(a){n.e(a)}finally{n.f()}this._emit("occlusionChanged",this)}},{key:"highlight",value:function(){var e,t=new x.O(v.V_.Highlight),n=(0,r.Z)(this._geometryRecords);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.instanceParameters.highlights=(0,w.lr)(i.instanceParameters.highlights,t)}}catch(a){n.e(a)}finally{n.f()}return this._emit("highlightChanged",this),t}},{key:"removeHighlight",value:function(e){var t,n=(0,r.Z)(this._geometryRecords);try{for(n.s();!(t=n.n()).done;){var i=t.value;i.instanceParameters.highlights=(0,w.U_)(i.instanceParameters.highlights,e)}}catch(a){n.e(a)}finally{n.f()}this._emit("highlightChanged",this)}},{key:"getCombinedStaticTransformation",value:function(e,t){return(0,l.m)((0,u.Pt)(t,(0,c.c)()),this.transformation,e.getStaticTransformation())}},{key:"_getCombinedShaderTransformation",value:function(e,t){return t=t||(0,c.c)(),(0,l.m)(t,this.transformation,e.getShaderTransformation()),t}},{key:"hasVolativeTransformation",value:function(){return this._hasVolatileTransformation}},{key:"boundingVolumeWorldSpace",get:function(){return this._validateBoundingVolume(),this._bvWorldSpace}},{key:"boundingVolumeObjectSpace",get:function(){return this._validateBoundingVolume(),this._bvObjectSpace}},{key:"_validateBoundingVolume",value:function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var e=0;e<this._geometryRecords.length;++e){var t=this._geometries[e],n=this._geometryRecords[e],r=t.boundingInfo;(0,u.pC)(r)&&(this._calculateTransformedBoundingVolume(r,this._bvObjectSpace,n.getShaderTransformation()),this._calculateTransformedBoundingVolume(r,this._bvWorldSpace,this._getCombinedShaderTransformation(n)))}(0,d.h)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),(0,d.h)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);for(var i=(0,h.c)(),a=(0,h.c)(),o=(0,p.u1)(this.transformation),s=0;s<this._geometryRecords.length;++s){var l=this._geometries[s].boundingInfo;if(!(0,u.Wi)(l)){var c=this._geometryRecords[s].getShaderTransformation(),f=(0,p.u1)(c);(0,d.m)(i,l.getCenter(),c);var v=(0,d.i)(i,this._bvObjectSpace.bounds),g=l.getBSRadius()*f;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],v+g),(0,d.m)(a,i,this.transformation);var m=(0,d.i)(a,this._bvWorldSpace.bounds),y=g*o;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],m+y)}}this._bvDirty=!1}}},{key:"_calculateTransformedBoundingVolume",value:function(e,t,n){var r=e.getBBMin(),i=e.getBBMax(),a=(0,h.a)(r),o=(0,h.a)(i);(0,d.m)(a,a,n),(0,d.m)(o,o,n);for(var s=0;s<3;++s)t.min[s]=Math.min(t.min[s],a[s],o[s]),t.max[s]=Math.max(t.max[s],a[s],o[s]);for(var u=0;u<3;++u){(0,d.c)(a,r),(0,d.c)(o,i),a[u]=i[u],o[u]=r[u],(0,d.m)(a,a,n),(0,d.m)(o,o,n);for(var l=0;l<3;++l)t.min[l]=Math.min(t.min[l],a[l],o[l]),t.max[l]=Math.max(t.max[l],a[l],o[l])}}},{key:"_invalidateBoundingVolume",value:function(){this._bvDirty=!0,(0,u.pC)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}},{key:"_emit",value:function(e,t){(0,u.pC)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}},{key:"test",get:function(){var e=this;return{hasGeometry:function(t){return e._geometries.includes(t)},getGeometryIndex:function(t){return e._geometries.indexOf(t)}}}}]),n}(g.c),C=function(){function e(){(0,i.Z)(this,e),this.min=(0,h.f)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,h.f)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}return(0,a.Z)(e,[{key:"isEmpty",value:function(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}]),e}(),b=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).bounds=(0,f.c)(),e}return(0,a.Z)(n,[{key:"init",value:function(){(0,d.s)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),(0,d.s)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),(0,f.a)(this.bounds)}}]),n}(C)},47669:function(e,t,n){n.d(t,{O:function(){return o}});var r=n(43144),i=n(15671),a=n(95439),o=(0,r.Z)((function e(t){(0,i.Z)(this,e),this.channel=t,this.id=(0,a.D)()}))},69831:function(e,t,n){n.d(t,{z:function(){return y}});var r=n(15671),i=n(43144),a=n(92026),o=n(95439),s=n(14226),u=n(81949),l=n(11186),c=n(67077),d=n(80064),h=n(68401),f=n(81955),p=(0,i.Z)((function e(){(0,r.Z)(this,e),this.visible=!0})),v=n(47669),g=n(4760),m=n(32683),y=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,r.Z)(this,e),this.data=t,this.material=n,this.boundingSphere=(0,c.c)(),this.instanceParameters=new p,this._transformation=(0,u.c)(),this._shaderTransformationDirty=!0,this.layerUid=(0,a.Pt)(i.layerUid,null),this.graphicUid=(0,a.Pt)(i.graphicUid,null),this.id=i.id?i.id:(0,o.D)(),this.boundingInfo=(0,a.Pt)(i.boundingInfo,null),this.calculateShaderTransformation=(0,a.Pt)(i.calculateShaderTransformation,null),this.castShadow=!!i.castShadow&&i.castShadow}return(0,i.Z)(e,[{key:"transformation",get:function(){return this._transformation}},{key:"updateTransformation",value:function(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}},{key:"shaderTransformationChanged",value:function(){this._shaderTransformationDirty=!0}},{key:"computeBoundingSphere",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,d.u1)(e);(0,a.Wi)(this.boundingInfo)||((0,l.m)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*n)}},{key:"hasShaderTransformation",get:function(){return(0,a.pC)(this.calculateShaderTransformation)}},{key:"primitiveType",get:function(){return this.data.primitiveType}},{key:"getShaderTransformation",value:function(){return(0,a.Wi)(this.calculateShaderTransformation)?(0,a.Pt)(this.transformation,u.I):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=(0,u.c)()),(0,s.c)(this._shaderTransformation,this.calculateShaderTransformation((0,a.Pt)(this.transformation,u.I))),this._shaderTransformationDirty=!1),this._shaderTransformation)}},{key:"computeAttachmentOrigin",value:function(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,a.pC)(this._transformation)&&(0,l.m)(e,e,this._transformation),!0);var t=this.indices.get(g.T.POSITION),n=this.vertexAttributes.get(g.T.POSITION);return!!(0,f.cM)(n,t,e)&&((0,a.pC)(this._transformation)&&(0,l.m)(e,e,this._transformation),!0)}},{key:"indices",get:function(){return this.data.indices}},{key:"vertexAttributes",get:function(){return this.data.vertexAttributes}},{key:"addHighlight",value:function(){var e=new v.O(h.V_.Highlight),t=this.instanceParameters;return t.highlights=(0,m.lr)(t.highlights,e),e}},{key:"removeHighlight",value:function(e){var t=this.instanceParameters;t.highlights=(0,m.U_)(t.highlights,e)}}]),e}()},23038:function(e,t,n){n.d(t,{F:function(){return c},Q:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(54062),u=n(27366),l=n(33559);!function(e){e[e.SSAO=0]="SSAO",e[e.Blur=1]="Blur",e[e.COUNT=2]="COUNT"}(r||(r={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).output=r.SSAO,e}return(0,i.Z)(n)}(l.m);(0,u._)([(0,l.o)({count:r.COUNT})],c.prototype,"output",void 0)},97882:function(e,t,n){n.d(t,{F:function(){return m}});var r=n(37762),i=n(15671),a=n(43144),o=n(60136),s=n(54062),u=n(91505),l=n(100),c=n(92026),d=n(27546),h=n(68401),f=n(1395),p=n(79100),v=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"],g=n(78329),m=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var r,a,o,s,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return(0,i.Z)(this,n),(s=t.call(this)).apiLayerUid=c,s.type=p.U.Layer,s.events=new u.Z,s.isSliceable=!1,s._objects=new d.Z,s._stageHandles=new l.Z,s.apiLayerUid=c,s.isVisible=null===(r=null===e||void 0===e?void 0:e.isVisible)||void 0===r||r,s.isPickable=null===(a=null===e||void 0===e?void 0:e.isPickable)||void 0===a||a,s.updatePolicy=null!==(o=null===e||void 0===e?void 0:e.updatePolicy)&&void 0!==o?o:h.jq.ASYNC,s}return(0,a.Z)(n,[{key:"objects",get:function(){return this._objects}},{key:"destroy",value:function(){this.detachStage(),this._stage=null}},{key:"attachStage",value:function(e){var t=this;this.detachStage(),this._stage=e;var n,i=(0,r.Z)(v);try{var a=function(){var r=n.value;t._stageHandles.add(t.events.on(r,(function(t){return e.handleEvent(r,t)})))};for(i.s();!(n=i.n()).done;)a()}catch(o){i.e(o)}finally{i.f()}}},{key:"detachStage",value:function(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}},{key:"add",value:function(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),(0,c.pC)(this._octree)&&this._octree.add([e])}},{key:"remove",value:function(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),(0,c.pC)(this._octree)&&this._octree.remove([e]))}},{key:"addMany",value:function(e){this._objects.pushArray(e);var t,n=(0,r.Z)(e);try{for(n.s();!(t=n.n()).done;){t.value.parentLayer=this}}catch(i){n.e(i)}finally{n.f()}this.events.emit("layerObjectsAdded",{layer:this,objects:e}),(0,c.pC)(this._octree)&&this._octree.add(e)}},{key:"removeMany",value:function(e){var t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){var n,i=(0,r.Z)(t);try{for(i.s();!(n=i.n()).done;){n.value.parentLayer=null}}catch(a){i.e(a)}finally{i.f()}this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),(0,c.pC)(this._octree)&&this._octree.remove(t)}}},{key:"sync",value:function(){(0,c.pC)(this._stage)&&this.updatePolicy!==h.jq.SYNC&&this._stage.syncLayer(this.id)}},{key:"notifyObjectBBChanged",value:function(e,t){(0,c.pC)(this._octree)&&this._octree.update(e,t)}},{key:"getSpatialQueryAccelerator",value:function(){return(0,c.Wi)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}},{key:"shaderTransformationChanged",value:function(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}},{key:"invalidateSpatialQueryAccelerator",value:function(){this._octree=(0,c.SC)(this._octree)}},{key:"_createOctree",value:function(){this._octree=new g.Z((function(e){return e.boundingVolumeWorldSpace.bounds})),this._octree.add(this._objects.data,this._objects.length)}}]),n}(f.c)},66832:function(e,t,n){n.d(t,{E:function(){return D}});var r=n(15671),i=n(43144),a=n(60136),o=n(54062),s=n(67077),u=n(71011),l=n(68401),c=n(23620),d=n(94425),h=n(56529),f=n(78041),p=n(93822),v=n(64226),g=n(22909),m=n(11752),y=n(61120),_=n(82144),T=n(31132),x=n(7566),S=n(27627),w=n(50411),O=n(45028),C=n(36207),b=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return(0,i.Z)(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new S.$(e.rctx,t,x.i)}},{key:"_createPipeline",value:function(e,t){var n=this.configuration,r=e===l.Am.NONE,i=e===l.Am.FrontFace;return(0,C.sm)({blending:n.output!==u.H.Color&&n.output!==u.H.Alpha||!n.transparent?null:r?f.wu:(0,f.j7)(e),culling:(0,C.zp)(n.cullFace),depthTest:{func:(0,f.Bh)(e)},depthWrite:r||i?n.writeDepth&&C.LZ:null,colorWrite:C.BK,stencilWrite:n.hasOccludees?w.s3:null,stencilTest:n.hasOccludees?t?w.eD:w.RY:null,polygonOffset:r||i?n.polygonOffset&&A:(0,f.je)(n.enableOffset)})}},{key:"initializePipeline",value:function(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,m.Z)((0,y.Z)(n.prototype),"getPipelineState",this).call(this,e,t)}}]),n}(T.A);b.shader=new _.J(O.C,(function(){return n.e(3173).then(n.bind(n,23173))}));var A={factor:1,units:1},R=n(27366),P=n(33559),E=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).output=u.H.Color,e.cullFace=l.Vr.None,e.hasSlicePlane=!1,e.hasVertexColors=!1,e.transparent=!1,e.polygonOffset=!1,e.enableOffset=!0,e.writeDepth=!0,e.hasOccludees=!1,e.transparencyPassType=l.Am.NONE,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,i.Z)(n)}(n(8883).W);(0,R._)([(0,P.o)({count:u.H.COUNT})],E.prototype,"output",void 0),(0,R._)([(0,P.o)({count:l.Vr.COUNT})],E.prototype,"cullFace",void 0),(0,R._)([(0,P.o)()],E.prototype,"hasSlicePlane",void 0),(0,R._)([(0,P.o)()],E.prototype,"hasVertexColors",void 0),(0,R._)([(0,P.o)()],E.prototype,"transparent",void 0),(0,R._)([(0,P.o)()],E.prototype,"polygonOffset",void 0),(0,R._)([(0,P.o)()],E.prototype,"enableOffset",void 0),(0,R._)([(0,P.o)()],E.prototype,"writeDepth",void 0),(0,R._)([(0,P.o)()],E.prototype,"hasOccludees",void 0),(0,R._)([(0,P.o)({count:l.Am.COUNT})],E.prototype,"transparencyPassType",void 0),(0,R._)([(0,P.o)()],E.prototype,"hasMultipassTerrain",void 0),(0,R._)([(0,P.o)()],E.prototype,"cullAboveGround",void 0);var D=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e,new M)).supportsEdges=!0,i._configuration=new E,i}return(0,i.Z)(n,[{key:"getConfiguration",value:function(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<f.ve,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}},{key:"intersect",value:function(e,t,n,r,i,a,o){(0,g.Bw)(e,t,r,i,a,void 0,o)}},{key:"requiresSlot",value:function(e,t){return e===p.r.DRAPED_MATERIAL||((0,d.S)(t)===u.H.Highlight?e===p.r.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?p.r.TRANSPARENT_MATERIAL:p.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:p.r.OPAQUE_MATERIAL))}},{key:"createGLMaterial",value:function(e){return e.output===u.H.Color||e.output===u.H.Alpha||e.output===u.H.Highlight||e.output===u.H.Depth&&this.parameters.writeLinearDepth?new I(e):null}},{key:"createBufferWriter",value:function(){return new v.G_(v.IM)}}]),n}(h.F5),I=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return(0,i.Z)(n,[{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==u.H.Color&&this._output!==u.H.Alpha||this._updateOccludeeState(e),this.ensureTechnique(b,e)}}]),n}(c.Z),M=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).color=s.Z,e.transparent=!1,e.writeDepth=!0,e.writeLinearDepth=!1,e.hasVertexColors=!1,e.polygonOffset=!1,e.hasSlicePlane=!1,e.cullFace=l.Vr.None,e.hasOccludees=!1,e}return(0,i.Z)(n)}(h.Mt)},21400:function(e,t,n){n.d(t,{A:function(){return Y}});var r=n(1413),i=n(15671),a=n(43144),o=n(60136),s=n(54062),u=n(16889),l=n(92026),c=n(22753),d=n(11873),h=n(14226),f=n(81949),p=n(88396),v=n(6394),g=n(11186),m=n(71353),y=n(67077);function _(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}var T=n(65156),x=n(55158),S=n(71011),w=n(50600),O=n(81955),C=n(17363),b=n(56529),A=n(93822),R=n(65216),P=n(97731),E=n(4760),D=n(33236),I=n(22909),M=n(32683),Z=n(18442),H=n(50951),N=n(82144),L=n(31132),k=n(68401),F=n(7566),z=n(78041),U=n(27627),V=n(8548),j=n(36207),W=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.spherical=e.viewingMode===H.JY.Global}},{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new U.$(e.rctx,t,F.i)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,n=e===k.Am.NONE,r=e===k.Am.FrontFace,i=this.configuration.hasPolygonOffset&&B,a=(n||r)&&t.output!==S.H.Highlight?(t.depthEnabled||t.output===S.H.Occlusion)&&j.LZ:null;return(0,j.sm)({blending:t.output===S.H.Color||t.output===S.H.Alpha||t.output===S.H.Highlight?n?G:(0,z.j7)(e):null,depthTest:{func:V.wb.LEQUAL},depthWrite:a,colorWrite:j.BK,polygonOffset:i})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}},{key:"primitiveType",get:function(){return this.configuration.output===S.H.Occlusion?V.MX.POINTS:V.MX.TRIANGLES}}]),n}(L.A);W.shader=new N.J(Z.H,(function(){return n.e(6823).then(n.bind(n,16823))}));var B={factor:0,units:-4},G=(0,j.if)(V.zi.ONE,V.zi.ONE_MINUS_SRC_ALPHA),q=n(27366),X=n(33559),J=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).output=S.H.Color,e.screenCenterOffsetUnitsEnabled=w.d.World,e.transparencyPassType=k.Am.NONE,e.spherical=!1,e.occlusionTestEnabled=!0,e.signedDistanceFieldEnabled=!1,e.vvSize=!1,e.vvColor=!1,e.hasVerticalOffset=!1,e.hasScreenSizePerspective=!1,e.debugDrawLabelBorder=!1,e.binaryHighlightOcclusionEnabled=!0,e.hasSlicePlane=!1,e.hasPolygonOffset=!1,e.depthEnabled=!0,e.pixelSnappingEnabled=!0,e.isDraped=!1,e.hasMultipassGeometry=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,a.Z)(n)}(n(8883).W);(0,q._)([(0,X.o)({count:S.H.COUNT})],J.prototype,"output",void 0),(0,q._)([(0,X.o)({count:w.d.COUNT})],J.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,q._)([(0,X.o)({count:k.Am.COUNT})],J.prototype,"transparencyPassType",void 0),(0,q._)([(0,X.o)()],J.prototype,"spherical",void 0),(0,q._)([(0,X.o)()],J.prototype,"occlusionTestEnabled",void 0),(0,q._)([(0,X.o)()],J.prototype,"signedDistanceFieldEnabled",void 0),(0,q._)([(0,X.o)()],J.prototype,"vvSize",void 0),(0,q._)([(0,X.o)()],J.prototype,"vvColor",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasVerticalOffset",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasScreenSizePerspective",void 0),(0,q._)([(0,X.o)()],J.prototype,"debugDrawLabelBorder",void 0),(0,q._)([(0,X.o)()],J.prototype,"binaryHighlightOcclusionEnabled",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasSlicePlane",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasPolygonOffset",void 0),(0,q._)([(0,X.o)()],J.prototype,"depthEnabled",void 0),(0,q._)([(0,X.o)()],J.prototype,"pixelSnappingEnabled",void 0),(0,q._)([(0,X.o)()],J.prototype,"isDraped",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasMultipassGeometry",void 0),(0,q._)([(0,X.o)()],J.prototype,"hasMultipassTerrain",void 0),(0,q._)([(0,X.o)()],J.prototype,"cullAboveGround",void 0),(0,q._)([(0,X.o)({constValue:!0})],J.prototype,"hasSliceInVertexProgram",void 0),(0,q._)([(0,X.o)({constValue:!1})],J.prototype,"hasVvInstancing",void 0);var Y=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e,new ye)).techniqueConfig=new J,r}return(0,a.Z)(n,[{key:"getConfiguration",value:function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasVerticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?w.d.Screen:w.d.World,this.techniqueConfig.hasPolygonOffset=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,e===S.H.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),e===S.H.Highlight&&(this.techniqueConfig.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.hasMultipassGeometry=t.multipassGeometry.enabled,this.techniqueConfig.hasMultipassTerrain=t.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=t.multipassTerrain.cullAboveGround,this.techniqueConfig}},{key:"intersect",value:function(e,t,n,r,i,a,o,s,u){(0,l.pC)(u)?this._intersectDrapedHudGeometry(e,a,o,s,u):this._intersectHudGeometry(e,t,n,r,o,s)}},{key:"_intersectDrapedHudGeometry",value:function(e,t,n,r,i){var a=e.vertexAttributes.get(E.T.POSITION),o=e.vertexAttributes.get(E.T.SIZE),s=this.parameters,u=(0,Z.c)(s),c=1,d=1;if((0,l.pC)(r)){var h=r(fe);c=h[0],d=h[5]}c*=e.screenToWorldRatio,d*=e.screenToWorldRatio;for(var f=ve*e.screenToWorldRatio,p=0;p<a.data.length/a.size;p++){var v=p*a.size,g=a.data[v],m=a.data[v+1],y=p*o.size,_=void 0;ge[0]=o.data[y]*c,ge[1]=o.data[y+1]*d,s.textureIsSignedDistanceField&&(_=s.outlineSize*e.screenToWorldRatio/2),ee(t,g,m,ge,f,_,s,u)&&n(i.dist,i.normal,-1,!1)}}},{key:"_intersectHudGeometry",value:function(e,t,n,r,i,a){if(r.options.selectionMode&&r.options.hud&&!(0,M.PD)(t)){var o=this.parameters,s=1,u=1;if((0,c.f)(ue,n),(0,l.pC)(a)){var d=a(fe);s=d[0],u=d[5],function(e){var t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],u=e[7],l=e[8],c=1/Math.sqrt(t*t+n*n+r*r),d=1/Math.sqrt(i*i+a*a+o*o),h=1/Math.sqrt(s*s+u*u+l*l);e[0]=t*c,e[1]=n*c,e[2]=r*c,e[3]=i*d,e[4]=a*d,e[5]=o*d,e[6]=s*h,e[7]=u*h,e[8]=l*h}(ue)}var f=e.vertexAttributes.get(E.T.POSITION),p=e.vertexAttributes.get(E.T.SIZE),v=e.vertexAttributes.get(E.T.NORMAL),y=e.vertexAttributes.get(E.T.AUXPOS1);(0,P.hu)(f.size>=3);var _=r.point,T=r.camera,x=(0,Z.c)(o);s*=T.pixelRatio,u*=T.pixelRatio;for(var S="screen"===this.parameters.centerOffsetUnits,w=0;w<f.data.length/f.size;w++){var O=w*f.size;(0,g.s)(re,f.data[O],f.data[O+1],f.data[O+2]),(0,g.m)(re,re,n);var C=w*p.size;ge[0]=p.data[C]*s,ge[1]=p.data[C+1]*u,(0,g.m)(re,re,T.viewMatrix);var b=w*y.size;if((0,g.s)(de,y.data[b+0],y.data[b+1],y.data[b+2]),!S&&(re[0]+=de[0],re[1]+=de[1],0!==de[2])){var A=de[2];(0,g.n)(de,re),(0,g.b)(re,re,(0,g.g)(de,de,A))}var D=w*v.size;if((0,g.s)(ie,v.data[D],v.data[D+1],v.data[D+2]),this._normalAndViewAngle(ie,ue,T,he),this._applyVerticalOffsetTransformationView(re,he,T,te),T.applyProjection(re,ae),ae[0]>-1){ae[0]=Math.floor(ae[0]),ae[1]=Math.floor(ae[1]),S&&(de[0]||de[1])&&(ae[0]+=de[0],0!==de[1]&&(ae[1]+=(0,R.sX)(de[1],te.factorAlignment)),T.unapplyProjection(ae,re)),ae[0]+=this.parameters.screenOffset[0],ae[1]+=this.parameters.screenOffset[1],(0,R.TU)(ge,te.factor,ge);var I=pe*T.pixelRatio,H=void 0;if(o.textureIsSignedDistanceField&&(H=o.outlineSize*T.pixelRatio/2),ee(_,ae[0],ae[1],ge,I,H,o,x)){var N=r.ray;if((0,g.m)(se,re,(0,h.a)(ce,T.viewMatrix)),ae[0]=_[0],ae[1]=_[1],T.unprojectFromRenderScreen(ae,re)){var L=(0,m.c)();(0,g.c)(L,N.direction);var k=1/(0,g.l)(L);(0,g.g)(L,L,k),i((0,g.i)(N.origin,re)*k,L,-1,!0,1,se)}}}}}}},{key:"computeAttachmentOrigin",value:function(e,t){var n=e.vertexAttributes;if(!n)return!1;var r=n.get(E.T.POSITION),i=e.indices.get(E.T.POSITION);return(0,O.NO)(r,i,t)}},{key:"createBufferWriter",value:function(){return new Te(this)}},{key:"_normalAndViewAngle",value:function(e,t,n,r){return _(t)&&(t=(0,c.f)(le,t)),(0,g.t)(r.normal,e,t),(0,g.m)(r.normal,r.normal,n.viewInverseTransposeMatrix),r.cosAngle=(0,g.e)(oe,me),r}},{key:"_updateScaleInfo",value:function(e,t,n){var r=this.parameters;(0,l.pC)(r.screenSizePerspective)?(0,R.PV)(n,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),(0,l.pC)(r.screenSizePerspectiveAlignment)?(0,R.PV)(n,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}},{key:"applyShaderOffsetsView",value:function(e,t,n,r,i,a,o){var s=this._normalAndViewAngle(t,n,i,he);return this._applyVerticalGroundOffsetView(e,s,i,o),this._applyVerticalOffsetTransformationView(o,s,i,a),this._applyPolygonOffsetView(o,s,r[3],i,o),this._applyCenterOffsetView(o,r,o),o}},{key:"applyShaderOffsetsNDC",value:function(e,t,n,r,i){return this._applyCenterOffsetNDC(e,t,n,r),(0,l.pC)(i)&&(0,g.c)(i,r),this._applyPolygonOffsetNDC(r,t,n,r),r}},{key:"_applyPolygonOffsetView",value:function(e,t,n,r,i){var a=r.aboveGround?1:-1,o=Math.sign(n);0===o&&(o=a);var s=a*o;if(this.parameters.shaderPolygonOffset<=0)return(0,g.c)(i,e);var l=(0,u.uZ)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/r.viewport[2];return(0,g.g)(i,e,s>0?c:1/c),i}},{key:"_applyVerticalGroundOffsetView",value:function(e,t,n,r){var i=(0,g.l)(e),a=n.aboveGround?1:-1,o=.5*n.computeRenderPixelSizeAtDist(i),s=(0,g.g)(re,t.normal,a*o);return(0,g.a)(r,e,s),r}},{key:"_applyVerticalOffsetTransformationView",value:function(e,t,n,r){var i=this.parameters;if(!i.verticalOffset||!i.verticalOffset.screenLength){if(i.screenSizePerspective||i.screenSizePerspectiveAlignment){var a=(0,g.l)(e);this._updateScaleInfo(r,a,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}var o=(0,g.l)(e),s=(0,l.Pt)(i.screenSizePerspectiveAlignment,i.screenSizePerspective),u=(0,I.Hx)(n,o,i.verticalOffset,t.cosAngle,s);return this._updateScaleInfo(r,o,t.cosAngle),(0,g.g)(t.normal,t.normal,u),(0,g.a)(e,e,t.normal)}},{key:"_applyCenterOffsetView",value:function(e,t,n){var r="screen"!==this.parameters.centerOffsetUnits;return n!==e&&(0,g.c)(n,e),r&&(n[0]+=t[0],n[1]+=t[1],t[2]&&((0,g.n)(ie,n),(0,g.a)(n,n,(0,g.g)(ie,ie,t[2])))),n}},{key:"_applyCenterOffsetNDC",value:function(e,t,n,r){var i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,g.c)(r,e),i||(r[0]+=t[0]/n.fullWidth*2,r[1]+=t[1]/n.fullHeight*2),r}},{key:"_applyPolygonOffsetNDC",value:function(e,t,n,r){var i=this.parameters.shaderPolygonOffset;if(e!==r&&(0,g.c)(r,e),i){var a=n.aboveGround?1:-1,o=a*Math.sign(t[3]);r[2]-=(o||a)*i}return r}},{key:"requiresSlot",value:function(e){if(e===A.r.DRAPED_MATERIAL)return!0;var t=this.parameters,n=t.drawInSecondSlot,r=t.occlusionTest;return e===(n?A.r.LABEL_MATERIAL:A.r.HUD_MATERIAL)||r&&e===A.r.OCCLUSION_PIXELS}},{key:"createGLMaterial",value:function(e){return e.output===S.H.Color||e.output===S.H.Alpha?new K(e):e.output===S.H.Highlight?new Q(e):null}},{key:"calculateRelativeScreenBounds",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,T.Ue)();return $(this.parameters,e,t,n),n[2]=n[0]+e[0],n[3]=n[1]+e[1],n}}]),n}(b.F5),Q=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){return(0,i.Z)(this,n),t.call(this,(0,r.Z)((0,r.Z)({},e),e.material.parameters))}return(0,a.Z)(n,[{key:"selectProgram",value:function(e){return this.ensureTechnique(W,e)}},{key:"beginSlot",value:function(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}]),n}(C.F),K=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n,[{key:"_isOcclusionSlot",value:function(e){return e.slot===A.r.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===S.H.Color||this._output===S.H.Alpha)}},{key:"selectProgram",value:function(e){return this.ensureTechnique(W,e,this._isOcclusionSlot(e)?S.H.Occlusion:this._output)}}]),n}(Q);function $(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ne;return(0,p.c)(r,e.anchorPosition),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*n,r[1]+=e.screenOffset[1]*n,r}function ee(e,t,n,r,i,a,o,s){var u=t-i-(s[0]>0?r[0]*s[0]:0),c=u+r[0]+2*i,d=n-i-(s[1]>0?r[1]*s[1]:0),h=d+r[1]+2*i,f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&(0,l.pC)(f)&&(u+=r[0]*f[0],d+=r[1]*f[1],c-=r[0]*(1-f[2]),h-=r[1]*(1-f[3]),u-=a,c+=a,d-=a,h+=a),e[0]>u&&e[0]<c&&e[1]>d&&e[1]<h}var te={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},ne=(0,v.a)(),re=(0,m.c)(),ie=(0,m.c)(),ae=(0,y.c)(),oe=(0,m.c)(),se=(0,m.c)(),ue=(0,d.c)(),le=(0,d.c)(),ce=(0,f.c)(),de=(0,m.c)(),he={normal:oe,cosAngle:0},fe=(0,f.c)(),pe=1,ve=2,ge=[0,0],me=(0,m.f)(0,0,1),ye=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).renderOccluded=b.yD.Occlude,e.color=[1,1,1,1],e.texCoordScale=[1,1],e.polygonOffset=!1,e.anchorPosition=(0,v.f)(.5,.5),e.screenOffset=[0,0],e.shaderPolygonOffset=1e-5,e.textureIsSignedDistanceField=!1,e.outlineColor=[1,1,1,1],e.outlineSize=0,e.vvSizeEnabled=!1,e.vvSizeMinSize=[1,1,1],e.vvSizeMaxSize=[100,100,100],e.vvSizeOffset=[0,0,0],e.vvSizeFactor=[1,1,1],e.vvColorEnabled=!1,e.vvColorValues=[0,0,0,0,0,0,0,0],e.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],e.hasSlicePlane=!1,e.pixelSnappingEnabled=!0,e.occlusionTest=!0,e.binaryHighlightOcclusion=!0,e.debugDrawLabelBorder=!1,e.centerOffsetUnits="world",e.drawInSecondSlot=!1,e.depthEnabled=!0,e.isDraped=!1,e}return(0,a.Z)(n)}(C.E),_e=(0,x.U$)().vec3f(E.T.POSITION).vec3f(E.T.NORMAL).vec2f(E.T.UV0).vec4u8(E.T.COLOR).vec2f(E.T.SIZE).vec4f(E.T.AUXPOS1).vec4f(E.T.AUXPOS2),Te=function(){function e(t){(0,i.Z)(this,e),this.material=t,this.vertexBufferLayout=_e}return(0,a.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return 6*e.indices.get(E.T.POSITION).length}},{key:"write",value:function(e,t,n,r){(0,D.ho)(t.indices.get(E.T.POSITION),t.vertexAttributes.get(E.T.POSITION).data,e.transformation,n.position,r,6),(0,D.s5)(t.indices.get(E.T.NORMAL),t.vertexAttributes.get(E.T.NORMAL).data,e.invTranspTransformation,n.normal,r,6);var i,a,o,s,u=t.vertexAttributes.get(E.T.UV0).data;if(null==u||u.length<4){var l=this.material.parameters;i=0,a=0,o=l.texCoordScale[0],s=l.texCoordScale[1]}else i=u[0],a=u[1],o=u[2],s=u[3];o=Math.min(1.99999,o+1),s=Math.min(1.99999,s+1);for(var c=t.indices.get(E.T.POSITION).length,d=n.uv0,h=r,f=0;f<c;++f)d.set(h,0,i),d.set(h,1,a),h+=1,d.set(h,0,o),d.set(h,1,a),h+=1,d.set(h,0,o),d.set(h,1,s),h+=1,d.set(h,0,o),d.set(h,1,s),h+=1,d.set(h,0,i),d.set(h,1,s),h+=1,d.set(h,0,i),d.set(h,1,a),h+=1;(0,D.Vs)(t.indices.get(E.T.COLOR),t.vertexAttributes.get(E.T.COLOR).data,4,n.color,r,6);for(var p=t.indices.get(E.T.SIZE),v=t.vertexAttributes.get(E.T.SIZE).data,g=p.length,m=n.size,y=r,_=0;_<g;++_)for(var T=v[2*p[_]],x=v[2*p[_]+1],S=0;S<6;++S)m.set(y,0,T),m.set(y,1,x),y+=1;t.indices.get(E.T.AUXPOS1)&&t.vertexAttributes.get(E.T.AUXPOS1)&&(0,D.SW)(t.indices.get(E.T.AUXPOS1),t.vertexAttributes.get(E.T.AUXPOS1).data,n.auxpos1,r,6),t.indices.get(E.T.AUXPOS2)&&t.vertexAttributes.get(E.T.AUXPOS2)&&(0,D.SW)(t.indices.get(E.T.AUXPOS2),t.vertexAttributes.get(E.T.AUXPOS2).data,n.auxpos2,r,6)}}]),e}()},24231:function(e,t,n){n.d(t,{Y:function(){return B}});var r=n(15671),i=n(43144),a=n(60136),o=n(54062),s=n(32718),u=n(92026),l=n(17842),c=n(88396),d=n(11186),h=n(71353),f=n(67077),p=n(95773),v=n(85981),g=n(55652),m=n(25158),y=n(71011),_=n(81955),T=n(23620),x=n(56529),S=n(93822),w=n(97731),O=n(4760),C=n(33236),b=n(64226),A=n(22909),R=n(32683),P=n(11752),E=n(61120),D=n(82144),I=n(31132),M=n(7566),Z=n(27627),H=n(50411),N=n(99337),L=n(8548),k=n(36207),F=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a){var o;return(0,r.Z)(this,n),(o=t.call(this,e,i,a)).stipplePattern=null,o.stippleTextureBind=null,o.stippleTextureRepository=e.stippleTextureRepository,o}return(0,i.Z)(n,[{key:"stippleEnabled",get:function(){return this.configuration.stippleEnabled&&this.configuration.output!==y.H.Highlight}},{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new Z.$(e.rctx,t,M.i)}},{key:"destroy",value:function(){(0,P.Z)((0,E.Z)(n.prototype),"destroy",this).call(this),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}},{key:"bindPass",value:function(e,t){if(this.program.bindPass(e,t),this.stipplePattern!==e.stipplePattern){var n=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,n),this.stipplePattern=n}if(this.stippleEnabled){var r=(0,u.pC)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1},i=r.pixelSize,a=r.sdfNormalizer,o=r.pixels;this.program.setUniform1f("stipplePatternSDFNormalizer",a),this.program.setUniform1f("stipplePatternTextureSize",o),this.program.setUniform1f("stipplePatternPixelSize",i),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i)}}},{key:"initializePipeline",value:function(){var e=this.configuration,t=(0,k.wK)(L.zi.SRC_ALPHA,L.zi.ONE,L.zi.ONE_MINUS_SRC_ALPHA,L.zi.ONE_MINUS_SRC_ALPHA),n=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,k.sm)({blending:n,depthTest:H.JN,depthWrite:r,colorWrite:k.BK,stencilWrite:e.hasOccludees?H.s3:null,stencilTest:e.hasOccludees?t?H.eD:H.RY:null})};return e.output===y.H.Color?(this._occludeePipelineState=n(!0,e.transparent||this.stippleEnabled?t:null,k.LZ),n(!1,e.transparent||this.stippleEnabled?t:null,k.LZ)):n(!1)}},{key:"primitiveType",get:function(){return L.MX.LINES}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:(0,P.Z)((0,E.Z)(n.prototype),"getPipelineState",this).call(this,e,t)}}]),n}(I.A);F.shader=new D.J(N.N,(function(){return n.e(8569).then(n.bind(n,78569))}));var z=n(27366),U=n(33559),V=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).output=y.H.Color,e.hasSlicePlane=!1,e.hasVertexColors=!1,e.transparent=!1,e.draped=!1,e.stippleEnabled=!1,e.stippleOffColorEnabled=!1,e.stipplePreferContinuous=!0,e.hasOccludees=!1,e}return(0,i.Z)(n)}(n(8883).W);(0,z._)([(0,U.o)({count:y.H.COUNT})],V.prototype,"output",void 0),(0,z._)([(0,U.o)()],V.prototype,"hasSlicePlane",void 0),(0,z._)([(0,U.o)()],V.prototype,"hasVertexColors",void 0),(0,z._)([(0,U.o)()],V.prototype,"transparent",void 0),(0,z._)([(0,U.o)()],V.prototype,"draped",void 0),(0,z._)([(0,U.o)()],V.prototype,"stippleEnabled",void 0),(0,z._)([(0,U.o)()],V.prototype,"stippleOffColorEnabled",void 0),(0,z._)([(0,U.o)()],V.prototype,"stipplePreferContinuous",void 0),(0,z._)([(0,U.o)()],V.prototype,"hasOccludees",void 0),(0,z._)([(0,U.o)({constValue:!1})],V.prototype,"stippleRequiresClamp",void 0),(0,z._)([(0,U.o)({constValue:!1})],V.prototype,"stippleScaleWithLineWidth",void 0),(0,z._)([(0,U.o)({constValue:!1})],V.prototype,"stippleRequiresStretchMeasure",void 0);var j,W=s.Z.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");!function(e){e[e.START=0]="START",e[e.END=1]="END"}(j||(j={}));var B=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e,new X))._techniqueConfig=new V,i}return(0,i.Z)(n,[{key:"getConfiguration",value:function(e,t){this._techniqueConfig.output=e,this._techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this._techniqueConfig.hasVertexColors=this.parameters.hasVertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=t.slot===S.r.DRAPED_MATERIAL;var n=(0,u.pC)(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=n,this._techniqueConfig.stippleOffColorEnabled=n&&(0,u.pC)(this.parameters.stippleOffColor),this._techniqueConfig.hasOccludees=this.parameters.hasOccludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}},{key:"intersect",value:function(e,t,n,r,i,a,o,s,l){(0,u.pC)(l)?(0,A.TT)(e,r,l,a,1,o):this._intersectLineGeometry(e,t,n,r,o)}},{key:"_intersectLineGeometry",value:function(e,t,n,r,i){if(r.options.selectionMode&&!(0,R.PD)(t))if((0,w.kG)(n)){var a=e.vertexAttributes.get(O.T.POSITION).data,o=r.camera,s=ae;(0,c.c)(s,r.point);(0,d.s)(oe[0],s[0]-2,s[1]+2,0),(0,d.s)(oe[1],s[0]+2,s[1]+2,0),(0,d.s)(oe[2],s[0]+2,s[1]-2,0),(0,d.s)(oe[3],s[0]-2,s[1]-2,0);for(var u=0;u<4;u++)if(!o.unprojectFromRenderScreen(oe[u],se[u]))return;(0,g.zk)(o.eye,se[0],se[1],ue),(0,g.zk)(o.eye,se[1],se[2],le),(0,g.zk)(o.eye,se[2],se[3],ce),(0,g.zk)(o.eye,se[3],se[0],de);for(var l=Number.MAX_VALUE,h=0,f=0;f<a.length-5;f+=3)if(J[0]=a[f]+n[12],J[1]=a[f+1]+n[13],J[2]=a[f+2]+n[14],Y[0]=a[f+3]+n[12],Y[1]=a[f+4]+n[13],Y[2]=a[f+5]+n[14],!((0,g.jH)(ue,J)<0&&(0,g.jH)(ue,Y)<0||(0,g.jH)(le,J)<0&&(0,g.jH)(le,Y)<0||(0,g.jH)(ce,J)<0&&(0,g.jH)(ce,Y)<0||(0,g.jH)(de,J)<0&&(0,g.jH)(de,Y)<0)){if(o.projectToRenderScreen(J,$),o.projectToRenderScreen(Y,ee),$[2]<0&&ee[2]>0){(0,d.b)(Q,J,Y);var m=o.frustum,y=-(0,g.jH)(m[p.Nu.NEAR],J)/(0,d.e)(Q,(0,g.mJ)(m[p.Nu.NEAR]));(0,d.g)(Q,Q,y),(0,d.a)(J,J,Q),o.projectToRenderScreen(J,$)}else if($[2]>0&&ee[2]<0){(0,d.b)(Q,Y,J);var _=o.frustum,T=-(0,g.jH)(_[p.Nu.NEAR],Y)/(0,d.e)(Q,(0,g.mJ)(_[p.Nu.NEAR]));(0,d.g)(Q,Q,T),(0,d.a)(Y,Y,Q),o.projectToRenderScreen(Y,ee)}else if($[2]<0&&ee[2]<0)continue;$[2]=0,ee[2]=0;var x=(0,v.Jk)((0,v.zk)($,ee,re),s);x<l&&(l=x,(0,d.c)(te,J),(0,d.c)(ne,Y),h=f/3)}var S=r.rayBegin,C=r.rayEnd;if(l<4){var b=Number.MAX_VALUE;if((0,v.AR)((0,v.zk)(te,ne,re),(0,v.zk)(S,C,ie),K)){(0,d.b)(K,K,S);var A=(0,d.l)(K);(0,d.g)(K,K,1/A),b=A/(0,d.i)(S,C)}i(b,K,h,!1)}}else W.error("intersection assumes a translation-only matrix")}},{key:"computeAttachmentOrigin",value:function(e,t){var n=e.vertexAttributes;if(!n)return!1;var r=n.get(O.T.POSITION);return(0,_.qZ)(r,null,!1,t)}},{key:"requiresSlot",value:function(e){return e===S.r.OPAQUE_MATERIAL||e===S.r.DRAPED_MATERIAL}},{key:"createGLMaterial",value:function(e){return e.output===y.H.Color||e.output===y.H.Highlight?new G(e):null}},{key:"createBufferWriter",value:function(){var e=this.parameters.hasVertexColors?b.IM:b.wp;return(0,u.Wi)(this.parameters.stipplePattern)?new b.G_(e):new q(e.clone().vec3f(O.T.AUXPOS1).vec2f(O.T.UV0))}}]),n}(x.F5),G=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return(0,i.Z)(n,[{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output===y.H.Color&&this._updateOccludeeState(e),this.ensureTechnique(F,e)}}]),n}(T.Z),q=function(){function e(t){(0,r.Z)(this,e),this.vertexBufferLayout=t}return(0,i.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(O.T.POSITION).length}},{key:"write",value:function(e,t,n,r){(0,C.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,n,r),this._writeAuxpos1(e,t,n,r),this._writeUV0(e,t,n,r)}},{key:"_writeAuxpos1",value:function(e,t,n,r){var i=n.getField(O.T.AUXPOS1,m.ct),a=t.indices.get(O.T.POSITION),o=t.vertexAttributes.get(O.T.POSITION).data,s=e.transformation,u=i.typedBufferStride,l=i.typedBuffer;r*=u;for(var c=0;c<a.length-1;c+=2)for(var d=0,h=[1,0];d<h.length;d++){var f=3*a[c+h[d]],p=o[f],v=o[f+1],g=o[f+2],y=s[0]*p+s[4]*v+s[8]*g+s[12],_=s[1]*p+s[5]*v+s[9]*g+s[13],T=s[2]*p+s[6]*v+s[10]*g+s[14];l[r]=y,l[r+1]=_,l[r+2]=T,r+=u}}},{key:"_writeUV0",value:function(e,t,n,r){var i,a=n.getField(O.T.UV0,m.Eu),o=t.indices.get(O.T.POSITION),s=t.vertexAttributes.get(O.T.POSITION).data,u=null===(i=t.vertexAttributes.get(O.T.DISTANCETOSTART))||void 0===i?void 0:i.data,l=e.transformation,c=a.typedBufferStride,h=a.typedBuffer,f=0;h[r*=c]=j.START,h[r+1]=f,r+=c;var p=3*o[0],v=(0,d.s)(J,s[p],s[p+1],s[p+2]);l&&(0,d.m)(v,v,l);for(var g=Y,y=o.length-1,_=1,T=u?function(e,t,n){return f=u[n]}:function(e,t,n){return f+=(0,d.i)(e,t)},x=1;x<y;x+=2){var S=3*o[x];(0,d.s)(g,s[S],s[S+1],s[S+2]),l&&(0,d.m)(g,g,l),T(v,g,_++);for(var w=0;w<2;++w)h[r]=1-w,h[r+1]=f,r+=c;(0,d.c)(v,g)}var C=3*o[y];(0,d.s)(g,s[C],s[C+1],s[C+2]),l&&(0,d.m)(g,g,l),T(v,g,_),h[r]=j.END,h[r+1]=f}}]),e}(),X=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).color=f.O,e.hasVertexColors=!1,e.hasSlicePlane=!1,e.width=1,e.stipplePreferContinuous=!0,e.hasOccludees=!1,e}return(0,i.Z)(n)}(x.Mt),J=(0,h.c)(),Y=(0,h.c)(),Q=(0,h.c)(),K=(0,h.c)(),$=(0,l.J$)(),ee=(0,l.J$)(),te=(0,h.c)(),ne=(0,h.c)(),re=(0,v.Ue)(),ie=(0,v.Ue)(),ae=(0,h.c)(),oe=[(0,l.J$)(),(0,l.J$)(),(0,l.J$)(),(0,l.J$)()],se=[(0,h.c)(),(0,h.c)(),(0,h.c)(),(0,h.c)()],ue=(0,g.Ue)(),le=(0,g.Ue)(),ce=(0,g.Ue)(),de=(0,g.Ue)()},58901:function(e,t,n){n.d(t,{U:function(){return G}});var r=n(15671),i=n(43144),a=n(60136),o=n(54062),s=n(32718),u=n(16889),l=n(92026),c=n(17842),d=n(88396),h=n(11186),f=n(71353),p=n(67077),v=n(95773),g=n(85981),m=n(55652),y=n(55158),_=n(71011),T=n(81955),x=n(23620),S=n(94425),w=n(56529),O=n(93822),C=n(97731),b=n(4760),A=n(65964),R=n(32683),P=n(98186),E=n(11752),D=n(61120),I=n(82144),M=n(31132),Z=n(68401),H=n(78041),N=n(27627),L=n(50411),k=n(8548),F=n(36207),z=new Map([[b.T.POSITION,0],[b.T.SUBDIVISIONFACTOR,1],[b.T.UV0,2],[b.T.AUXPOS1,3],[b.T.AUXPOS2,4],[b.T.COLOR,5],[b.T.COLORFEATUREATTRIBUTE,5],[b.T.SIZE,6],[b.T.SIZEFEATUREATTRIBUTE,6],[b.T.OPACITYFEATUREATTRIBUTE,7]]),U=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a){var o;return(0,r.Z)(this,n),(o=t.call(this,e,i,a)).stippleTextureRepository=e.stippleTextureRepository,o}return(0,i.Z)(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new N.$(e.rctx,t,z)}},{key:"destroy",value:function(){(0,E.Z)((0,D.Z)(n.prototype),"destroy",this).call(this),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}},{key:"bindPass",value:function(e,t){if(this.program.bindPass(e,t),this.stipplePattern!==e.stipplePattern){var n=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,n),this.stipplePattern=n}if(this.configuration.stippleEnabled){var r=(0,l.pC)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1},i=r.pixelSize,a=r.sdfNormalizer,o=r.pixels;this.program.setUniform1f("stipplePatternSDFNormalizer",a),this.program.setUniform1f("stipplePatternTextureSize",o),this.program.setUniform1f("stipplePatternPixelSize",i),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i)}}},{key:"_makePipelineState",value:function(e,t){var n=this.configuration,r=e===Z.Am.NONE,i=e===Z.Am.FrontFace;return(0,F.sm)({blending:n.output===_.H.Color||n.output===_.H.Alpha?r?H.wu:(0,H.j7)(e):null,depthTest:{func:(0,H.Bh)(e)},depthWrite:r?n.writeDepth&&F.LZ:(0,H.K5)(e),colorWrite:F.BK,stencilWrite:n.hasOccludees?L.s3:null,stencilTest:n.hasOccludees?t?L.eD:L.RY:null,polygonOffset:r||i?n.hasPolygonOffset&&j:H.E0})}},{key:"initializePipeline",value:function(){var e=this.configuration;if(e.occluder){var t=e.hasPolygonOffset&&j;this._occluderPipelineTransparent=(0,F.sm)({blending:H.wu,polygonOffset:t,depthTest:L.zV,depthWrite:null,colorWrite:F.BK,stencilWrite:null,stencilTest:L.YD}),this._occluderPipelineOpaque=(0,F.sm)({blending:H.wu,polygonOffset:t,depthTest:L.zV,depthWrite:null,colorWrite:F.BK,stencilWrite:L.P7,stencilTest:L.ii}),this._occluderPipelineMaskWrite=(0,F.sm)({blending:null,polygonOffset:t,depthTest:L.JN,depthWrite:null,colorWrite:null,stencilWrite:L.s3,stencilTest:L.eD})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}},{key:"primitiveType",get:function(){return this.configuration.wireframe?k.MX.LINES:k.MX.TRIANGLE_STRIP}},{key:"getPipelineState",value:function(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===O.r.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===O.r.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:(0,E.Z)((0,D.Z)(n.prototype),"getPipelineState",this).call(this,e,t)}}]),n}(M.A);U.shader=new I.J(P.R,(function(){return n.e(6279).then(n.bind(n,56279))}));var V,j={factor:0,units:-4},W=n(737),B=s.Z.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(V||(V={}));var G=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e,new X))._vertexAttributeLocations=z,i.techniqueConfig=new W.G,i.layout=i.createLayout(),i}return(0,i.Z)(n,[{key:"isClosed",value:function(e,t){return K(this.parameters,e,t)}},{key:"getConfiguration",value:function(e,t){this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===O.r.DRAPED_MATERIAL;var n=(0,l.pC)(this.parameters.stipplePattern)&&e!==_.H.Highlight;return this.techniqueConfig.stippleEnabled=n,this.techniqueConfig.stippleOffColorEnabled=n&&(0,l.pC)(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=n&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=n&&this.parameters.stipplePreferContinuous,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.roundJoins="round"===this.parameters.join,this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.hasPolygonOffset=this.parameters.hasPolygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&(0,l.pC)(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===w.yD.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=t.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=t.multipassTerrain.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}},{key:"intersect",value:function(e,t,n,r,i,a,o,s,u){(0,l.pC)(u)?this._intersectDrapedLineGeometry(e,r,u,a,o):this._intersectLineGeometry(e,t,n,r,o)}},{key:"_intersectDrapedLineGeometry",value:function(e,t,n,r,i){if(t.options.selectionMode){var a=e.vertexAttributes.get(b.T.POSITION).data,o=e.vertexAttributes.get(b.T.SIZE),s=this.parameters.width;if(this.parameters.vvSizeEnabled){var l=e.vertexAttributes.get(b.T.SIZEFEATUREATTRIBUTE).data[0];s*=(0,u.uZ)(this.parameters.vvSizeOffset[0]+l*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o&&(s*=o.data[0]);for(var c=r[0],d=r[1],h=(s/2+4)*e.screenToWorldRatio,f=Number.MAX_VALUE,p=0,v=0;v<a.length-5;v+=3){var g=a[v],m=a[v+1],y=c-g,_=d-m,T=a[v+3]-g,x=a[v+4]-m,S=(0,u.uZ)((T*y+x*_)/(T*T+x*x),0,1),w=T*S-y,O=x*S-_,C=w*w+O*O;C<f&&(f=C,p=v/3)}f<h*h&&i(n.dist,n.normal,p,!1)}}},{key:"_intersectLineGeometry",value:function(e,t,n,r,i){if(r.options.selectionMode&&!(0,R.PD)(t))if((0,C.kG)(n)){var a=e.vertexAttributes,o=a.get(b.T.POSITION).data,s=this.parameters.width;if(this.parameters.vvSizeEnabled){var l=a.get(b.T.SIZEFEATUREATTRIBUTE).data[0];s*=(0,u.uZ)(this.parameters.vvSizeOffset[0]+l*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a.has(b.T.SIZE)&&(s*=a.get(b.T.SIZE).data[0]);var c=r.camera,f=re;(0,d.c)(f,r.point);var p=s*c.pixelRatio/2+4*c.pixelRatio;(0,h.s)(fe[0],f[0]-p,f[1]+p,0),(0,h.s)(fe[1],f[0]+p,f[1]+p,0),(0,h.s)(fe[2],f[0]+p,f[1]-p,0),(0,h.s)(fe[3],f[0]-p,f[1]-p,0);for(var y=0;y<4;y++)if(!c.unprojectFromRenderScreen(fe[y],pe[y]))return;(0,m.zk)(c.eye,pe[0],pe[1],ve),(0,m.zk)(c.eye,pe[1],pe[2],ge),(0,m.zk)(c.eye,pe[2],pe[3],me),(0,m.zk)(c.eye,pe[3],pe[0],ye);for(var _=Number.MAX_VALUE,T=0,x=Q(this.parameters,a,e.indices)?o.length-2:o.length-5,S=0;S<x;S+=3){$[0]=o[S]+n[12],$[1]=o[S+1]+n[13],$[2]=o[S+2]+n[14];var w=(S+3)%o.length;if(ee[0]=o[w]+n[12],ee[1]=o[w+1]+n[13],ee[2]=o[w+2]+n[14],!((0,m.jH)(ve,$)<0&&(0,m.jH)(ve,ee)<0||(0,m.jH)(ge,$)<0&&(0,m.jH)(ge,ee)<0||(0,m.jH)(me,$)<0&&(0,m.jH)(me,ee)<0||(0,m.jH)(ye,$)<0&&(0,m.jH)(ye,ee)<0)){if(c.projectToRenderScreen($,ie),c.projectToRenderScreen(ee,ae),ie[2]<0&&ae[2]>0){(0,h.b)(te,$,ee);var O=c.frustum,A=-(0,m.jH)(O[v.Nu.NEAR],$)/(0,h.e)(te,(0,m.mJ)(O[v.Nu.NEAR]));(0,h.g)(te,te,A),(0,h.a)($,$,te),c.projectToRenderScreen($,ie)}else if(ie[2]>0&&ae[2]<0){(0,h.b)(te,ee,$);var P=c.frustum,E=-(0,m.jH)(P[v.Nu.NEAR],ee)/(0,h.e)(te,(0,m.mJ)(P[v.Nu.NEAR]));(0,h.g)(te,te,E),(0,h.a)(ee,ee,te),c.projectToRenderScreen(ee,ae)}else if(ie[2]<0&&ae[2]<0)continue;ie[2]=0,ae[2]=0;var D=(0,g.Jk)((0,g.zk)(ie,ae,ue),f);D<_&&(_=D,(0,h.c)(oe,$),(0,h.c)(se,ee),T=S/3)}}var I=r.rayBegin,M=r.rayEnd;if(_<p*p){var Z=Number.MAX_VALUE;if((0,g.AR)((0,g.zk)(oe,se,ue),(0,g.zk)(I,M,le),ne)){(0,h.b)(ne,ne,I);var H=(0,h.l)(ne);(0,h.g)(ne,ne,1/H),Z=H/(0,h.i)(I,M)}i(Z,ne,T,!1)}}else B.error("intersection assumes a translation-only matrix")}},{key:"computeAttachmentOrigin",value:function(e,t){var n=e.vertexAttributes;if(!n)return null;var r=e.indices,i=n.get(b.T.POSITION);return(0,T.qZ)(i,r?r.get(b.T.POSITION):null,r&&Q(this.parameters,n,r),t)}},{key:"createLayout",value:function(){var e=(0,y.U$)().vec3f(b.T.POSITION).f32(b.T.SUBDIVISIONFACTOR).vec2f(b.T.UV0).vec3f(b.T.AUXPOS1).vec3f(b.T.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(b.T.SIZEFEATUREATTRIBUTE):e.f32(b.T.SIZE),this.parameters.vvColorEnabled?e.f32(b.T.COLORFEATUREATTRIBUTE):e.vec4f(b.T.COLOR),this.parameters.vvOpacityEnabled&&e.f32(b.T.OPACITYFEATUREATTRIBUTE),e}},{key:"createBufferWriter",value:function(){return new J(this.layout,this.parameters)}},{key:"requiresSlot",value:function(e,t){if(e===O.r.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===w.yD.OccludeAndTransparentStencil)return e===O.r.OPAQUE_MATERIAL||e===O.r.OCCLUDER_MATERIAL||e===O.r.TRANSPARENT_OCCLUDER_MATERIAL;var n=(0,S.S)(t);return n===_.H.Color||n===_.H.Alpha?e===(this.parameters.writeDepth?O.r.TRANSPARENT_MATERIAL:O.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===O.r.OPAQUE_MATERIAL}},{key:"createGLMaterial",value:function(e){return e.output===_.H.Color||e.output===_.H.Alpha||e.output===_.H.Highlight||e.output===_.H.Depth?new q(e):null}},{key:"validateParameters",value:function(e){"miter"!==e.join&&(e.miterLimit=0)}}]),n}(w.F5),q=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return(0,i.Z)(n,[{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}},{key:"beginSlot",value:function(e){return this._output!==_.H.Color&&this._output!==_.H.Alpha||this._updateOccludeeState(e),this.ensureTechnique(U,e)}}]),n}(x.Z),X=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).width=0,e.color=p.O,e.join="miter",e.cap=W.R.BUTT,e.miterLimit=5,e.writeDepth=!0,e.hasPolygonOffset=!1,e.stippleScaleWithLineWidth=!1,e.stipplePreferContinuous=!0,e.hasSlicePlane=!1,e.vvFastUpdate=!1,e.isClosed=!1,e.falloff=0,e.innerWidth=0,e.hasOccludees=!1,e.wireframe=!1,e}return(0,i.Z)(n)}(A.n),J=function(){function e(t,n){(0,r.Z)(this,e),this.parameters=n,this.numJoinSubdivisions=0,this.vertexBufferLayout=t;var i=n.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=P.N+i}}return(0,i.Z)(e,[{key:"_isClosed",value:function(e){return Q(this.parameters,e.vertexAttributes,e.indices)}},{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){var t=e.indices.get(b.T.POSITION).length/2+1,n=this._isClosed(e),r=n?2:4;return r+=((n?t:t-1)-(n?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this.parameters.wireframe&&(r=2+4*(r-2)),r}},{key:"write",value:function(e,t,n,r){var i,a=this,o=ce,s=de,u=he,l=t.vertexAttributes.get(b.T.POSITION).data,c=t.indices&&t.indices.get(b.T.POSITION),d=null===(i=t.vertexAttributes.get(b.T.DISTANCETOSTART))||void 0===i?void 0:i.data;c&&c.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var f=1,p=0;this.parameters.vvSizeEnabled?p=t.vertexAttributes.get(b.T.SIZEFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(b.T.SIZE)&&(f=t.vertexAttributes.get(b.T.SIZE).data[0]);var v=[1,1,1,1],g=0;this.parameters.vvColorEnabled?g=t.vertexAttributes.get(b.T.COLORFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(b.T.COLOR)&&(v=t.vertexAttributes.get(b.T.COLOR).data);var m=0;this.parameters.vvOpacityEnabled&&(m=t.vertexAttributes.get(b.T.OPACITYFEATUREATTRIBUTE).data[0]);var y=l.length/3,_=e.transformation,T=new Float32Array(n.buffer),x=this.vertexBufferLayout.stride/4,S=r*x,w=S,O=0,C=d?function(e,t,n){return O=d[n]}:function(e,t,n){return O+=(0,h.i)(e,t)},A=function(e,t,n,r,i,o,s){if(T[S++]=t[0],T[S++]=t[1],T[S++]=t[2],T[S++]=r,T[S++]=s,T[S++]=i,T[S++]=e[0],T[S++]=e[1],T[S++]=e[2],T[S++]=n[0],T[S++]=n[1],T[S++]=n[2],a.parameters.vvSizeEnabled?T[S++]=p:T[S++]=f,a.parameters.vvColorEnabled)T[S++]=g;else{var u=Math.min(4*o,v.length-4);T[S++]=v[u+0],T[S++]=v[u+1],T[S++]=v[u+2],T[S++]=v[u+3]}a.parameters.vvOpacityEnabled&&(T[S++]=m)};S+=x,(0,h.s)(s,l[0],l[1],l[2]),_&&(0,h.m)(s,s,_);var R=this._isClosed(t);if(R){var P=l.length-3;(0,h.s)(o,l[P],l[P+1],l[P+2]),_&&(0,h.m)(o,o,_)}else(0,h.s)(u,l[3],l[4],l[5]),_&&(0,h.m)(u,u,_),A(s,s,u,1,V.LEFT_CAP_START,0,0),A(s,s,u,1,V.RIGHT_CAP_START,0,0),(0,h.c)(o,s),(0,h.c)(s,u);for(var E=R?0:1,D=R?y:y-1,I=E;I<D;I++){var M=(I+1)%y*3;(0,h.s)(u,l[M+0],l[M+1],l[M+2]),_&&(0,h.m)(u,u,_),C(o,s,I),A(o,s,u,0,V.LEFT_JOIN_END,I,O),A(o,s,u,0,V.RIGHT_JOIN_END,I,O);for(var Z=this.numJoinSubdivisions,H=0;H<Z;++H){var N=(H+1)/(Z+1);A(o,s,u,N,V.LEFT_JOIN_END,I,O),A(o,s,u,N,V.RIGHT_JOIN_END,I,O)}A(o,s,u,1,V.LEFT_JOIN_START,I,O),A(o,s,u,1,V.RIGHT_JOIN_START,I,O),(0,h.c)(o,s),(0,h.c)(s,u)}R?((0,h.s)(u,l[3],l[4],l[5]),_&&(0,h.m)(u,u,_),O=C(o,s,D),A(o,s,u,0,V.LEFT_JOIN_END,E,O),A(o,s,u,0,V.RIGHT_JOIN_END,E,O)):(O=C(o,s,D),A(o,s,s,0,V.LEFT_CAP_END,D,O),A(o,s,s,0,V.RIGHT_CAP_END,D,O)),Y(T,w+x,T,w,x),S=Y(T,S-x,T,S,x),this.parameters.wireframe&&this._addWireframeVertices(n,w,S,x)}},{key:"_addWireframeVertices",value:function(e,t,n,r){for(var i=new Float32Array(e.buffer,n*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,n-t),o=0,s=function(e){return o=Y(a,e,i,o,r)},u=0;u<a.length-1;u+=2*r)s(u),s(u+2*r),s(u+1*r),s(u+2*r),s(u+1*r),s(u+3*r)}}]),e}();function Y(e,t,n,r,i){for(var a=0;a<i;a++)n[r++]=e[t++];return r}function Q(e,t,n){return K(e,t.get(b.T.POSITION).data,n?n.get(b.T.POSITION):null)}function K(e,t,n){return!!e.isClosed&&(n?n.length>2:t.length>6)}var $=(0,f.c)(),ee=(0,f.c)(),te=(0,f.c)(),ne=(0,f.c)(),re=(0,f.c)(),ie=(0,c.J$)(),ae=(0,c.J$)(),oe=(0,f.c)(),se=(0,f.c)(),ue=(0,g.Ue)(),le=(0,g.Ue)(),ce=(0,f.c)(),de=(0,f.c)(),he=(0,f.c)(),fe=[(0,c.J$)(),(0,c.J$)(),(0,c.J$)(),(0,c.J$)()],pe=[(0,f.c)(),(0,f.c)(),(0,f.c)(),(0,f.c)()],ve=(0,m.Ue)(),ge=(0,m.Ue)(),me=(0,m.Ue)(),ye=(0,m.Ue)()},47475:function(e,t,n){n.d(t,{H:function(){return N},m:function(){return L}});var r=n(15671),i=n(43144),a=n(60136),o=n(54062),s=n(38499),u=n(6394),l=n(67077),c=n(71011),d=n(92026),h=function(){function e(){(0,r.Z)(this,e),this.enabled=!0,this._time=0}return(0,i.Z)(e,[{key:"time",get:function(){return(0,s.HA)(this._time)}},{key:"advance",value:function(e){return(0,d.pC)(e.forcedTime)?this._time!==e.forcedTime&&(this._time=e.forcedTime,!0):!(!this.enabled||0===e.dt)&&(this._time+=e.dt,!0)}}]),e}(),f=n(94425),p=n(56529),v=n(78041),g=n(93822),m=n(68401),y=n(23620),_=n(27366),T=n(50951),x=n(41481),S=n(27254),w=n(82144),O=n(31132),C=n(33559),b=n(7566),A=n(27627),R=n(8883),P=n(49810),E=n(36207),D=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,i,a){var o;return(0,r.Z)(this,n),(o=t.call(this,e,i,a))._textureRepository=e.waterTextureRepository,o}return(0,i.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.spherical=e.viewingMode===T.JY.Global,t.doublePrecisionRequiresObfuscation=(0,S.I)(e.rctx)}},{key:"initializeProgram",value:function(e){var t=n.shader.get().build(this.configuration);return new A.$(e.rctx,t,b.i)}},{key:"bindPass",value:function(e,t){this.program.bindPass(e,t),this.configuration.output!==c.H.Color&&this.configuration.output!==c.H.Normal||this._textureRepository.bind(this.program)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,n=e===m.Am.NONE,r=e===m.Am.FrontFace;return(0,E.sm)({blending:t.output!==c.H.Normal&&t.output!==c.H.Highlight&&t.transparent?n?v.wu:(0,v.j7)(e):null,depthTest:{func:(0,v.Bh)(e)},depthWrite:n?t.writeDepth&&E.LZ:(0,v.K5)(e),colorWrite:E.BK,polygonOffset:n||r?null:(0,v.je)(t.enableOffset)})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}}]),n}(O.A);D.shader=new w.J(P.W,(function(){return n.e(9106).then(n.bind(n,19106))}));var I=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).output=c.H.Color,e.transparencyPassType=m.Am.NONE,e.spherical=!1,e.receiveShadows=!1,e.hasSlicePlane=!1,e.transparent=!1,e.enableOffset=!0,e.writeDepth=!1,e.hasScreenSpaceReflections=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasCloudsReflections=!1,e.isDraped=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e}return(0,i.Z)(n)}(R.W);(0,_._)([(0,C.o)({count:c.H.COUNT})],I.prototype,"output",void 0),(0,_._)([(0,C.o)({count:m.Am.COUNT})],I.prototype,"transparencyPassType",void 0),(0,_._)([(0,C.o)()],I.prototype,"spherical",void 0),(0,_._)([(0,C.o)()],I.prototype,"receiveShadows",void 0),(0,_._)([(0,C.o)()],I.prototype,"hasSlicePlane",void 0),(0,_._)([(0,C.o)()],I.prototype,"transparent",void 0),(0,_._)([(0,C.o)()],I.prototype,"enableOffset",void 0),(0,_._)([(0,C.o)()],I.prototype,"writeDepth",void 0),(0,_._)([(0,C.o)()],I.prototype,"hasScreenSpaceReflections",void 0),(0,_._)([(0,C.o)()],I.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,_._)([(0,C.o)()],I.prototype,"hasCloudsReflections",void 0),(0,_._)([(0,C.o)()],I.prototype,"isDraped",void 0),(0,_._)([(0,C.o)()],I.prototype,"hasMultipassTerrain",void 0),(0,_._)([(0,C.o)()],I.prototype,"cullAboveGround",void 0),(0,_._)([(0,C.o)({constValue:x.f7.Water})],I.prototype,"pbrMode",void 0),(0,_._)([(0,C.o)({constValue:!0})],I.prototype,"useCustomDTRExponentForWater",void 0),(0,_._)([(0,C.o)({constValue:!0})],I.prototype,"highStepCount",void 0),(0,_._)([(0,C.o)({constValue:!1})],I.prototype,"useFillLights",void 0);var M=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return(0,i.Z)(n,[{key:"_updateShadowState",value:function(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}},{key:"_updateSSRState",value:function(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}},{key:"_updateCloudsReflectionState",value:function(e){var t=(0,d.pC)(e.clouds.data);t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}},{key:"ensureResources",value:function(e){var t=this._techniqueRepository.constructionContext.waterTextureRepository;return t.resourceState===m.Rw.NOT_LOADED&&t.loadTextures(e),t.resourceState}},{key:"beginSlot",value:function(e){return this._output===c.H.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this.ensureTechnique(D,e)}}]),n}(y.Z),Z=n(64226),H=n(22909),N=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e,new L))._techniqueConfig=new I,i.animation=new h,i}return(0,i.Z)(n,[{key:"getConfiguration",value:function(e,t){return this._techniqueConfig.output=e,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._techniqueConfig.hasCloudsReflections=this.parameters.hasCloudsReflections,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=t.transparencyPassType,this._techniqueConfig.enableOffset=t.camera.relativeElevation<v.ve,this._techniqueConfig.hasMultipassTerrain=t.multipassTerrain.enabled,this._techniqueConfig.cullAboveGround=t.multipassTerrain.cullAboveGround,this._techniqueConfig}},{key:"update",value:function(e){var t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<k;var n=this.animation.advance(e);return this.setParameters({timeElapsed:(0,s.D9)(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&n}},{key:"intersect",value:function(e,t,n,r,i,a,o){(0,H.Bw)(e,t,r,i,a,void 0,o)}},{key:"requiresSlot",value:function(e,t){switch((0,f.S)(t)){case c.H.Normal:return e===g.r.DRAPED_WATER;case c.H.Color:if(this.parameters.isDraped)return e===g.r.DRAPED_MATERIAL;break;case c.H.Highlight:return e===g.r.OPAQUE_MATERIAL||e===g.r.DRAPED_MATERIAL}var n=g.r.OPAQUE_MATERIAL;return this.parameters.transparent&&(n=this.parameters.writeDepth?g.r.TRANSPARENT_MATERIAL:g.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===n}},{key:"createGLMaterial",value:function(e){if(e.output===c.H.Color&&this.parameters.isDraped)return e.output=c.H.Draped,new M(e);switch(e.output){case c.H.Color:case c.H.Normal:case c.H.Highlight:case c.H.Alpha:return new M(e)}return null}},{key:"createBufferWriter",value:function(){return new Z.G_(Z.W1)}}]),n}(p.F5),L=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).waveStrength=.06,e.waveTextureRepeat=32,e.waveDirection=(0,u.f)(1,0),e.waveVelocity=.05,e.flowStrength=.015,e.flowOffset=-.5,e.animationSpeed=.35,e.timeElapsed=0,e.color=(0,l.f)(0,0,0,0),e.transparent=!0,e.writeDepth=!0,e.hasSlicePlane=!1,e.isDraped=!1,e.receiveShadows=!0,e.hasScreenSpaceReflections=!1,e.hasCloudsReflections=!1,e}return(0,i.Z)(n)}(p.Mt),k=35e3},64226:function(e,t,n){n.d(t,{G_:function(){return d},IM:function(){return c},W1:function(){return l},wp:function(){return u}});var r=n(15671),i=n(43144),a=n(55158),o=n(4760),s=n(33236),u=(0,a.U$)().vec3f(o.T.POSITION),l=(0,a.U$)().vec3f(o.T.POSITION).vec2f(o.T.UV0),c=(0,a.U$)().vec3f(o.T.POSITION).vec4u8(o.T.COLOR),d=function(){function e(t){(0,r.Z)(this,e),this.vertexBufferLayout=t}return(0,i.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(o.T.POSITION).length}},{key:"write",value:function(e,t,n,r){(0,s.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,n,r)}}]),e}()},86700:function(e,t,n){n.d(t,{Dp:function(){return u},z5:function(){return s}});var r=n(93433),i=n(92026),a={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},o={dash:a.dash,"dash-dot":[].concat((0,r.Z)(a.dash),(0,r.Z)(a.dot)),dot:a.dot,"long-dash":a["long-dash"],"long-dash-dot":[].concat((0,r.Z)(a["long-dash"]),(0,r.Z)(a.dot)),"long-dash-dot-dot":[].concat((0,r.Z)(a["long-dash"]),(0,r.Z)(a.dot),(0,r.Z)(a.dot)),none:null,"short-dash":a["short-dash"],"short-dash-dot":[].concat((0,r.Z)(a["short-dash"]),(0,r.Z)(a["short-dot"])),"short-dash-dot-dot":[].concat((0,r.Z)(a["short-dash"]),(0,r.Z)(a["short-dot"]),(0,r.Z)(a["short-dot"])),"short-dot":a["short-dot"],solid:null};function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return{pattern:[e,e],pixelRatio:t}}function u(e){return(0,i.pC)(e)&&"style"===e.type?function(e){return(0,i.pC)(e)?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return(0,i.Wi)(e)?e:{pattern:e.slice(),pixelRatio:t}}(o[e],8):null}(e.style):null}},737:function(e,t,n){n.d(t,{G:function(){return f},R:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(54062),u=n(27366),l=n(71011),c=n(33559),d=n(68401),h=n(8883);!function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"}(r||(r={}));var f=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).output=l.H.Color,e.capType=r.BUTT,e.transparencyPassType=d.Am.NONE,e.occluder=!1,e.hasSlicePlane=!1,e.hasPolygonOffset=!1,e.writeDepth=!1,e.draped=!1,e.stippleEnabled=!1,e.stippleOffColorEnabled=!1,e.stippleScaleWithLineWidth=!1,e.stipplePreferContinuous=!0,e.roundJoins=!1,e.vvSize=!1,e.vvColor=!1,e.vvOpacity=!1,e.falloffEnabled=!1,e.innerColorEnabled=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.wireframe=!1,e}return(0,i.Z)(n)}(h.W);(0,u._)([(0,c.o)({count:l.H.COUNT})],f.prototype,"output",void 0),(0,u._)([(0,c.o)({count:r.COUNT})],f.prototype,"capType",void 0),(0,u._)([(0,c.o)({count:d.Am.COUNT})],f.prototype,"transparencyPassType",void 0),(0,u._)([(0,c.o)()],f.prototype,"occluder",void 0),(0,u._)([(0,c.o)()],f.prototype,"hasSlicePlane",void 0),(0,u._)([(0,c.o)()],f.prototype,"hasPolygonOffset",void 0),(0,u._)([(0,c.o)()],f.prototype,"writeDepth",void 0),(0,u._)([(0,c.o)()],f.prototype,"draped",void 0),(0,u._)([(0,c.o)()],f.prototype,"stippleEnabled",void 0),(0,u._)([(0,c.o)()],f.prototype,"stippleOffColorEnabled",void 0),(0,u._)([(0,c.o)()],f.prototype,"stippleScaleWithLineWidth",void 0),(0,u._)([(0,c.o)()],f.prototype,"stipplePreferContinuous",void 0),(0,u._)([(0,c.o)()],f.prototype,"roundJoins",void 0),(0,u._)([(0,c.o)()],f.prototype,"vvSize",void 0),(0,u._)([(0,c.o)()],f.prototype,"vvColor",void 0),(0,u._)([(0,c.o)()],f.prototype,"vvOpacity",void 0),(0,u._)([(0,c.o)()],f.prototype,"falloffEnabled",void 0),(0,u._)([(0,c.o)()],f.prototype,"innerColorEnabled",void 0),(0,u._)([(0,c.o)()],f.prototype,"hasOccludees",void 0),(0,u._)([(0,c.o)()],f.prototype,"hasMultipassTerrain",void 0),(0,u._)([(0,c.o)()],f.prototype,"cullAboveGround",void 0),(0,u._)([(0,c.o)()],f.prototype,"wireframe",void 0),(0,u._)([(0,c.o)({constValue:!0})],f.prototype,"stippleRequiresClamp",void 0),(0,u._)([(0,c.o)({constValue:!0})],f.prototype,"stippleRequiresStretchMeasure",void 0),(0,u._)([(0,c.o)({constValue:!0})],f.prototype,"hasVvInstancing",void 0),(0,u._)([(0,c.o)({constValue:!0})],f.prototype,"hasSliceTranslatedView",void 0)}}]);
//# sourceMappingURL=1194.4dc0213b.chunk.js.map